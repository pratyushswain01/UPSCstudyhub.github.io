<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPSChub - Exam Portal</title>
  <link rel="icon" type="images\jpg" href="images\LOGO.jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* General Styles & Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Poppins', sans-serif; background: #f0f0f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; position: relative; }
    .dark { background: #1e1e2f; color: #eee; }

    /* Full-Page Watermark - Activated During Exam */
    body.exam-active::after {
        content: "UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A";
        position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
        font-size: 7vw; font-weight: 700; color: rgba(0, 0, 0, 0.04); text-align: center;
        line-height: 2.2; transform-origin: center; transform: rotate(-30deg);
        z-index: 1; pointer-events: none; white-space: pre;
    }
    .dark.exam-active::after { color: rgba(255, 255, 255, 0.04); }

    /* STAGE 1 & 2: Login & Instructions Screens */
    .pre-exam-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; z-index: 5000; position: relative; background: #f0f0f5;}
    .dark .pre-exam-screen { background: #1e1e2f; }

    .login-card, .instructions-container {
        background: #ffffff; padding: 30px 40px; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 100%; text-align: center;
    }
    .dark .login-card, .dark .instructions-container { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }

    #loginScreen .login-card { max-width: 450px; }
    .login-card h2 { margin-bottom: 25px; color: #3f51b5; font-size: 1.8em; }
    .dark .login-card h2 { color: #8ab4f8; }
    .input-group { margin-bottom: 20px; text-align: left; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
    .dark .input-group input { background: #1e1e2f; border-color: #555; color: #eee; }
    .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #3f51b5; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .btn-primary:hover:not(:disabled) { opacity: 0.9; }
    #loginError { color: #f44336; height: 1.2em; margin-top: 15px; font-weight: 500; }

    #instructionsScreen { display: none; }
    #instructionsScreen .instructions-container { max-width: 800px; text-align: left; height: 90vh; display: flex; flex-direction: column; }
    #instructionsScreen h2 { color: #3f51b5; border-bottom: 2px solid #3f51b5; padding-bottom: 5px; margin-bottom: 15px; margin-top: 25px; }
    #instructionsScreen h2:first-of-type { margin-top: 0; }
    .dark #instructionsScreen h2 { color: #8ab4f8; border-bottom-color: #8ab4f8; }
    .instructions-content { flex-grow: 1; overflow-y: auto; padding-right: 15px; }
    .instructions-content ul { list-style: none; padding-left: 0; line-height: 1.8; }
    .instructions-content li { display: flex; align-items: flex-start; margin-bottom: 12px; }
    .instructions-content li i { color: #3f51b5; margin-right: 15px; font-size: 1.2em; margin-top: 5px; min-width: 20px; text-align: center; }
    .dark .instructions-content li i { color: #8ab4f8; }
    .instructions-content strong { color: #c62828; }
    .dark .instructions-content strong { color: #ef9a9a; }
    .instructions-footer { padding-top: 20px; border-top: 1px solid #eee; }
    .dark .instructions-footer { border-top-color: #444; }
    #offlineStatus { font-weight: 600; text-align: center; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
    .status-waiting { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .status-ready { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .agreement-group { display: flex; align-items: center; margin-bottom: 15px; }
    #agreementCheckbox { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
    #agreementCheckbox + label { font-size: 0.9em; cursor: pointer; }
    .btn-start-exam:disabled { background: #9fa8da; cursor: not-allowed; }
    .dark .btn-start-exam:disabled { background: #2c3a7a; }
    #startError { color: #d32f2f; text-align: center; height: 1.2em; font-weight: 500; }

    /* STAGE 3: EXAM UI STYLES */
    #examUIWrapper { display: none; flex-direction: column; height: 100%; position: relative; }
    .site-header { background: #ffffff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 101; position: relative; }
    .site-logo { height: 40px; width: auto; }
    .site-branding .site-title { font-size: 1.4em; font-weight: 700; color: #3f51b5; line-height: 1.1; }
    .site-branding .site-tagline { font-size: 0.8em; color: #666; margin: 0; }
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px; background: #3f51b5; color: white; gap: 10px; z-index: 100; position: relative; }
    .topbar-left-group, .topbar-right-group { display: flex; align-items: center; gap: 15px; }
    .navigation-tabs { display: flex; gap: 5px; background: rgba(0,0,0,0.15); border-radius: 6px; padding: 3px; position: absolute; left: 50%; transform: translateX(-50%); }
    .nav-tab { background: transparent; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.85em; }
    .nav-tab:hover:not(.locked) { background: rgba(255,255,255,0.2); }
    .nav-tab.active { background: white; color: #3f51b5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .nav-tab.locked { cursor: not-allowed; opacity: 0.6; position: relative; pointer-events: none; }
    .nav-tab.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-left: 8px; font-size: 0.9em; }
    .timer { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
    #stopwatchWrapper { display: none; align-items: center; gap: 10px; }
    #stopwatchDisplay { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
    .stopwatch-controls button { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; font-size: 0.8em; padding: 5px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; margin-left: 5px; }
    .stopwatch-controls button:hover { background-color: rgba(255,255,255,0.2); }
    .dark-mode-toggle { display: flex; align-items: center; gap: 8px; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #4caf50; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    .toggle-label { font-size: 0.9em; white-space: nowrap; }
    .topbar #btnSubmitTest { background: #f44336; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; padding: 8px 15px; }
    .topbar #btnSubmitTest:hover { opacity: 0.85; }
    .main-content { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 5; }
    .question-area { width: 100%; padding: 20px; overflow-y: auto; padding-bottom: 100px; transition: padding-right 0.3s ease, filter 0.3s ease; position: relative; z-index: 5; }
    .sidebar-open .question-area { filter: blur(4px); pointer-events: none; }
    .question-header { font-size: 1.2em; margin-bottom: 15px; font-weight: 600; }
    .question-timer-bar-container { width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
    .question-timer-bar { height: 100%; width: 100%; background-color: #3f51b5; border-radius: 4px; }
    .dark .question-timer-bar-container { background-color: #3d3d4a; }
    .dark .question-timer-bar { background-color: #8ab4f8; }
    .question-content { margin-bottom: 20px; line-height: 1.6; font-size: 1em; }
    .options-list { list-style: none; display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0; }
    .option { padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.95em; position: relative; }
    .option:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .option.selected { background: #4caf50; color: white; border-color: #4caf50; box-shadow: 0 2px 5px rgba(76,175,80,0.3); }
    .option-radio { margin-right: 12px; min-width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; display: inline-block; position: relative; }
    .option.selected .option-radio { border-color: white; background: white; box-shadow: inset 0 0 0 4px #4caf50; }
    
    .sidebar { position: fixed; top: 111px; /* This will be set by JS */ right: -300px; width: 300px; height: calc(100% - 111px); /* This will be set by JS */ background: #f8f9fa; border-left: 1px solid #ccc; display: flex; flex-direction: column; transition: right 0.3s ease-in-out; z-index: 200; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
    .sidebar-open .sidebar { right: 0; }
    .sidebar-content { padding: 15px; overflow-y: auto; flex-grow: 1;}
    .palette-title { font-weight: 600; margin-bottom: 10px; color: #3f51b5; font-size: 1.1em; text-align: center; }
    .question-palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px; margin-bottom: 20px; }
    .question-number { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid transparent; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 13px; margin: 0 auto; }
    .question-number:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .answered { background: #4caf50; color: white; border: 1px solid #388e3c;}
    .not-answered { background: #f44336; color: white; border: 1px solid #d32f2f;}
    .marked { background: #ff9800; color: white; border: 1px solid #f57c00;}
    .marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); color: white; border: 1px solid #f57c00; }
    .not-visited { background: #e9ecef; color: #333; border: 1px solid #ddd;}
    .current { border: 2px solid #3f51b5; transform: scale(1.1); }
    .palette-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; padding: 12px; background: #e0e0e0; border-radius: 6px; font-size: 0.8em; }
    .summary-item { display: flex; align-items: center; gap: 8px; color: #333; }
    .summary-item span { font-weight: 700; background-color: #fff; border-radius: 50%; min-width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .legend { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;}
    .legend-title { font-weight: 600; margin-bottom: 12px; color: #3f51b5; font-size: 1em; }
    .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85em; padding: 6px 8px; border-radius: 4px; }
    .legend-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 10px; flex-shrink: 0; }
    .legend-answered { background: #4caf50; }
    .legend-not-answered { background: #f44336; }
    .legend-marked { background: #ff9800; }
    .legend-marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); }
    .legend-not-visited { background: #e9ecef; border: 1px solid #ccc; }
    
    .sidebar-toggle { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; font-size: 0.9em; padding: 5px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
    .sidebar-toggle:hover { background-color: rgba(255,255,255,0.2); }
    .sidebar-open .sidebar-toggle { transform: rotate(180deg); }

    .fixed-action-area { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ccc; padding: 10px 15px; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn-action { padding: 8px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85em; flex-grow: 1; flex-basis: 0; }
    .btn-action:hover { opacity: 0.85; }
    #btnPrevQuestion { background: #6c757d; color: white; }
    #btnSaveNext { background: #4caf50; color: white; }
    #btnMarkReview { background: #ff9800; color: white; }
    #btnClearResponse { background: #f44336; color: white; }
    .submit-button.btn-action { background: #3f51b5; color: white; padding: 10px 25px; flex-grow: 0; }
    
    /* Result Screen & Animated Scorecard Styles */
    #resultScreenWrapper { display: none; text-align: center; padding: 20px; flex-direction: column; align-items: center; justify-content: flex-start; flex: 1; overflow-y: auto; position: relative;}
    #resultScreenWrapper h2 { font-size: 2.5em; color: #3f51b5; margin-bottom: 5px; }
    #resultScreenWrapper p { font-size: 1.2em; margin-bottom: 20px; }
    .scorecard-details { width: 100%; max-width: 500px; margin: 25px auto; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .scorecard-table { width: 100%; border-collapse: collapse; font-size: 1.1em; }
    .scorecard-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
    .scorecard-table tr:last-child td { border-bottom: none; }
    .scorecard-table td:first-child { text-align: left; font-weight: 500; color: #555; }
    .scorecard-table td:last-child { text-align: right; font-weight: 700; }
    .scorecard-table .correct-val { color: #4caf50; }
    .scorecard-table .incorrect-val { color: #f44336; }
    .scorecard-table .unattempted-val { color: #ff9800; }
    .scorecard-table .total-row td { font-size: 1.2em; border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 5px; }
    .scorecard-table .total-val { color: #3f51b5; }
    .dark .scorecard-details { background: #2a2a3a; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .dark .scorecard-table td { border-bottom-color: #3a3a4a; }
    .dark .scorecard-table td:first-child { color: #ccc; }
    .dark .scorecard-table .correct-val { color: #81c784; }
    .dark .scorecard-table .incorrect-val { color: #ef9a9a; }
    .dark .scorecard-table .unattempted-val { color: #ffd54f; }
    .dark .scorecard-table .total-row td { border-top-color: #555; }
    .dark .scorecard-table .total-val { color: #8ab4f8; }

    #finalScore { display: none; }
    .result-buttons { display: flex; gap: 15px; margin-top: 30px; margin-bottom: 30px; }
    .performance-analysis-container { width: 100%; max-width: 800px; margin: 30px auto; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .chart-container { width: 100%; max-width: 800px; margin: 30px auto; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .performance-analysis-container h3 { text-align: center; margin-bottom: 20px; font-size: 1.5em; color: #3f51b5; }
    .table-wrapper { overflow-x: auto; }
    .performance-table { width: 100%; border-collapse: collapse; }
    .performance-table th, .performance-table td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; white-space: nowrap; }
    .performance-table th { background-color: #f8f9fa; font-weight: 600; color: #444; }
    .performance-table td:first-child { text-align: left; font-weight: 500; width: 40%; white-space: normal; }
    .accuracy-bar-container { background-color: #e9ecef; border-radius: 10px; position: relative; height: 22px; overflow: hidden; min-width: 100px; }
    .accuracy-bar { height: 100%; border-radius: 10px; transition: width 0.8s ease-in-out; }
    .accuracy-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 600; font-size: 0.9em; color: #333; text-shadow: 0 0 2px rgba(255,255,255,0.7); }
    #performanceChart { width: 100% !important; height: 350px !important; }
    
    /* Review Screen & Explanation Styles */
    #reviewScreenWrapper { display: none; width: 100%; flex-direction: column; position: relative;}
    .review-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
    #reviewContainer { padding: 20px; overflow-y: auto; flex-grow: 1; background-color: #f0f0f5; }
    .review-question { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .review-option-list { list-style: none; padding: 0; margin-top: 15px; }
    .review-option { padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; }
    .review-option i { min-width: 1.2em; text-align: center; }
    .review-option.review-correct { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; font-weight: 500; }
    .review-option.review-incorrect { background-color: #ffebee; border-color: #ef9a9a; color: #b71c1c; }
    .review-status { margin-top: 15px; padding: 8px 12px; border-radius: 6px; font-weight: 500; text-align: center; border: 1px solid transparent; }
    .review-status.correct { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; }
    .review-status.incorrect { background-color: #ffebee; border-color: #ef9a9a; color: #c62828; }
    .review-status.unanswered { background-color: #fff3e0; border-color: #ffcc80; color: #e65100; }
    .review-explanation { margin-top: 20px; padding: 15px; background: #eef2ff; border-left: 4px solid #3f51b5; border-radius: 4px; font-size: 0.9em; line-height: 1.6; }
    .review-explanation strong { color: #3f51b5; }

    .password-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;}
    .modal-content { background-color: #fefefe; padding: 25px 35px; border: 1px solid #888; width: 90%; max-width: 420px; border-radius: 12px; text-align: center; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .close-modal { position: absolute; top: 10px; right: 20px; font-size: 1.8em; color: #aaa; cursor: pointer; transition: color 0.2s; }
    .close-modal:hover { color: #333; }
    #passwordRetestInput { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    #passwordError { color: #f44336; font-size: 0.9em; height: 1.2em; margin-bottom: 10px;}
    .contact-admin-text { margin-top: 20px; font-size: 0.9em; color: #666; }
    .contact-admin-text a { color: #3f51b5; text-decoration: none; font-weight: 500; }
    .contact-admin-text a:hover { text-decoration: underline; }
    
    #answerWritingWrapper { display: none; flex: 1; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; position: relative;}
    #answerWritingWrapper h2 { color: #3f51b5; font-size: 1.8em; margin-bottom: 10px; }
    #answerWritingWrapper p { color: #555; font-size: 1.1em; }

    /* Dark Mode Overrides */
    .dark .site-header { background: #2a2a3a; border-bottom-color: #3a3a4a; }
    .dark .site-branding .site-title { color: #8ab4f8; }
    .dark .site-branding .site-tagline { color: #aaa; }
    .dark .option { background: #2c2c3c; border-color: #444; color: #eee; }
    .dark .option:hover { background: #3d3d4a; }
    .dark .option.selected { background: #1b5e20; color: #c8e6c9; border-color: #81c784; }
    .dark .option.selected .option-radio { border-color: #c8e6c9; background: #c8e6c9; box-shadow: inset 0 0 0 4px #1b5e20; }
    .dark .option-radio { border-color: #555; }
    .dark .fixed-action-area { background: #1e1e2f; border-top-color: #444;}
    .dark .sidebar { background: #2a2a3a; border-left: 1px solid #444;}
    .dark .not-visited { background: #3d3d4a; color: #eee; border: 1px solid #555; }
    .dark .palette-summary { background: #1e1e2f; border: 1px solid #444;}
    .dark .summary-item { color: #ccc; }
    .dark .summary-item span { background-color: #3d3d4a; color: #eee; }
    .dark .legend, .dark .fixed-action-area { border-top-color: #444; }
    .dark .legend-item { background: rgba(255,255,255,0.05); }
    .dark .palette-title, .dark .legend-title { color: #8ab4f8; }
    .dark #resultScreenWrapper h2, .dark .performance-analysis-container h3, .dark .review-title, .dark #answerWritingWrapper h2 { color: #8ab4f8; }
    .dark #answerWritingWrapper p { color: #aaa; }
    .dark .performance-analysis-container, .dark .chart-container { background: #2a2a3a; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .dark .performance-table th { background-color: #1e1e2f; color: #ccc; }
    .dark .performance-table td { border-bottom: 1px solid #444; }
    .dark .accuracy-bar-container { background-color: #3d3d4a; }
    .dark .accuracy-text { color: #fff; text-shadow: none; }
    .dark .review-header { background: #2a2a3a; border-color: #444; }
    .dark #reviewContainer { background-color: #1e1e2f; }
    .dark .review-question { background: #2c2c3c; border-color: #444; }
    .dark .review-option { border-color: #555; }
    .dark .review-option.review-correct { background-color: #1a311b; border-color: #81c784; color: #c8e6c9; }
    .dark .review-option.review-incorrect { background-color: #3e1c1f; border-color: #ef9a9a; color: #ffcdd2; }
    .dark .review-status.correct { background-color: #1a311b; border-color: #4caf50; color: #c8e6c9; }
    .dark .review-status.incorrect { background-color: #3e1c1f; border-color: #f44336; color: #ffcdd2; }
    .dark .review-status.unanswered { background-color: #4a2c0f; border-color: #ff9800; color: #ffe0b2; }
    .dark .review-explanation { background: #262a42; border-left-color: #8ab4f8; color: #ccc; }
    .dark .review-explanation strong { color: #8ab4f8; }
    .dark .modal-content { background: #2c2c3c; border-color: #555; }
    .dark .close-modal:hover { color: #fff; }
    .dark .contact-admin-text { color: #aaa; }
    .dark .contact-admin-text a { color: #8ab4f8; }

    @media (max-width: 768px) {
        .site-header { flex-direction: column; text-align: center; gap: 5px; }
        .topbar { flex-wrap: wrap; justify-content: center; }
        .navigation-tabs { position: static; transform: none; order: 3; width: 100%; justify-content: center; margin-top: 10px; }
        .sidebar-open .question-area { padding-right: 20px; }
    }
    @media (max-width: 480px) {
        .btn-action span { display: none; }
        .btn-action .fas { font-size: 1.1em; margin: 0 5px; }
    }
  </style>
</head>
<body>

  <!-- STAGE 1: LOGIN SCREEN (Visible by default) -->
  <div id="loginScreen" class="pre-exam-screen" style="display: flex;">
    <div class="login-card">
        <h2>Exam Portal Login</h2>
        <div class="input-group"> <label for="userIdInput">User ID</label> <input type="text" id="userIdInput" value="UPSC2025"> </div>
        <div class="input-group"> <label for="passwordLoginInput">Password</label> <input type="password" id="passwordLoginInput" value="UPSChub@123"> </div>
        <button id="loginBtn" class="btn-primary">Login</button> <p id="loginError"></p>
    </div>
  </div>

  <!-- STAGE 2: INSTRUCTIONS & SYSTEM CHECK SCREEN (Hidden by default) -->
  <div id="instructionsScreen" class="pre-exam-screen">
      <div class="instructions-container">
          <div class="instructions-content">
              <h2>General Instructions:</h2>
              <ul>
                  <li><i class="fas fa-list-ol"></i><div>Total Questions: <strong id="totalQuestionsEl">30</strong>.</div></li>
                  <li><i class="fas fa-clock"></i><div>Total Duration: <strong>150 Minutes</strong>.</div></li>
                  <li><i class="fas fa-stopwatch-20"></i><div>Each question has a <strong>12-second timer</strong>. The test will automatically move to the next question when this timer ends.</div></li>
                   <li><i class="fas fa-calculator"></i><div>Marking Scheme: <strong>+1</strong> for a correct answer, <strong>-1</strong> for an incorrect answer, and <strong>0</strong> for an unattempted question.</div></li>
              </ul>
              <h2>Security & Environment:</h2>
              <ul>
                  <li><i class="fas fa-plane-departure"></i><div>You must take this exam in an offline environment. Please <strong>Enable Aeroplane/Flight Mode</strong> before starting.</div></li>
                  <li><i class="fas fa-wifi-slash"></i><div>If an internet connection is detected after starting, your test will be <strong>auto-submitted</strong>. This action is final.</div></li>
                  <li><i class="fas fa-window-close"></i><div>Do not close or refresh the browser window, as this will end your test.</div></li>
              </ul>
              <h2>Navigation Instructions:</h2>
              <ul>
                  <li><i class="fas fa-check" style="color:#4caf50;"></i><div>Click <strong>Save & Next</strong> to save your answer and move to the next question.</div></li>
                  <li><i class="fas fa-flag" style="color:#ff9800;"></i><div>Click <strong>Mark</strong> to mark a question for review.</div></li>
                  <li><i class="fas fa-square" style="color:#f44336;"></i><div>A <strong>Red</strong> number in the palette means you have visited but not answered the question.</div></li>
              </ul>
          </div>
          <div class="instructions-footer">
              <div id="offlineStatus" class="status-waiting"><i class="fas fa-wifi"></i> Please enable Aeroplane Mode.</div>
              <div class="agreement-group">
                  <input type="checkbox" id="agreementCheckbox">
                  <label for="agreementCheckbox">I have read all the instructions and I am ready to begin.</label>
              </div>
              <button id="startExamBtn" class="btn-primary btn-start-exam" disabled>Start Exam</button>
              <div id="startError"></div>
          </div>
      </div>
  </div>

  <!-- STAGE 3: EXAM UI WRAPPER (Hidden by default) -->
  <div id="examUIWrapper">
    <header class="site-header" id="siteHeader">
        <img src="images\LOGO.jpg" alt="UPSChub Logo" class="site-logo">
        <div class="site-branding">
            <div class="site-title">UPSChub</div>
            <p class="site-tagline">Civil Services Exam Preparation</p>
        </div>
    </header>
    <header class="topbar" id="topbar">
      <div class="topbar-left-group">
        <button id="btnToggleSidebar" class="sidebar-toggle" title="Toggle Palette"><i class="fas fa-chevron-left"></i></button>
        <div class="timer" id="timer">02:30:00</div>
        <div id="stopwatchWrapper">
          <span id="stopwatchDisplay">00:00:00</span>
          <div class="stopwatch-controls">
            <button id="stopwatchPlayPause" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button id="stopwatchReset" title="Reset"><i class="fas fa-rotate-left"></i></button>
          </div>
        </div>
      </div>
      <div class="navigation-tabs">
        <button id="showMockTestTab" class="nav-tab active">Mock Test</button>
        <button id="showAnswerWritingTab" class="nav-tab locked">Answer Writing</button>
      </div>
      <div class="topbar-right-group">
        <div class="dark-mode-toggle">
          <span class="toggle-label" id="toggleLabel">Dark</span>
          <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label>
        </div>
        <button id="btnSubmitTest" style="display: none;"><i class="fas fa-paper-plane"></i> Submit</button>
      </div>
    </header>
    <div class="main-content">
        <div id="mockTestWrapper" style="display: flex; width: 100%;">
            <section class="question-area">
                <h2 class="question-header" id="questionNumber"></h2>
                <div class="question-timer-bar-container"><div id="questionTimerBar" class="question-timer-bar"></div></div>
                <div class="question-content" id="questionText"></div>
                <ul class="options-list" id="optionsList"></ul>
            </section>
            <aside class="sidebar" id="sidebar">
              <div class="sidebar-content">
                <div class="palette-title">Question Palette</div>
                <div class="question-palette" id="questionPalette"></div>
                <div class="palette-summary">
                    <div class="summary-item"><span id="summaryAnswered">0</span> Answered</div>
                    <div class="summary-item"><span id="summaryNotAnswered">0</span> Not Answered</div>
                    <div class="summary-item"><span id="summaryMarked">0</span> Marked Review</div>
                    <div class="summary-item"><span id="summaryNotVisited">0</span> Not Visited</div>
                </div>
                <div class="legend">
                    <div class="legend-title">Legend</div>
                    <div class="legend-item"><div class="legend-color answered"></div><span>Answered</span></div>
                    <div class="legend-item"><div class="legend-color not-answered"></div><span>Not Answered</span></div>
                    <div class="legend-item"><div class="legend-color marked"></div><span>Marked</span></div>
                    <div class="legend-item"><div class="legend-color marked-answered"></div><span>Marked & Answered</span></div>
                    <div class="legend-item"><div class="legend-color not-visited"></div><span>Not Visited</span></div>
                </div>
              </div>
            </aside>
        </div>
        <div id="resultScreenWrapper">
            <h2>Test Completed!</h2>
            <p>Here is your score summary:</p>
            <p id="finalScore"></p> <!-- Kept for data storage but hidden -->

            <div class="scorecard-details">
                <table class="scorecard-table">
                    <tbody>
                        <tr>
                            <td><i class="fas fa-check-circle" style="color: #4caf50; margin-right: 8px;"></i>Correct Answers</td>
                            <td class="correct-val"><span id="correctCount">0</span> (<span id="correctMarks">0</span> Marks)</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-times-circle" style="color: #f44336; margin-right: 8px;"></i>Incorrect Answers</td>
                            <td class="incorrect-val"><span id="incorrectCount">0</span> (<span id="incorrectMarks">0</span> Marks)</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-minus-circle" style="color: #ff9800; margin-right: 8px;"></i>Unattempted</td>
                            <td class="unattempted-val"><span id="unattemptedCount">0</span></td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Final Score</strong></td>
                            <td class="total-val"><strong><span id="finalScoreAnimated">0</span> / <span id="totalPossibleScore">0</span></strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="result-buttons">
              <button id="retestButton" class="submit-button btn-action"><i class="fas fa-redo"></i> Retest</button>
              <button id="reviewAnswersButton" class="submit-button btn-action"><i class="fas fa-search"></i> Review Answers</button>
            </div>

            <div class="performance-analysis-container">
                <h3>Topic-wise Performance</h3>
                <div class="table-wrapper"><table class="performance-table"><thead><tr><th>Topic</th><th>Correct</th><th>Attempted</th><th>Accuracy</th></tr></thead><tbody id="performanceTableBody"></tbody></table></div>
            </div>
            <div class="chart-container"><canvas id="performanceChart"></canvas></div>
        </div>
        <div id="reviewScreenWrapper">
          <div class="review-header"><h2 class="review-title">Review Your Answers</h2><button id="backToResultsBtn" class="submit-button btn-action"><i class="fas fa-arrow-left"></i> Back to Score</button></div>
          <div id="reviewContainer"></div>
        </div>
        <div id="answerWritingWrapper">
           <div><h2>Answer Writing Practice</h2><p>This section is for practicing descriptive answers after the mock test.</p></div>
        </div>
    </div>
    <div class="fixed-action-area" id="mcqFooter">
        <div class="action-buttons">
            <button class="btn-action" id="btnPrevQuestion"><i class="fas fa-arrow-left"></i><span>Previous</span></button>
            <button class="btn-action" id="btnClearResponse"><i class="fas fa-ban"></i><span>Clear</span></button>
            <button class="btn-action" id="btnMarkReview"><i class="fas fa-flag"></i><span>Mark</span></button>
            <button class="btn-action" id="btnSaveNext"><i class="fas fa-check"></i><span>Save & Next</span></button>
        </div>
    </div>
  </div>
  <div id="passwordModal" class="password-modal">
        <div class="modal-content">
            <span id="closeModal" class="close-modal">×</span>
            <h3>Enter Password to Retest</h3>
            <input type="password" id="passwordRetestInput" placeholder="Enter password...">
            <div id="passwordError"></div>
            <button id="verifyPasswordButton" class="submit-button btn-action">Verify</button>
            <p class="contact-admin-text">Don't have a password? <a id="whatsappLink" href="#" target="_blank">Contact Admin</a></p>
        </div>
  </div>

 <script>
    // ### CONFIGURATION ###
    const CORRECT_USER_ID = "UPSC2025";
    const CORRECT_PASSWORD = "UPSChub@123";
    const RETEST_PASSWORD = "UPSC2024";
    const TEST_DURATION_SECONDS = 150 * 60;
    const PER_QUESTION_TIME = 12;
    const questions = [
        { topic: "Union & Territory", text: "Article 1 of the Constitution describes India as a:", options: ["Federation of States", "Union of States", "Confederation of States", "Quasi-Federal State"], answer: 1, explanation: "<strong>Article 1</strong> states, 'India, that is Bharat, shall be a <strong>Union of States</strong>'. The term 'Union' was preferred over 'Federation' to indicate that the Indian Union is not the result of an agreement among the states and the states have no right to secede from the union. The country is an integral whole and divided into different states only for convenience of administration." },
        { topic: "Union & Territory", text: "The power to admit into the Union of India new states which are not part of India is given to Parliament by:", options: ["Article 1", "Article 2", "Article 3", "Article 4"], answer: 1, explanation: "<strong>Article 2</strong> empowers the Parliament to 'admit into the Union of India, or establish, new states on such terms and conditions as it thinks fit'. This power relates to the admission of states that are not already part of India." },
        { topic: "Union & Territory", text: "A bill for altering state boundaries can be introduced in Parliament only with the prior recommendation of the:", options: ["Prime Minister", "President", "Speaker of Lok Sabha", "Concerned State Governor"], answer: 1, explanation: "<strong>Article 3</strong> requires that any bill for forming a new state or altering the boundaries, areas, or names of existing states can only be introduced in either House of Parliament on the prior recommendation of the <strong>President</strong>." },
        { topic: "Union & Territory", text: "Is Parliament bound by the views of the state legislature on a bill altering its boundary?", options: ["Yes, always", "Yes, if passed by a special majority", "No, Parliament is not bound", "Only if it's a Union Territory"], answer: 2, explanation: "The President refers the bill to the concerned state legislature for expressing its views within a specified period. However, Parliament is <strong>not bound by these views</strong>. It can proceed with the changes even if the state legislature disagrees, highlighting India's nature as an 'indestructible union of destructible states'." },
        { topic: "Union & Territory", text: "Laws made for admission or establishment of new states (under Art 2) and formation of new states (under Art 3) are not to be considered as amendments under Article 368. This means they can be passed by:", options: ["Special majority", "Simple majority", "Special majority with ratification by states", "Referendum"], answer: 1, explanation: "<strong>Article 4</strong> of the Constitution itself declares that laws made under Article 2 and 3 are not to be considered as amendments to the Constitution for the purposes of Article 368. This means such changes can be passed by a <strong>simple majority</strong> and by the ordinary legislative process." },
        { topic: "Union & Territory", text: "The integration of princely states was primarily overseen by:", options: ["Jawaharlal Nehru", "Sardar Vallabhbhai Patel", "B.R. Ambedkar", "Lord Mountbatten"], answer: 1, explanation: "<strong>Sardar Vallabhbhai Patel</strong>, as the first Deputy Prime Minister and Home Minister of India, played a pivotal role in the integration of the 565 princely states into the Indian Union, using both diplomacy and military force when necessary. His efforts earned him the title 'Iron Man of India'." },
        { topic: "Union & Territory", text: "Which was the first commission appointed to examine the feasibility of reorganising states on a linguistic basis?", options: ["Fazl Ali Commission", "JVP Committee", "Dhar Commission", "States Reorganisation Commission"], answer: 2, explanation: "The <strong>Dhar Commission</strong> (Linguistic Provinces Commission) was appointed in June 1948 under S.K. Dhar to examine the feasibility of reorganising states on a linguistic basis. It recommended reorganisation based on administrative convenience rather than language." },
        { topic: "Union & Territory", text: "The first linguistic state created in India was:", options: ["Kerala", "Tamil Nadu", "Andhra State", "Karnataka"], answer: 2, explanation: "Following widespread agitation and the death of Potti Sriramulu, the Government of India was forced to create the first linguistic state, known as <strong>Andhra State</strong>, by separating the Telugu-speaking areas from the Madras State in October 1953." },
        { topic: "Union & Territory", text: "The States Reorganisation Act of 1956 created:", options: ["16 States and 3 UTs", "14 States and 6 UTs", "22 States and 9 UTs", "15 States and 5 UTs"], answer: 1, explanation: "Based on the recommendations of the Fazl Ali Commission, the States Reorganisation Act, 1956, and the 7th Constitutional Amendment Act, 1956, abolished the old four-fold classification and created <strong>14 states and 6 union territories</strong> on November 1, 1956." },
        { topic: "Union & Territory", text: "The state of Bombay was bifurcated into Maharashtra and Gujarat in:", options: ["1956", "1960", "1966", "1971"], answer: 1, explanation: "In <strong>1960</strong>, following popular agitation by movements like the Samyukta Maharashtra Andolan and Mahagujarat Andolan, the bilingual state of Bombay was divided into two separate states: Maharashtra for Marathi-speaking people and Gujarat for Gujarati-speaking people." },
        { topic: "Union & Territory", text: "The state of Haryana was carved out of Punjab in 1966 on the recommendation of the:", options: ["Fazl Ali Commission", "Shah Commission", "Sarkaria Commission", "Dhar Commission"], answer: 1, explanation: "On the recommendation of the <strong>Shah Commission</strong> (1966), the state of Punjab was bifurcated to create Haryana (the 17th state of India) and the union territory of Chandigarh. The hill areas of Punjab were merged with Himachal Pradesh." },
        { topic: "Union & Territory", text: "Sikkim was made a full-fledged state of the Union of India by which amendment?", options: ["35th Amendment", "36th Amendment", "42nd Amendment", "22nd Amendment"], answer: 1, explanation: "The <strong>35th Amendment Act (1974)</strong> made Sikkim an 'associate state'. However, this was a transitional provision. A year later, the <strong>36th Amendment Act (1975)</strong> was enacted to make Sikkim a full-fledged state of the Indian Union (the 22nd state)." },
        { topic: "Union & Territory", text: "The states of Chhattisgarh, Uttarakhand, and Jharkhand were created in:", options: ["1999", "2000", "2001", "2014"], answer: 1, explanation: "In the year <strong>2000</strong>, three new states were created: Chhattisgarh (from Madhya Pradesh), Uttarakhand (from Uttar Pradesh, initially named Uttaranchal), and Jharkhand (from Bihar)." },
        { topic: "Union & Territory", text: "The power to cede Indian territory to a foreign country requires:", options: ["The President's order", "The Prime Minister's approval", "A constitutional amendment", "A treaty signed by the executive"], answer: 2, explanation: "The Supreme Court held in the <strong>Berubari Union case (1960)</strong> that ceding Indian territory to a foreign country requires a <strong>constitutional amendment under Article 368</strong>, as it diminishes the territory of the country. A simple executive action is not sufficient." },
        { topic: "Union & Territory", text: "The 'Territory of India' is a wider expression than the 'Union of India' because it includes:", options: ["States only", "UTs only", "States, UTs, and territories that may be acquired", "States and UTs only"], answer: 2, explanation: "The 'Union of India' includes only the states. The 'Territory of India' is a broader concept that includes the <strong>states, the union territories, and any territories that may be acquired by India</strong> at any time. The states share a federal relationship with the Centre, while acquired/union territories are directly administered by the Centre." },
        { topic: "Union & Territory", text: "The USA, in contrast to India, is described as:", options: ["An indestructible union of indestructible states", "An indestructible union of destructible states", "A destructible union of indestructible states", "A destructible union of destructible states"], answer: 0, explanation: "The USA is described as an <strong>'indestructible union of indestructible states'</strong> because the federal government cannot alter state boundaries without their consent. In contrast, India is an 'indestructible union of destructible states' as the Union Parliament can alter state boundaries without their consent." },
        { topic: "Union & Territory", text: "The exchange of enclaves with Bangladesh was actualized by the:", options: ["99th Amendment", "100th Amendment", "101st Amendment", "An executive order"], answer: 1, explanation: "The <strong>100th Constitutional Amendment Act (2015)</strong> was enacted to give effect to the Land Boundary Agreement between India and Bangladesh. It involved acquiring certain enclaves from Bangladesh and ceding others, thus modifying the territories mentioned in the First Schedule of the Constitution." },
        { topic: "Union & Territory", text: "The integration of Hyderabad into the Indian Union was achieved through:", options: ["A referendum", "A treaty", "Police Action (Operation Polo)", "An Instrument of Accession"], answer: 2, explanation: "After the Nizam of Hyderabad refused to join India, the Indian government launched a military operation codenamed <strong>'Operation Polo'</strong> in September 1948. This police action led to the surrender of the Nizam's army and the accession of Hyderabad to India." },
        { topic: "Union & Territory", text: "The Zonal Councils, created by the States Reorganisation Act 1956, are:", options: ["Constitutional bodies", "Statutory bodies", "Executive bodies", "Ad-hoc bodies"], answer: 1, explanation: "Zonal Councils were established by the <strong>States Reorganisation Act of 1956</strong>, which is an Act of Parliament. Therefore, they are <strong>statutory bodies</strong>, not constitutional or executive bodies. They aim to promote inter-state cooperation." },
        { topic: "Union & Territory", text: "The chairman of the Zonal Councils is the:", options: ["Prime Minister", "President", "Union Home Minister", "Chief Minister by rotation"], answer: 2, explanation: "The <strong>Union Home Minister</strong> is the common chairman of the five zonal councils. The Chief Ministers of the states in each zone act as vice-chairmen by rotation, holding office for a period of one year at a time." },
        { topic: "Union & Territory", text: "Article 3 gives Parliament the power to form a new state by:", options: ["Separation of territory from any state", "Uniting two or more states", "Uniting any territory to a part of any state", "All of the above"], answer: 3, explanation: "<strong>Article 3</strong> authorizes the Parliament to: (a) form a new state by separation of territory from any state or by uniting two or more states or parts of states or by uniting any territory to a part of any state, (b) increase the area of any state, (c) diminish the area of any state, (d) alter the boundaries of any state, and (e) alter the name of any state. Thus, <strong>all of the above</strong> are correct." },
        { topic: "Union & Territory", text: "The Fazl Ali Commission (1953) accepted language as a basis for reorganisation but rejected the theory of:", options: ["'one language-one state'", "'administrative convenience'", "'financial viability'", "'national unity'"], answer: 0, explanation: "The Fazl Ali Commission broadly accepted language as the basis of reorganisation but firmly rejected the <strong>'one language-one state'</strong> theory. It believed that the unity of India should be regarded as the primary consideration in any redrawing of the country’s political units." },
        { topic: "Union & Territory", text: "Goa, Daman and Diu were liberated from Portuguese rule by:", options: ["Referendum", "Police action", "Treaty", "UN resolution"], answer: 1, explanation: "India acquired Goa, Daman and Diu from the Portuguese through <strong>police action</strong> in 1961. They were constituted as a union territory by the 12th Constitutional Amendment Act, 1962. Goa was later conferred statehood in 1987." },
        { topic: "Union & Territory", text: "The name 'Mysore' was changed to 'Karnataka' in:", options: ["1956", "1969", "1973", "2001"], answer: 2, explanation: "In <strong>1973</strong>, the name of the state of Mysore was changed to Karnataka to reflect the identity of the Kannada-speaking regions within the state more accurately. Similarly, Laccadive, Minicoy and Amindivi Islands were renamed Lakshadweep in the same year." },
        { topic: "Union & Territory", text: "The change of name of a state like from 'Orissa' to 'Odisha' requires:", options: ["Constitutional Amendment under Art 368", "An Act of Parliament by simple majority", "An executive order of the President", "A resolution by the state assembly only"], answer: 1, explanation: "Changing the name of a state falls under the powers of Parliament in Article 3. According to Article 4, such changes are not considered constitutional amendments under Article 368. Therefore, it requires an <strong>Act of Parliament passed by a simple majority</strong> after getting the views of the state legislature." },
        { topic: "Union & Territory", text: "Which schedule of the Constitution deals with the allocation of seats in the Rajya Sabha to the states and UTs?", options: ["Third Schedule", "Fourth Schedule", "Fifth Schedule", "Sixth Schedule"], answer: 1, explanation: "The <strong>Fourth Schedule</strong> of the Constitution deals with the allocation of seats in the Rajya Sabha (Council of States) to the various states and union territories. The number of seats is based on the population of each state." },
        { topic: "Union & Territory", text: "The North-Eastern Council was created by a separate Act of Parliament in:", options: ["1956", "1963", "1971", "1987"], answer: 2, explanation: "The North-Eastern Council (NEC) was created by the <strong>North-Eastern Council Act of 1971</strong>. It is not a Zonal Council but a separate statutory body to address the specific developmental and security needs of the North-Eastern states." },
        { topic: "Union & Territory", text: "Settlement of a boundary dispute with another country can be done by:", options: ["Constitutional Amendment", "Executive action", "Judicial order", "State legislature's resolution"], answer: 1, explanation: "The Supreme Court has clarified the distinction: ceding territory requires a constitutional amendment, but the settlement of a boundary dispute (which does not involve loss of territory) can be done by an <strong>executive action</strong>, as it does not amount to an alteration of India's territory." },
        { topic: "Union & Territory", text: "Can Parliament diminish the area of a state to an extent that it ceases to exist?", options: ["No, it violates the basic structure", "Yes, the power under Article 3 is absolute in this regard", "Only with Supreme Court permission", "Only with a 2/3rds majority in the state assembly"], answer: 1, explanation: "<strong>Yes</strong>, the power of Parliament to diminish the area of a state under Article 3 is extensive. It includes the power to cede Indian territory to a foreign country (via constitutional amendment) and to completely alter a state's identity or even erase it from the map. The existence of a state is at the pleasure of the Parliament, affirming India as an 'indestructible union of destructible states'." },
        { topic: "Union & Territory", text: "Which Union Territory was recently merged with Dadra and Nagar Haveli?", options: ["Puducherry", "Lakshadweep", "Daman and Diu", "Andaman & Nicobar Islands"], answer: 2, explanation: "In 2020, the Parliament passed legislation to merge the Union Territories of Dadra and Nagar Haveli and <strong>Daman and Diu</strong> into a single Union Territory. The new UT is named 'Dadra and Nagar Haveli and Daman and Diu' with its capital at Daman." },
    ];


    // ### GLOBAL STATE & DOM ELEMENTS ###
    let state = {};
    let timerInterval, onTimerEnd, stopwatchInterval, animationInterval;
    let timeLeft = TEST_DURATION_SECONDS;
    let isTestCompleted = false;
    let performanceChart = null;
    let stopwatchTime = 0;
    let isStopwatchRunning = false;

    const dom = {
      body: document.body,
      loginScreen: document.getElementById('loginScreen'),
      loginBtn: document.getElementById('loginBtn'),
      userIdInput: document.getElementById('userIdInput'),
      passwordLoginInput: document.getElementById('passwordLoginInput'),
      loginError: document.getElementById('loginError'),
      instructionsScreen: document.getElementById('instructionsScreen'),
      startExamBtn: document.getElementById('startExamBtn'),
      offlineStatus: document.getElementById('offlineStatus'),
      agreementCheckbox: document.getElementById('agreementCheckbox'),
      startError: document.getElementById('startError'),
      totalQuestionsEl: document.getElementById('totalQuestionsEl'),
      examUIWrapper: document.getElementById('examUIWrapper'),
      siteHeader: document.getElementById('siteHeader'),
      topbar: document.getElementById('topbar'),
      sidebar: document.getElementById('sidebar'),
      mockTestWrapper: document.getElementById('mockTestWrapper'),
      mcqFooter: document.getElementById('mcqFooter'),
      questionText: document.getElementById('questionText'),
      questionNumber: document.getElementById('questionNumber'),
      questionTimerBar: document.getElementById('questionTimerBar'),
      optionsList: document.getElementById('optionsList'),
      questionPalette: document.getElementById('questionPalette'),
      btnSubmitTest: document.getElementById('btnSubmitTest'),
      btnPrevQuestion: document.getElementById('btnPrevQuestion'),
      btnSaveNext: document.getElementById('btnSaveNext'),
      btnMarkReview: document.getElementById('btnMarkReview'),
      btnClearResponse: document.getElementById('btnClearResponse'),
      timer: document.getElementById('timer'),
      darkModeToggle: document.getElementById('darkModeToggle'),
      toggleLabel: document.getElementById('toggleLabel'),
      sidebarToggle: document.getElementById('btnToggleSidebar'),
      summaryAnswered: document.getElementById('summaryAnswered'),
      summaryNotAnswered: document.getElementById('summaryNotAnswered'),
      summaryMarked: document.getElementById('summaryMarked'),
      summaryNotVisited: document.getElementById('summaryNotVisited'),
      resultScreenWrapper: document.getElementById('resultScreenWrapper'),
      reviewScreenWrapper: document.getElementById('reviewScreenWrapper'),
      performanceTableBody: document.getElementById('performanceTableBody'),
      reviewContainer: document.getElementById('reviewContainer'),
      finalScore: document.getElementById('finalScore'),
      retestButton: document.getElementById('retestButton'),
      reviewAnswersButton: document.getElementById('reviewAnswersButton'),
      backToResultsBtn: document.getElementById('backToResultsBtn'),
      passwordModal: document.getElementById('passwordModal'),
      closeModal: document.getElementById('closeModal'),
      verifyPasswordButton: document.getElementById('verifyPasswordButton'),
      passwordRetestInput: document.getElementById('passwordRetestInput'),
      passwordError: document.getElementById('passwordError'),
      whatsappLink: document.getElementById('whatsappLink'),
      showMockTestTab: document.getElementById('showMockTestTab'),
      showAnswerWritingTab: document.getElementById('showAnswerWritingTab'),
      answerWritingWrapper: document.getElementById('answerWritingWrapper'),
      stopwatchWrapper: document.getElementById('stopwatchWrapper'),
      stopwatchDisplay: document.getElementById('stopwatchDisplay'),
      stopwatchPlayPause: document.getElementById('stopwatchPlayPause'),
      stopwatchReset: document.getElementById('stopwatchReset'),
      correctCount: document.getElementById('correctCount'),
      correctMarks: document.getElementById('correctMarks'),
      incorrectCount: document.getElementById('incorrectCount'),
      incorrectMarks: document.getElementById('incorrectMarks'),
      unattemptedCount: document.getElementById('unattemptedCount'),
      finalScoreAnimated: document.getElementById('finalScoreAnimated'),
      totalPossibleScore: document.getElementById('totalPossibleScore'),
    };

    // ### STAGE 1 & 2: PRE-EXAM LOGIC ###

    function handleLogin() {
        if (dom.userIdInput.value === CORRECT_USER_ID && dom.passwordLoginInput.value === CORRECT_PASSWORD) {
            dom.loginScreen.style.display = 'none';
            dom.instructionsScreen.style.display = 'flex';
        } else {
            dom.loginError.textContent = 'Invalid User ID or Password.';
        }
    }

    function validateStartConditions() {
        const isOffline = !navigator.onLine;
        const isAgreed = dom.agreementCheckbox.checked;
        dom.startExamBtn.disabled = !(isOffline && isAgreed);

        let errorMsg = '';
        if (!isOffline && !isAgreed) errorMsg = 'Please agree to terms and enable Aeroplane Mode.';
        else if (!isOffline) errorMsg = 'Please enable Aeroplane Mode to continue.';
        else if (!isAgreed) errorMsg = 'Please agree to the instructions to start.';
        dom.startError.textContent = errorMsg;

        if (isOffline) {
            dom.offlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> You are offline. Ready to begin.';
            dom.offlineStatus.className = 'status-ready';
        } else {
            dom.offlineStatus.innerHTML = '<i class="fas fa-wifi"></i> Please enable Aeroplane Mode.';
            dom.offlineStatus.className = 'status-waiting';
        }
    }
    
    function startExam() {
        if (dom.startExamBtn.disabled) return;
        dom.instructionsScreen.style.display = 'none';
        dom.examUIWrapper.style.display = 'flex';
        dom.body.classList.add('exam-active');
        updateSidebarPosition();
        window.removeEventListener('online', validateStartConditions);
        window.removeEventListener('offline', validateStartConditions);
        window.addEventListener('online', forceSubmitOnReconnect);
        initTest();
    }

    function forceSubmitOnReconnect() {
        if (!isTestCompleted) {
            alert("Internet connection detected. Submitting the test as per rules.");
            submitTest(true);
        }
    }

    // ### STAGE 3: MAIN TEST LOGIC ###

    function initTest() {
        resetState();
        timeLeft = TEST_DURATION_SECONDS;
        isTestCompleted = false;
        dom.showAnswerWritingTab.classList.add('locked');
        state.visited[0] = true;
        resetStopwatch();
        setView('mockTest');
        loadQuestion(0);
        startTimer();
    }

    function resetState() {
        state = { current: 0, answers: Array(questions.length).fill(null), marked: Array(questions.length).fill(false), visited: Array(questions.length).fill(false) };
    }

    function setView(viewName) {
        dom.mockTestWrapper.style.display = 'none';
        dom.resultScreenWrapper.style.display = 'none';
        dom.reviewScreenWrapper.style.display = 'none';
        dom.answerWritingWrapper.style.display = 'none';
        dom.mcqFooter.style.display = 'none';
        dom.sidebar.style.display = 'none';
        dom.timer.style.display = 'none';
        dom.stopwatchWrapper.style.display = 'none';
        dom.showMockTestTab.classList.remove('active');
        dom.showAnswerWritingTab.classList.remove('active');
        clearInterval(animationInterval);

        if (viewName === 'mockTest') {
            dom.showMockTestTab.classList.add('active');
            dom.timer.style.display = 'block';
            if (isTestCompleted) {
                const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
                const topicStats = JSON.parse(localStorage.getItem('topicStats'));
                showResultScreen(breakdown, topicStats);
            } else {
                dom.mockTestWrapper.style.display = 'flex';
                dom.mcqFooter.style.display = 'block';
                dom.sidebar.style.display = 'flex';
            }
        } else if (viewName === 'answerWriting') {
            if (dom.showAnswerWritingTab.classList.contains('locked')) return;
            dom.showAnswerWritingTab.classList.add('active');
            dom.stopwatchWrapper.style.display = 'flex';
            dom.answerWritingWrapper.style.display = 'flex';
        }
    }

    function loadQuestion(index) {
        state.current = index;
        if (!state.visited[index]) { state.visited[index] = true; }
        startQuestionTimer();
        const q = questions[index];
        dom.questionNumber.textContent = `Question ${index + 1}`;
        dom.questionText.textContent = q.text;
        dom.optionsList.innerHTML = '';
        q.options.forEach((opt, i) => {
            const li = document.createElement('li');
            li.className = 'option';
            if (state.answers[index] === i) li.classList.add('selected');
            li.innerHTML = `<span class="option-radio"></span><span class="option-text">${opt}</span>`;
            li.onclick = () => selectOption(i);
            dom.optionsList.appendChild(li);
        });
        dom.btnSubmitTest.style.display = (state.current === questions.length - 1) ? 'flex' : 'none';
        updatePalette();
        updateNavigationButtons();
    }

    function selectOption(optIndex) {
        state.answers[state.current] = optIndex;
        dom.optionsList.querySelectorAll('.option').forEach((opt, i) => opt.classList.toggle('selected', i === optIndex));
        updatePalette();
    }

    function handleSaveAndNext() {
      if (isTestCompleted) return;
      if (state.current < questions.length - 1) {
          loadQuestion(state.current + 1);
      } else {
          submitTest(true);
      }
    }

    function handleMarkAndNext() {
      if (isTestCompleted) return;
      state.marked[state.current] = true;
      handleSaveAndNext();
    }
    
    function handleClearResponse() {
        state.answers[state.current] = null;
        dom.optionsList.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        updatePalette();
    }

    function submitTest(isForced = false) {
        if (isTestCompleted) return;
        if (!isForced) {
             if (!confirm('Are you sure you want to submit the test?')) return;
        }

        stopTimer();
        isTestCompleted = true;
        window.removeEventListener('online', forceSubmitOnReconnect);
        dom.showAnswerWritingTab.classList.remove('locked');
        
        const scoreBreakdown = calculateScoreBreakdown();
        const topicStats = calculateTopicStats();

        localStorage.setItem('testTaken', 'true');
        localStorage.setItem('lastAnswers', JSON.stringify(state.answers));
        localStorage.setItem('scoreBreakdown', JSON.stringify(scoreBreakdown));
        localStorage.setItem('topicStats', JSON.stringify(topicStats));

        showResultScreen(scoreBreakdown, topicStats);
    }
    
    function calculateScoreBreakdown() {
        let correctCount = 0, incorrectCount = 0;
        state.answers.forEach((ans, i) => {
            if (ans !== null) {
                if (ans === questions[i].answer) correctCount++;
                else incorrectCount++;
            }
        });
        const unattemptedCount = questions.length - correctCount - incorrectCount;
        const totalScore = correctCount - incorrectCount;

        return {
            correctCount,
            incorrectCount,
            unattemptedCount,
            totalScore,
            totalQuestions: questions.length,
            correctMarks: correctCount * 1,
            incorrectMarks: incorrectCount * -1,
        };
    }

    function updatePalette() {
        dom.questionPalette.innerHTML = '';
        let answered = 0, notAnswered = 0, marked = 0, notVisited = 0;
        questions.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = 'question-number';
            const isAnswered = state.answers[i] !== null;
            const isMarked = state.marked[i];
            if(isAnswered && isMarked) btn.classList.add('marked-answered');
            else if(isAnswered) btn.classList.add('answered');
            else if(isMarked) btn.classList.add('marked');
            else if(state.visited[i]) btn.classList.add('not-answered');
            else btn.classList.add('not-visited');
            if (i === state.current) btn.classList.add('current');
            if (isAnswered) answered++;
            if (isMarked) marked++;
            if (!state.visited[i]) notVisited++;
            btn.textContent = i + 1;
            btn.onclick = () => { if (!isTestCompleted) loadQuestion(i); };
            dom.questionPalette.appendChild(btn);
        });
        notAnswered = state.visited.filter((v, i) => v && state.answers[i] === null && !state.marked[i]).length;
        dom.summaryAnswered.textContent = answered;
        dom.summaryMarked.textContent = marked;
        dom.summaryNotAnswered.textContent = notAnswered;
        dom.summaryNotVisited.textContent = notVisited;
    }

    function updateNavigationButtons() {
        dom.btnPrevQuestion.style.display = state.current === 0 ? 'none' : 'flex';
        dom.btnSaveNext.querySelector('span').textContent = (state.current === questions.length - 1) ? "Save & Finish" : "Save & Next";
    }

    function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
          if (timeLeft <= 0) {
              clearInterval(timerInterval);
              alert("Time's up! The test will be submitted automatically.");
              submitTest(true);
              return;
          }
          timeLeft--;
          dom.timer.textContent = formatTime(timeLeft);
      }, 1000);
    }
    
    function startQuestionTimer() {
        if (onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd);
        onTimerEnd = () => handleSaveAndNext();
        dom.questionTimerBar.style.transition = 'none';
        dom.questionTimerBar.style.width = '100%';
        dom.questionTimerBar.offsetHeight;
        dom.questionTimerBar.style.transition = `width ${PER_QUESTION_TIME}s linear`;
        dom.questionTimerBar.style.width = '0%';
        dom.questionTimerBar.addEventListener('transitionend', onTimerEnd, { once: true });
    }

    function stopTimer() {
        clearInterval(timerInterval);
        if(onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd);
    }
    
    function toggleStopwatch() {
        const icon = dom.stopwatchPlayPause.querySelector('i');
        if (isStopwatchRunning) {
            clearInterval(stopwatchInterval);
            icon.classList.replace('fa-pause', 'fa-play');
        } else {
            stopwatchInterval = setInterval(() => {
                stopwatchTime++;
                dom.stopwatchDisplay.textContent = formatTime(stopwatchTime);
            }, 1000);
            icon.classList.replace('fa-play', 'fa-pause');
        }
        isStopwatchRunning = !isStopwatchRunning;
    }

    function resetStopwatch() {
        clearInterval(stopwatchInterval);
        isStopwatchRunning = false;
        stopwatchTime = 0;
        dom.stopwatchDisplay.textContent = formatTime(0);
        const icon = dom.stopwatchPlayPause.querySelector('i');
        if(icon) {
           icon.classList.replace('fa-pause', 'fa-play');
        }
    }

    function toggleDarkMode(isDark) {
        dom.body.classList.toggle('dark', isDark);
        dom.toggleLabel.textContent = isDark ? 'Light' : 'Dark';
        if (isTestCompleted && performanceChart) {
            const topicStats = JSON.parse(localStorage.getItem('topicStats'));
            renderPerformanceChart(topicStats);
        }
    }
    
    function updateSidebarPosition() {
        const headerHeight = dom.siteHeader.offsetHeight;
        const topbarHeight = dom.topbar.offsetHeight;
        const totalHeaderHeight = headerHeight + topbarHeight;
        dom.sidebar.style.top = `${totalHeaderHeight}px`;
        dom.sidebar.style.height = `calc(100% - ${totalHeaderHeight}px)`;
    }

    // ### STAGE 4: RESULT & REVIEW FUNCTIONS ###
    function showResultScreen(breakdown, topicStats) {
        dom.mockTestWrapper.style.display = 'none';
        dom.reviewScreenWrapper.style.display = 'none';
        dom.mcqFooter.style.display = 'none';
        dom.sidebar.style.display = 'none';
        dom.btnSubmitTest.style.display = 'none';
        dom.resultScreenWrapper.style.display = 'flex';
        
        if (breakdown) {
             dom.totalPossibleScore.textContent = breakdown.totalQuestions;
             animateScorecard(breakdown);
        }

        populatePerformanceTable(topicStats);
        setTimeout(() => renderPerformanceChart(topicStats), 100);
    }
    
    function animateScorecard(data) {
        let current = { correctCount: 0, incorrectCount: 0, unattemptedCount: 0, correctMarks: 0, incorrectMarks: 0, totalScore: 0 };
        const animationSpeed = 20;
        const duration = 1200;
        const steps = duration / animationSpeed;
        
        const stepValues = {};
        for (const key in current) {
            stepValues[key] = data[key] / steps;
        }
        
        clearInterval(animationInterval);
        animationInterval = setInterval(() => {
            let finished = true;
            for (const key in current) {
                if (stepValues[key] > 0) { // Positive values
                    if (current[key] < data[key]) {
                        current[key] += stepValues[key];
                        finished = false;
                    } else {
                        current[key] = data[key];
                    }
                } else { // Negative or zero values
                     if (current[key] > data[key]) {
                        current[key] += stepValues[key]; 
                        finished = false;
                    } else {
                        current[key] = data[key];
                    }
                }
            }

            dom.correctCount.textContent = Math.round(current.correctCount);
            dom.correctMarks.textContent = `+${Math.round(current.correctMarks)}`;
            dom.incorrectCount.textContent = Math.round(current.incorrectCount);
            dom.incorrectMarks.textContent = Math.round(current.incorrectMarks);
            dom.unattemptedCount.textContent = Math.round(current.unattemptedCount);
            dom.finalScoreAnimated.textContent = Math.round(current.totalScore);

            if(finished) clearInterval(animationInterval);
        }, animationSpeed);
    }

    function calculateTopicStats() {
      const topicStats = {};
      questions.forEach((q, i) => {
        if (!topicStats[q.topic]) { topicStats[q.topic] = { correct: 0, attempted: 0 }; }
        if (state.answers[i] !== null) {
          topicStats[q.topic].attempted++;
          if (state.answers[i] === q.answer) { topicStats[q.topic].correct++; }
        }
      });
      return topicStats;
    }

    function populatePerformanceTable(topicStats) {
        dom.performanceTableBody.innerHTML = '';
        if (!topicStats) return;
        Object.keys(topicStats).forEach(topicName => {
            const stats = topicStats[topicName];
            const accuracy = stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
            const barColor = accuracy > 75 ? '#4caf50' : accuracy >= 40 ? '#ff9800' : '#f44336';
            const row = `
                <tr>
                    <td>${topicName}</td>
                    <td>${stats.correct}</td>
                    <td>${stats.attempted}</td>
                    <td>
                        <div class="accuracy-bar-container">
                            <div class="accuracy-bar" style="width: ${accuracy}%; background-color: ${barColor};"></div>
                            <span class="accuracy-text">${accuracy}%</span>
                        </div>
                    </td>
                </tr>`;
            dom.performanceTableBody.innerHTML += row;
        });
    }
    
    function renderPerformanceChart(topicStats) {
      if (performanceChart) performanceChart.destroy();
      if (!topicStats) return;
      
      const isDark = dom.body.classList.contains('dark');
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const textColor = isDark ? 'rgba(255, 255, 255, 0.7)' : '#666';

      const labels = Object.keys(topicStats);
      const marksData = labels.map(label => topicStats[label].correct);
      const accuracyData = labels.map(label => {
        const stats = topicStats[label];
        return stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
      });

      const ctx = document.getElementById('performanceChart').getContext('2d');
      performanceChart = new Chart(ctx, {
          type: 'bar', data: { labels: labels, datasets: [{ label: 'Correct Answers (Marks)', data: marksData, backgroundColor: '#3f51b5', yAxisID: 'y' }, { label: 'Accuracy (%)', data: accuracyData, type: 'line', borderColor: '#4caf50', tension: 0.1, yAxisID: 'y1' }] },
          options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { type: 'linear', position: 'left', title: { display: true, text: 'Correct Answers', color: textColor }, ticks: { color: textColor, precision: 0 }, grid: { color: gridColor }, beginAtZero: true }, y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Accuracy (%)', color: textColor }, ticks: { color: textColor }, grid: { drawOnChartArea: false } } }, plugins: { legend: { labels: { color: textColor } } } }
      });
    }

    function showReviewScreen() {
      dom.resultScreenWrapper.style.display = 'none';
      dom.reviewScreenWrapper.style.display = 'flex';
      populateReviewScreen();
    }

    function populateReviewScreen() {
        dom.reviewContainer.innerHTML = '';
        const userAnswers = JSON.parse(localStorage.getItem('lastAnswers'));
        if (!userAnswers) return;
        questions.forEach((q, index) => {
            const userAnswer = userAnswers[index];
            const correctAnswer = q.answer;
            const isCorrect = userAnswer === correctAnswer;
            
            let optionsHTML = '';
            q.options.forEach((opt, optIndex) => {
                let classes = 'review-option';
                let icon = '<i class="far fa-circle"></i>';
                if (optIndex === correctAnswer) { classes += ' review-correct'; icon = '<i class="fas fa-check-circle"></i>'; }
                if (optIndex === userAnswer && !isCorrect) { classes += ' review-incorrect'; icon = '<i class="fas fa-times-circle"></i>'; }
                optionsHTML += `<li class="${classes}">${icon}<span>${opt}</span></li>`;
            });

            let statusHTML = '';
            if (userAnswer === null) { statusHTML = '<div class="review-status unanswered">Status: Unanswered</div>'; } 
            else if (isCorrect) { statusHTML = '<div class="review-status correct">Status: Correct</div>'; } 
            else { statusHTML = '<div class="review-status incorrect">Status: Incorrect</div>'; }

            const explanationHTML = `<div class="review-explanation"><strong>Explanation:</strong> ${q.explanation}</div>`;

            const questionDiv = document.createElement('div');
            questionDiv.className = 'review-question';
            questionDiv.innerHTML = `
                <h4>Q${index + 1}: ${q.text}</h4>
                <ul class="review-option-list">${optionsHTML}</ul>
                ${statusHTML}
                ${explanationHTML}
            `;
            dom.reviewContainer.appendChild(questionDiv);
        });
    }

    function handleRetest() {
        if (navigator.onLine) {
            dom.passwordError.textContent = 'Please enable Aeroplane Mode to retest.';
            return;
        }
      
        if (dom.passwordRetestInput.value === RETEST_PASSWORD) {
            localStorage.clear();
            location.reload(); // Reloads the page, providing a clean slate and fixing the network check bug.
        } else {
            dom.passwordError.textContent = 'Incorrect password.';
        }
    }

    // ### MASTER EVENT LISTENERS SETUP ###
    document.addEventListener('DOMContentLoaded', () => {
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark') {
            dom.darkModeToggle.checked = true;
            toggleDarkMode(true);
        }
        
        if (localStorage.getItem('testTaken') === 'true') {
            isTestCompleted = true;
            dom.showAnswerWritingTab.classList.remove('locked');
            dom.loginScreen.style.display = 'none';
            dom.examUIWrapper.style.display = 'flex';
            dom.body.classList.add('exam-active');
            updateSidebarPosition();
            const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
            const topicStats = JSON.parse(localStorage.getItem('topicStats'));
            showResultScreen(breakdown, topicStats);
        } else {
            window.addEventListener('online', validateStartConditions);
            window.addEventListener('offline', validateStartConditions);
            validateStartConditions(); 
        }
        
        const phone = "918658567727";
        const message = "I need the password for the mock test.";
        dom.whatsappLink.href = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(message)}`;
        
        dom.loginBtn.addEventListener('click', handleLogin);
        dom.startExamBtn.addEventListener('click', startExam);
        dom.agreementCheckbox.addEventListener('change', validateStartConditions);

        dom.btnSaveNext.addEventListener('click', handleSaveAndNext);
        dom.btnPrevQuestion.addEventListener('click', () => { if(state.current > 0 && !isTestCompleted) loadQuestion(state.current - 1); });
        dom.btnMarkReview.addEventListener('click', handleMarkAndNext);
        dom.btnClearResponse.addEventListener('click', handleClearResponse);
        dom.btnSubmitTest.addEventListener('click', () => submitTest(false));
        dom.sidebarToggle.addEventListener('click', () => dom.body.classList.toggle('sidebar-open'));
        dom.darkModeToggle.addEventListener('change', (e) => {
            toggleDarkMode(e.target.checked);
            localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
        });
        dom.retestButton.addEventListener('click', () => { dom.passwordModal.style.display = 'flex'; });
        dom.reviewAnswersButton.addEventListener('click', showReviewScreen);
        dom.backToResultsBtn.addEventListener('click', () => {
             const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
             const topicStats = JSON.parse(localStorage.getItem('topicStats'));
             showResultScreen(breakdown, topicStats);
        });
        dom.closeModal.addEventListener('click', () => { dom.passwordModal.style.display = 'none'; });
        dom.verifyPasswordButton.addEventListener('click', handleRetest);
        dom.stopwatchPlayPause.addEventListener('click', toggleStopwatch);
        dom.stopwatchReset.addEventListener('click', resetStopwatch);
        dom.showMockTestTab.addEventListener('click', () => setView('mockTest'));
        dom.showAnswerWritingTab.addEventListener('click', () => setView('answerWriting'));

        window.addEventListener('resize', updateSidebarPosition);
    });
  </script>
</body>
</html>
