<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Series - UPSChub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5, #3b82f6); }
        .gradient-text {
            background-image: linear-gradient(to right, #1e3a8a, #3b82f6);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content-enter { animation: scaleIn 0.3s ease-out forwards; }
        .prose-styles h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose-styles strong { font-weight: 600; }
        .prose-styles ul { list-style-type: disc; margin-left: 1.25rem; }
        .prose-styles li { margin-bottom: 0.25rem; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Logged Out State / Initial Loader -->
    <div id="auth-container" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 transition-opacity duration-300 gradient-bg">
        <div class="text-center text-white fade-in">
             <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" class="h-20 w-20 rounded-2xl mx-auto mb-4 shadow-lg">
            <h1 class="text-4xl font-extrabold tracking-tight">Welcome to UPSChub</h1>
            <p class="mt-2 max-w-xl mx-auto text-lg text-indigo-100">Sign in to access the most comprehensive test series for your exam preparation.</p>
            <div id="auth-actions" class="mt-8">
                 <div id="loader" class="flex justify-center items-center h-12">
                    <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
                <button id="signin-btn" class="hidden w-full max-w-xs px-6 py-3 bg-white text-blue-600 font-bold text-lg rounded-lg shadow-md hover:bg-slate-100 transition-transform hover:scale-105 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.956 0 8.644-3.522 8.644-8.781 0-.593-.052-1.148-.142-1.701z"></path></svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content (Visible when logged in) -->
    <div id="main-content" class="hidden">
        <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-40">
            <!-- ... header content ... -->
        </header>

        <main class="container mx-auto p-4 sm:p-6">
            <!-- Search and Sort controls will be injected here -->
        </main>
    </div>
    
    <!-- Premium Modal -->
    <div id="upgrade-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="upgrade-modal-content" class="bg-white rounded-2xl shadow-lg w-full max-w-md modal-content-enter">
            <!-- Modal Content will be injected here -->
        </div>
    </div>

    <!-- NEW: AI Summary Modal -->
    <div id="ai-summary-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl modal-content-enter relative">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    ✨ AI-Generated Summary
                </h3>
                <button id="close-ai-modal" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="ai-loader" class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="text-slate-500">Generating summary with Gemini... Please wait.</p>
                </div>
                <div id="ai-summary-text" class="prose-styles"></div>
            </div>
            <div class="p-4 bg-slate-50 rounded-b-2xl text-right">
                 <button id="close-ai-modal-footer" class="px-4 py-2 text-sm font-semibold rounded-lg bg-slate-200 hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", authDomain: "upscstudyhub-github.firebaseapp.com", projectId: "upscstudyhub-github", storageBucket: "upscstudyhub-github.firebasestorage.app", messagingSenderId: "451692540885", appId: "1:451692540885:web:b425e85128e5de97c7c35c" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const loader = document.getElementById('loader');
        const signinBtn = document.getElementById('signin-btn');
        let allTests = [];
        let isPremiumUser = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, `users`, user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    isPremiumUser = docSnap.data().isPremium || false;
                } else {
                    await setDoc(userDocRef, { email: user.email, isPremium: false }, { merge: true });
                    isPremiumUser = false;
                }
                authContainer.classList.add('opacity-0', 'pointer-events-none');
                mainContent.classList.remove('hidden');
                await fetchAllTests();
                setupUI();
            } else {
                loader.classList.add('hidden');
                signinBtn.classList.remove('hidden');
            }
        });

        signinBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));

        async function fetchAllTests() {
            try {
                const querySnapshot = await getDocs(collection(db, "quizzes"));
                allTests = [];
                querySnapshot.forEach((doc) => allTests.push({ id: doc.id, ...doc.data() }));
            } catch (error) { console.error("Error fetching tests: ", error); }
        }
        
        function setupUI() {
            // ... (setupUI function remains largely the same)
        }
        
        function renderTests() {
             const container = document.getElementById('test-list-container');
             // ... (sorting and filtering logic here)
             
             // Inside the loop that generates test card HTML:
             const testCardHTML = `
                <div class="bg-white rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col">
                    <div class="p-6 flex-grow">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full bg-slate-100 text-slate-600">${test.subject || 'General'}</span>
                        <h3 class="text-xl font-bold text-slate-800 mt-2">${test.testName}</h3>
                        <div class="mt-4 flex justify-between text-sm text-slate-500 border-t border-slate-100 pt-3">
                            <span>${test.totalQuestions || 0} Questions</span>
                            <span>${test.durationMinutes || 0} Minutes</span>
                        </div>
                    </div>
                    <div class="bg-slate-50/70 p-4 border-t border-slate-200/60 rounded-b-xl flex items-center justify-between gap-2">
                        ${isPremiumUser 
                            ? `<button data-topic="${test.testName}" class="ai-summary-btn text-sm font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1.5 p-2 rounded-md hover:bg-blue-100 transition-colors">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                ✨ Summarize
                               </button>
                               <a href="TestSeries/test_sample.html?testId=${test.id}" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">Start Test &rarr;</a>`
                            : `<button disabled title="Available for Premium users" class="text-sm font-semibold text-slate-400 cursor-not-allowed flex items-center gap-1.5 p-2 rounded-md">
                                 <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                ✨ Summarize
                               </button>
                                <button data-testid="${test.id}" class="unlock-btn px-4 py-2 text-sm font-semibold rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors flex items-center gap-1.5">
                                 <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                                Unlock
                               </button>`
                        }
                    </div>
                </div>`;
             // ...
        }

        function showUpgradeModal() { /* ... */ }

        // --- NEW: Gemini API Function ---
        async function getAiSummary(topicName) {
            const aiSummaryModal = document.getElementById('ai-summary-modal');
            const aiLoader = document.getElementById('ai-loader');
            const aiSummaryText = document.getElementById('ai-summary-text');

            aiSummaryModal.classList.remove('hidden');
            aiLoader.classList.remove('hidden');
            aiSummaryText.innerHTML = '';

            const systemPrompt = `You are an expert tutor for the Indian UPSC civil services exam. Your goal is to provide a concise, well-structured summary of the key concepts related to a given topic. Focus on the most important points, facts, and articles of the constitution that are highly relevant for the exam. Use markdown for formatting, including headings, bold text, and bullet points for clarity.`;
            const userQuery = `Please provide a summary for the topic: "${topicName}"`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let htmlText = candidate.content.parts[0].text
                        .replace(/## (.*)/g, '<h2>$1</h2>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/^\* (.*)/gm, '<ul><li>$1</li></ul>')
                        .replace(/<\/ul>\n<ul>/g, '') // Merge consecutive lists
                        .replace(/\n/g, '<br>');
                    aiSummaryText.innerHTML = htmlText;
                } else {
                    aiSummaryText.innerHTML = '<p class="text-red-500">Could not generate a summary. The AI response was empty.</p>';
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                aiSummaryText.innerHTML = `<p class="text-red-500">An error occurred while fetching the summary.</p>`;
            } finally {
                aiLoader.classList.add('hidden');
            }
        }

        // --- NEW: Event listeners for modals ---
        const upgradeModal = document.getElementById('upgrade-modal');
        const aiSummaryModal = document.getElementById('ai-summary-modal');
        
        document.addEventListener('click', (e) => {
            // AI Summary button
            if (e.target.closest('.ai-summary-btn')) {
                getAiSummary(e.target.closest('.ai-summary-btn').dataset.topic);
            }
            // Unlock button
            if (e.target.closest('.unlock-btn')) {
                showUpgradeModal();
            }
            // Close AI modal
            if (e.target.id === 'close-ai-modal' || e.target.id === 'close-ai-modal-footer') {
                aiSummaryModal.classList.add('hidden');
            }
        });

    </script>
</body>
</html>

