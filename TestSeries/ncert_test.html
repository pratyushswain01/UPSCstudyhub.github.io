<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCERT Chapter-wise Tests - UPSChub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .gradient-text {
            background-image: linear-gradient(to right, #1e3a8a, #3b82f6);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content-enter { animation: scaleIn 0.3s ease-out forwards; }
        
        /* New styles for the ed-tech layout */
        .subject-section {
            margin-bottom: 3rem; /* 48px */
        }
        .subject-header {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #1e293b; /* slate-800 */
            border-bottom: 2px solid #e2e8f0; /* slate-200 */
            padding-bottom: 0.75rem; /* 12px */
            margin-bottom: 1.5rem; /* 24px */
        }
        .subject-icon {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 0.5rem; /* 8px */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chapter-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem; /* 12px */
        }
        .chapter-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            padding: 1rem 1.5rem; /* 16px 24px */
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease-in-out;
        }
        .chapter-card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-color: #cbd5e1; /* slate-300 */
        }
        .chapter-info {
            display: flex;
            align-items: center;
            gap: 1rem; /* 16px */
        }
        .chapter-icon {
            flex-shrink: 0;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            background-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
        }
        .chapter-title {
            font-weight: 600;
            color: #334155; /* slate-700 */
        }
        .chapter-subtitle {
            font-size: 0.875rem; /* 14px */
            color: #64748b; /* slate-500 */
        }
        .chapter-action .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.5rem 1rem; /* 8px 16px */
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s;
        }
        .btn-start {
            background-color: #2563eb; /* blue-600 */
            color: #ffffff;
        }
        .btn-start:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .btn-unlock {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
        .btn-unlock:hover {
            background-color: #e2e8f0; /* slate-200 */
        }

    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="page-loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-white">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loader-text" class="mt-2 text-slate-500">Authenticating...</p>
        </div>
    </div>

    <div id="main-content" class="hidden flex flex-col min-h-screen">
        <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-40">
             <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                 <a href="#" class="flex items-center gap-3 text-2xl font-bold text-blue-600">
                     <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" class="h-9 w-9 rounded-lg">
                     <span>UPSChub</span>
                 </a>
                 <a href="#" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200">Dashboard</a>
             </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 flex-grow">
            <div class="text-center mb-10">
                 <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight gradient-text">NCERT Chapter-wise Tests</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">Master every subject, one chapter at a time. Select a subject to begin your practice.</p>
            </div>
            
            <div id="subjects-container" class="max-w-4xl mx-auto">
                 </div>

        </main>

        <footer class="bg-slate-800 text-slate-400 mt-16 py-8">
            <div class="container mx-auto px-4 sm:px-6 text-center">
                <p class="text-sm">&copy; 2025 UPSChub. All Rights Reserved.</p>
                <p class="text-xs mt-3 max-w-2xl mx-auto">
                    <strong class="text-slate-300">WARNING:</strong> This content is protected by copyright law. Unauthorized reproduction, distribution, or sharing of this material, in whole or in part, is strictly prohibited and may result in legal action.
                </p>
            </div>
        </footer>
    </div>
    
    <div id="upgrade-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="upgrade-modal-content" class="bg-white rounded-2xl shadow-lg w-full max-w-md modal-content-enter"></div>
    </div>

    <div id="ai-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl modal-content-enter relative flex flex-col">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    ✨ AI Study Tool
                </h3>
                <button id="close-ai-modal" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto" id="ai-modal-body">
                </div>
            <div class="p-4 bg-slate-50 rounded-b-2xl text-right border-t border-slate-200 flex-shrink-0">
                 <button id="close-ai-modal-footer" class="px-4 py-2 text-sm font-semibold rounded-lg bg-slate-200 hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", authDomain: "upscstudyhub-github.firebaseapp.com", projectId: "upscstudyhub-github", storageBucket: "upscstudyhub-github.firebasestorage.app", messagingSenderId: "451692540885", appId: "1:451692540885:web:b425e85128e5de97c7c35c" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const pageLoader = document.getElementById('page-loader');
        const mainContent = document.getElementById('main-content');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let isPremiumUser = false;
        // Removed: currentTopic, generatedQuestions as AI button is removed from card

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    document.getElementById('loader-text').textContent = 'Fetching user data...';
                    
                    const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                    const docSnap = await getDoc(userDocRef);
                    
                    if (docSnap.exists()) {
                        isPremiumUser = docSnap.data().isPremium || false;
                    } else {
                        await setDoc(userDocRef, { email: user.email, isPremium: false }, { merge: true });
                        isPremiumUser = false;
                    }
                    
                    // *** MODIFIED: Call the new function ***
                    document.getElementById('loader-text').textContent = 'Loading NCERT tests...';
                    await fetchAndRenderTestsFromNcertTests();
                    
                    if (!isPremiumUser) {
                        const fixedUpgradeButton = `<button id="fixed-upgrade-btn" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-40 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-full shadow-lg hover:shadow-xl hover:scale-105 transform-gpu transition-all flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Go Premium</button>`;
                        document.body.insertAdjacentHTML('beforeend', fixedUpgradeButton);
                    }

                    pageLoader.classList.add('hidden');
                    mainContent.classList.remove('hidden');

                } catch (error) {
                    console.error("Authentication or data fetching failed:", error);
                    pageLoader.innerHTML = `<div class="text-center text-red-500 p-4">
                        <p class="font-semibold">Could not load page data.</p>
                        <p class="text-sm mt-1">There might be a connection issue or a problem with your account. Please refresh and try again.</p>
                    </div>`;
                }
            } else {
                window.location.href = 'auth.html';
            }
        });

        /**
         * NEW FUNCTION: Fetches all tests from the 'ncertTests' collection
         * and groups them by their 'subject' field.
         */
        async function fetchAndRenderTestsFromNcertTests() {
            const container = document.getElementById('subjects-container');
            if (!container) return;

            let tests = [];
            try {
                // 1. Fetch ALL documents from 'ncertTests'
                const q = query(collection(db, "ncertTests"));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => tests.push({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error fetching ncertTests: ", error);
                container.innerHTML = `<p class="text-red-500 text-center">Could not load tests. Check Firestore rules for 'ncertTests'.</p>`;
                return;
            }

            if (tests.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center">No tests are available in the 'ncertTests' collection yet.</p>`;
                return;
            }

            // 2. Group the tests by their 'subject' field in JavaScript
            const subjectsMap = new Map();
            tests.forEach(test => {
                // Use the 'subject' field from your document, or "Uncategorized" if it's missing
                const subjectName = test.subject || "Uncategorized"; 
                
                if (!subjectsMap.has(subjectName)) {
                    subjectsMap.set(subjectName, []);
                }
                subjectsMap.get(subjectName).push(test);
            });

            // 3. Render the HTML
            let allHtml = '';
            
            // Sort subjects alphabetically
            const sortedSubjectNames = [...subjectsMap.keys()].sort();

            for (const subjectName of sortedSubjectNames) {
                const subjectTests = subjectsMap.get(subjectName);
                
                // Default icon and color
                const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18c-2.305 0-4.408.867-6 2.292m0-14.25v14.25" /></svg>`;
                const iconColor = 'bg-blue-100 text-blue-700';

                allHtml += `
                    <section class="subject-section">
                        <h2 class="subject-header">
                            <span class="subject-icon ${iconColor}">
                                ${iconSvg}
                            </span>
                            ${subjectName}
                        </h2>
                        <div class="chapter-list">
                `;

                // Sort tests by title (e.g., "Chapter 1" before "Chapter 2")
                subjectTests.sort((a, b) => (a.title || '').localeCompare(b.title || ''));

                subjectTests.forEach((test, index) => {
                    const isLocked = (test.isPremium || false) && !isPremiumUser;
                    const testId = test.id; // This is the document ID (e.g., 'ncert_polity_ch1')
                    const chapterTitle = test.title || 'Untitled Test'; // This is the 'title' field from your doc

                    allHtml += `
                        <div class="chapter-card">
                            <div class="chapter-info">
                                <div class="chapter-icon">
                                    ${String(index + 1).padStart(2, '0')}
                                </div>
                                <div>
                                    <h3 class="chapter-title">${chapterTitle}</h3>
                                    <p class="chapter-subtitle">NCERT Chapter Test</p>
                                </div>
                            </div>
                            <div class="chapter-action">
                                ${isLocked ? `
                                    <button data-testid="${testId}" class="unlock-btn btn btn-unlock">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                                        Unlock
                                    </button>
                                ` : `
                                    <a href="testncert_page.html?testId=${testId}" class="btn btn-start">
                                        Start Test
                                        <svg class="w-4 h-4 -mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" /></svg>
                                    </a>
                                `}
                            </div>
                        </div>
                    `;
                });
                
                allHtml += '</div></section>'; // Close chapter-list and subject-section
            }
            
            container.innerHTML = allHtml;
        }


        /**
         * Shows the "Go Premium" modal
         */
        function showUpgradeModal() {
            const modal = document.getElementById('upgrade-modal');
            const modalContent = document.getElementById('upgrade-modal-content');
            modalContent.innerHTML = `
                <div class="p-6 text-center bg-gradient-to-br from-blue-100 to-indigo-200 rounded-t-2xl">
                    <div class="w-16 h-16 mx-auto bg-blue-600/10 rounded-full flex items-center justify-center"><svg class="w-10 h-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <h3 class="text-2xl font-bold mt-4 text-slate-800">Go Premium!</h3>
                    <p class="text-slate-500 mt-1">Unlock your full potential with lifetime access.</p>
                </div>
                <div class="p-6"><ul class="space-y-3 text-slate-700">
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>Access to <span class="font-semibold">All Test Series</span></span></li>
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>AI-Powered <span class="font-semibold">Study Tools</span></span></li>
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>Detailed <span class="font-semibold">Performance Analytics</span></span></li>
                </ul></div>
                <div class="p-4 bg-slate-50 rounded-b-2xl flex flex-col sm:flex-row justify-end gap-3">
                    <button type="button" class="close-modal-btn px-4 py-2.5 text-sm font-semibold rounded-lg bg-slate-200/80 hover:bg-slate-200 transition-colors">Maybe Later</button>
                    <button type="button" id="upgrade-btn-modal" class="px-6 py-2.5 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 shadow-md">Upgrade Now <span class="line-through opacity-70 ml-1">₹199</span> <span class="ml-1 font-bold">₹99</span></button>
                </div>`;
            modal.classList.remove('hidden');
        }

        /**
         * Handles the Razorpay payment flow
         */
        async function handleUpgrade() {
            const user = auth.currentUser;
            if (!user) { console.error("No user to upgrade."); return; }
            var options = {
                "key": "rzp_test_YourKey", "amount": 9900, "currency": "INR", "name": "UPSChub",
                "description": "UPSChub Lifetime Premium Access",
                "handler": async function (response){
                    const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                    await updateDoc(userDocRef, { isPremium: true });
                    window.location.reload();
                },
                "prefill": { "email": user.email }, "theme": { "color": "#2563EB" }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        }

        // Global click listener for modals and buttons
        document.addEventListener('click', (e) => {
            const target = e.target;
            // Check for unlock button or fixed upgrade button
            if (target.closest('.unlock-btn') || target.closest('#fixed-upgrade-btn')) {
                showUpgradeModal();
            }
            // Check for modal close buttons
            else if (target.id === 'close-ai-modal' || target.id === 'close-ai-modal-footer') {
                document.getElementById('ai-modal').classList.add('hidden');
            }
            else if (target.closest('.close-modal-btn')) {
                document.getElementById('upgrade-modal').classList.add('hidden');
            }
            // Check for the modal upgrade button
            else if (target.id === 'upgrade-btn-modal') {
                handleUpgrade();
            }
        });
    </script>
</body>
</html>
