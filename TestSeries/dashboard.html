<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Series Dashboard - UPSChub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <base href="https://pratyushswain01.github.io/UPSCstudyhub.github.io/">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .footer-nav a.active { color: #2563EB; transform: scale(1.1); }
        .footer-nav a { transition: color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .tab-active { background-color: #3B82F6; color: white; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        .confetti-piece {
            position: absolute; width: 10px; height: 20px; border-radius: 50%;
            opacity: 0; animation: fall 5s linear infinite;
        }
        .toggle-checkbox:checked + .toggle-label { background-color: #3B82F6; }
        .toggle-checkbox { transition: transform 0.2s ease-in-out; }
        .toggle-checkbox:checked { transform: translateX(1rem); }
        .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .faq-question.open + .faq-answer { max-height: 200px; }
        .faq-question .icon { transition: transform 0.3s ease-in-out; }
        .faq-question.open .icon { transform: rotate(180deg); }
        .calendar-day.has-activity { background-color: #bfdbfe; color: #1e40af; border-radius: 50%; font-weight: bold; }
        .calendar-day.selected-day { background-color: #3b82f6; color: white; border-radius: 50%; }
    </style>
    <script>
      tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app-view" class="hidden">
        <header class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button id="sidebar-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <a href="dashboard.html" class="flex items-center gap-2 text-2xl font-bold text-blue-600 dark:text-blue-500">
                        <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" class="h-8 w-8 rounded-lg">
                        <span>UPSChub</span>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <button id="streak-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            <svg class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0122 12c0 3-1 6-3.5 6-1.667 0-2.5-1.5-2.5-3s1-2.5 2.5-2.5c1.105 0 2.14.44 2.899 1.157" /></svg>
                        </button>
                        <div id="streak-tooltip" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl p-3 z-20 text-sm">
                            <p><strong>Current Streak:</strong> <span id="current-streak">0</span> days</p>
                            <p><strong>Highest Streak:</strong> <span id="highest-streak">0</span> days</p>
                            <p><strong>Today's Tests:</strong> <span id="today-tests">0</span></p>
                            <p class="text-xs text-slate-500 mt-2">Complete 2 tests to extend your streak!</p>
                        </div>
                    </div>
                    <button id="calendar-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg class="h-6 w-6 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                    <div id="account-info-div" class="relative">
                        <button id="account-btn" class="w-9 h-9 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-slate-500 dark:text-slate-400"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="account-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-xl py-2 z-20">
                            <div class="px-4 py-2 border-b dark:border-slate-700">
                                <p class="font-semibold text-sm" id="dropdown-display-name">UPSC Aspirant</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 truncate" id="user-email-display"></p>
                            </div>
                            <div class="py-1">
                                <a href="#" id="dropdown-profile-btn" class="block w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">My Profile</a>
                                <a href="#" id="dropdown-settings-btn" class="block w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">Settings</a>
                                <div class="p-2">
                                    <div class="p-2 flex items-center justify-between rounded-lg bg-slate-100 dark:bg-slate-700/50">
                                        <span class="text-sm font-medium">Dark Mode</span>
                                        <div class="relative inline-block w-10 align-middle select-none">
                                            <input type="checkbox" id="dropdown-theme-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                            <label for="dropdown-theme-toggle" class="toggle-label block overflow:hidden h-6 rounded-full bg-gray-300 dark:bg-slate-600 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-t border-slate-200 dark:border-slate-700"></div>
                            <a href="#" id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="premium-banner" class="hidden bg-amber-100 dark:bg-amber-900/50 p-3 z-10">
            <div class="container mx-auto text-center">
                <p class="text-sm font-semibold text-amber-800 dark:text-amber-200">
                    <span class="font-bold">Upgrade to Premium</span> to unlock all features and your full performance analysis.
                    <button id="upgrade-btn-banner" class="ml-2 underline font-bold">Upgrade Now</button>
                </p>
            </div>
        </div>
        
        <div class="relative min-h-screen">
             <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>
             <aside id="sidebar" class="fixed top-0 left-0 h-full bg-white dark:bg-slate-800 shadow-lg w-64 transform -translate-x-full transition-transform duration-300 ease-in-out z-40 pt-20">
                 <nav class="p-4">
                     <ul class="space-y-2">
                         <li><a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Planner</a></li>
                         <li><a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6a2 2 0 100-4 2 2 0 000 4zm0 12a2 2 0 100-4 2 2 0 000 4zm0 0V10m0 10a9 9 0 110-18 9 9 0 010 18z" /></svg> Browse</a></li>
                         <li><a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> Test Series</a></li>
                         <li><a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Doubts</a></li>
                         <li><a href="#" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg> Analysis</a></li>
                     </ul>
                 </nav>
             </aside>

            <main id="main-content" class="flex-1 transition-all duration-300 ease-in-out">
                <div class="container mx-auto p-4 sm:p-6 pb-24">
                    <div id="home-view">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 dark:from-blue-800 dark:to-indigo-900 p-6 rounded-2xl shadow-lg text-white">
                                    <h1 id="welcome-heading" class="text-3xl font-bold">Welcome back!</h1>
                                    <p class="mt-1 opacity-80">Here's your performance summary. Keep up the great work!</p>
                                </div>
                                
                                <div id="locked-content-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                                    <div class="relative">
                                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm flex items-center gap-4">
                                            <div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                                            <div><p class="text-sm text-slate-500 dark:text-slate-400">Accuracy</p><p id="accuracy-value" class="text-lg font-bold">--%</p></div>
                                        </div>
                                        <div class="lock-overlay"></div>
                                    </div>
                                    <div class="relative">
                                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm flex items-center gap-4">
                                            <div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></div>
                                            <div><p class="text-sm text-slate-500 dark:text-slate-400">Tests Taken</p><p id="tests-taken-value" class="text-lg font-bold">--</p></div>
                                        </div>
                                        <div class="lock-overlay"></div>
                                    </div>
                                    <div class="relative">
                                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm flex items-center gap-4">
                                            <div class="bg-amber-100 dark:bg-amber-900/50 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7l6 6-6 6" /></svg></div>
                                            <div><p class="text-sm text-slate-500 dark:text-slate-400">Avg. Score</p><p id="avg-score-value" class="text-lg font-bold">--</p></div>
                                        </div>
                                        <div class="lock-overlay"></div>
                                    </div>
                                    <div class="relative">
                                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm flex items-center gap-4">
                                            <div class="bg-indigo-100 dark:bg-indigo-900/50 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21M9 17.25v-10.5a2.25 2.25 0 00-2.25-2.25H4.5M9 17.25H5.63c.09-.44.18-1.04.26-1.723A1.875 1.875 0 003.75 14.25H2.25c-.621 0-1.125-.504-1.125-1.125v-1.5c0-.621.504-1.125 1.125-1.125H3.75m9 6.75v-1.007a3 3 0 00.879-2.122L16.5 21m-6.75-3.75h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H16.5m-6.75 12.75v-10.5a2.25 2.25 0 012.25-2.25H12" /></svg></div>
                                            <div><p class="text-sm text-slate-500 dark:text-slate-400">Best Subject</p><p id="best-subject-value" class="text-lg font-bold">--</p></div>
                                        </div>
                                        <div class="lock-overlay"></div>
                                    </div>
                                </div>
                                
                                <div class="relative">
                                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                                        <h3 class="text-lg font-bold mb-4">Performance Overview</h3>
                                        <div>
                                            <canvas id="performanceChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="lock-overlay"></div>
                                </div>

                                <div class="relative">
                                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                                        <h3 class="text-lg font-bold mb-4">Recent Test Results</h3>
                                        <div id="recent-tests-container" class="space-y-4">
                                            </div>
                                    </div>
                                    <div class="lock-overlay"></div>
                                </div>
                            </div>

                            <div class="lg:col-span-1 space-y-6">
                               <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm sticky top-24">
                                   <h3 id="activity-date-heading" class="text-lg font-bold mb-4">Today's Schedule</h3>
                                   <div id="dashboard-activity-timeline" class="relative space-y-8 before:absolute before:inset-0 before:ml-5 before:h-full before:w-0.5 before:bg-slate-200 dark:before:bg-slate-700">
                                       </div>
                               </div>
                            </div>
                        </div>
                    </div>

                    <div id="notifications-view" class="hidden">
                         <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">Notifications</h1>
                         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm divide-y divide-slate-200 dark:divide-slate-700">
                             </div>
                    </div>

                    <div id="settings-view" class="hidden">
                        </div>
                    
                    <div class="text-center mt-8 pt-8 border-t border-slate-200 dark:border-slate-700">
                        <p class="text-sm text-slate-500 dark:text-slate-400">© 2025 UPSChub. All Rights Reserved.</p>
                   </div>
                </div>
            </main>
        </div>
        
        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-[0_-2px_5px_-1px_rgba(0,0,0,0.1)] z-50">
            </footer>
    </div>
    
    <div id="upgrade-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg w-full max-w-md transform transition-all scale-95 opacity-0" id="upgrade-modal-content">
            <div class="p-6 text-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-800 dark:to-slate-900 rounded-t-2xl">
                <svg class="w-12 h-12 mx-auto text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                <h3 class="text-2xl font-bold mt-3">Go Premium!</h3>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Unlock your full potential with lifetime access.</p>
            </div>
            <div class="p-6">
                <ul class="space-y-3 text-slate-700 dark:text-slate-300">
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Access to <span class="font-semibold">All Test Series</span></span></li>
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Detailed <span class="font-semibold">Performance Analytics</span></span></li>
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Unlimited <span class="font-semibold">Practice Questions</span></span></li>
                    <li class="flex items-center gap-3"><svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Priority <span class="font-semibold">Support</span></span></li>
                </ul>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-b-2xl flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" id="close-upgrade-modal" class="px-4 py-2.5 text-sm font-semibold rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">Maybe Later</button>
                <button type="button" id="upgrade-btn-modal" class="px-6 py-2.5 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700">Upgrade Now (₹99)</button>
            </div>
        </div>
    </div>
    
    <div id="success-animation-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center modal-backdrop">
       </div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updateProfile, reauthenticateWithCredential, EmailAuthProvider, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, deleteDoc, getDoc, setDoc, collection, query, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", authDomain: "upscstudyhub-github.firebaseapp.com", projectId: "upscstudyhub-github", storageBucket: "upscstudyhub-github.firebasestorage.app", messagingSenderId: "451692540885", appId: "1:451692540885:web:b425e85128e5de97c7c35c" };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- ELEMENT SELECTORS (includes new and modified ones) ---
    const premiumBanner = document.getElementById('premium-banner');
    const upgradeModal = document.getElementById('upgrade-modal');
    const upgradeModalContent = document.getElementById('upgrade-modal-content');
    const closeUpgradeModalBtn = document.getElementById('close-upgrade-modal');
    const upgradeBtnModal = document.getElementById('upgrade-btn-modal');
    const lockedContentContainer = document.getElementById('locked-content-container');
    const allLockOverlays = document.querySelectorAll('.lock-overlay');
    // ... all other element selectors from your previous code
    
    // --- HELPER FUNCTIONS ---
    function showAlert(message) { /* ... */ }
    
    function showUpgradeModal() {
        upgradeModal.classList.remove('hidden');
        setTimeout(() => {
            upgradeModalContent.classList.remove('scale-95', 'opacity-0');
            upgradeModalContent.classList.add('scale-100', 'opacity-100');
        }, 50);
    }
    
    function hideUpgradeModal() {
        upgradeModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            upgradeModal.classList.add('hidden');
        }, 200);
    }

    // --- SIDEBAR LOGIC ---
    // ... (same as your previous code)

    // --- AUTHENTICATION & REAL-TIME DATA ---
    onAuthStateChanged(auth, user => {
        if (user) {
            // ... (initial user setup logic)

            const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    // ... (update display name, welcome heading, etc.)
                    
                    // CORE LOGIC for showing/hiding premium features
                    updateUIAccessControl(userData.isPremium);
                    
                    // ... (update streak, activity, preferences)
                } else {
                    // ... (create new user document logic)
                }
            });
        } else { 
            window.location.href = 'TestSeries/auth.html'; 
        }
    });
    
    // --- PROFILE, PASSWORD, & OTHER SETTINGS LOGIC ---
    // ... (same as your previous code)

    // --- SUBSCRIPTION & PAYMENT LOGIC (UPDATED) ---
    function updateUIAccessControl(isPremium) {
        // Template for the lock overlay content
        const lockOverlayHTML = `
            <div class="absolute inset-0 z-20 bg-slate-200/50 dark:bg-slate-800/60 backdrop-blur-sm rounded-xl flex items-center justify-center cursor-pointer group">
                <div class="text-center p-4">
                    <svg class="w-8 h-8 mx-auto text-slate-500 dark:text-slate-400 group-hover:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    <p class="text-xs font-bold mt-1 text-slate-600 dark:text-slate-300 group-hover:text-blue-600 transition-colors">Upgrade to Unlock</p>
                </div>
            </div>`;

        if (isPremium) {
            // --- PREMIUM USER: Full access ---
            premiumBanner.classList.add('hidden');
            allLockOverlays.forEach(overlay => overlay.innerHTML = ''); // Remove lock content
            
            subscriptionItem.innerHTML = `<div class="flex items-center gap-4"><svg class="h-6 w-6 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg><div><p class="font-semibold">Premium Member</p><p class="text-sm text-slate-500">Lifetime Access</p></div></div><span class="text-sm font-semibold text-green-600">Active</span>`;
        
        } else {
            // --- FREE USER: Locked access ---
            premiumBanner.classList.remove('hidden');
            allLockOverlays.forEach(overlay => overlay.innerHTML = lockOverlayHTML); // Add lock content
            
            subscriptionItem.innerHTML = `<button id="open-upgrade-modal-trigger" class="w-full text-left flex items-center justify-between"><div class="flex items-center gap-4"><svg class="h-6 w-6 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg><div><p class="font-semibold">Free Member</p><p class="text-sm text-slate-500">Upgrade for full access</p></div></div><svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>`;
            document.getElementById('open-upgrade-modal-trigger').addEventListener('click', showUpgradeModal);
        }
    }

    function handleUpgrade() {
        const user = auth.currentUser; if (!user) return;
        var options = { "key": "rzp_test_YourKey", "amount": 9900, "currency": "INR", "name": "UPSChub", "description": "UPSChub Lifetime Access", "handler": function (response){ const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid); updateDoc(userDocRef, { isPremium: true }).then(() => showSuccessAnimation()); }, "prefill": { "email": user.email }, "theme": { "color": "#2563EB" } };
        var rzp1 = new Razorpay(options); rzp1.open();
    }
    
    // Wire up upgrade buttons
    document.getElementById('upgrade-btn-banner').addEventListener('click', showUpgradeModal);
    upgradeBtnModal.addEventListener('click', () => {
        hideUpgradeModal();
        handleUpgrade();
    });
    closeUpgradeModalBtn.addEventListener('click', hideUpgradeModal);

    // Add event listener to the parent container for all locked sections
    lockedContentContainer.addEventListener('click', (e) => {
        // If the user is free and clicks on a lock overlay, show the modal
        if (auth.currentUser && e.target.closest('.lock-overlay')) {
             const userDocRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
             getDoc(userDocRef).then(docSnap => {
                 if (docSnap.exists() && !docSnap.data().isPremium) {
                     showUpgradeModal();
                 }
             });
        }
    });

    // --- (All other functions like showSuccessAnimation, streak logic, data logic, calendar, etc. remain the same) ---

</script>
</body>
</html>
