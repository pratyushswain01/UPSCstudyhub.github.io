<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Hub - Doubts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        body.dark #loader {
            background-color: #0f172a; /* dark:bg-slate-900 */
            color: #cbd5e1; /* dark:text-slate-300 */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
    <div id="root">
        <div id="loader">Loading Dashboard...</div>
    </div>

    <!-- React and Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase v8 (namespaced) SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Main React Application code, now using Babel -->
    <script type="text/babel" data-presets="react">
        // De-structure React hooks
        const { useState, useEffect } = React;

        // --- FIREBASE CONFIGURATION (FROM CANVAS) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "DEFAULT_KEY", authDomain: "DEFAULT_DOMAIN", projectId: "DEFAULT_PROJECT" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const ADMIN_UID = "eIVSLAoiYUPWpmoXwoB7FGGDLq93"; // Your Admin UID

        // --- Initialize Firebase (v8 Syntax) ---
        let auth, db, serverTimestamp;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;
            // Note: setLogLevel is not as straightforward in v8
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            document.getElementById('loader').innerText = "Error initializing. Please refresh.";
        }

        // --- Modal Component (to replace alert/confirm) ---
        const Modal = ({ show, title, message, onConfirm, onCancel, confirmText, cancelText, type }) => {
            if (!show) return null;

            const confirmColor = type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                        <h3 className="text-lg font-medium text-gray-900 dark:text-slate-100">{title}</h3>
                        <p className="text-sm text-gray-600 dark:text-slate-300 mt-2">{message}</p>
                        <div className="mt-6 space-y-2">
                            {onConfirm && (
                                <button onClick={onConfirm} className={`w-full text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 ${confirmColor}`}>
                                    {confirmText || 'Confirm'}
                                </button>
                            )}
                            {onCancel && (
                                <button onClick={onCancel} className="w-full bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-800 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg shadow-sm transition-all duration-200">
                                    {cancelText || 'Cancel'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- DoubtCard Component ---
        const DoubtCard = ({ doubt, isAdmin, handleAnswerSubmit, handleDeleteDoubt }) => {
            const [answer, setAnswer] = useState('');
            const [isAnswering, setIsAnswering] = useState(false);
            const date = doubt.timestamp?.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const onAnswerSubmit = (e) => {
                e.preventDefault();
                setIsAnswering(true);
                handleAnswerSubmit(doubt.id, answer).finally(() => {
                    setIsAnswering(false);
                    setAnswer('');
                });
            };
            
            return (
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg mb-4 border dark:border-slate-700">
                    <div className="p-6">
                        <div className="flex justify-between items-start">
                            <p className="text-gray-500 dark:text-slate-400 text-sm mb-3">Asked by {doubt.askedByName} on {date || '...'}</p>
                            {isAdmin && (
                                <button 
                                    onClick={() => handleDeleteDoubt(doubt.id, doubt.question)}
                                    className="text-sm text-red-500 hover:text-red-700 font-medium"
                                >
                                    Delete
                                </button>
                            )}
                        </div>
                        <p className="text-slate-800 dark:text-slate-200 text-lg leading-relaxed mb-4">{doubt.question}</p>
                        {doubt.isAnswered ? (
                            <div className="mt-4 p-4 bg-blue-50 dark:bg-slate-700/50 border-l-4 border-blue-500 rounded-r-lg">
                                <h4 className="font-bold text-blue-800 dark:text-blue-300 mb-2">Admin's Answer:</h4>
                                <p className="text-gray-700 dark:text-slate-300 whitespace-pre-wrap">{doubt.answer}</p>
                            </div>
                        ) : isAdmin ? (
                            <form onSubmit={onAnswerSubmit} className="mt-4">
                                <textarea value={answer} onChange={(e) => setAnswer(e.target.value)} placeholder="Write your answer here..." className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" />
                                <button type="submit" disabled={isAnswering} className="mt-2 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300">{isAnswering ? 'Submitting...' : 'Submit Answer'}</button>
                            </form>
                        ) : (
                            <div className="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/40 border-l-4 border-yellow-400 rounded-r-lg">
                                <p className="text-yellow-800 dark:text-yellow-300 font-medium">Waiting for an answer from the admin.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- DoubtsView Component ---
        const DoubtsView = ({
            upscSubjects, selectedChapter, setSelectedChapter, doubts,
            newDoubt, setNewDoubt, handleDoubtSubmit, isSubmittingDoubt,
            doubtError, isAdmin, handleAnswerSubmit, handleDeleteDoubt, handleClearAnswered
        }) => (
            <div className="flex flex-col gap-8">
                
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
                    <h2 className="text-xl font-bold mb-4 border-b dark:border-slate-600 pb-3">Subjects</h2>
                    <ul className="flex flex-wrap gap-2">
                        {upscSubjects.map(chapter => (
                            <li key={chapter}>
                                <button 
                                    onClick={() => setSelectedChapter(chapter)} 
                                    className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                                        selectedChapter === chapter 
                                        ? 'bg-blue-600 text-white shadow-sm' 
                                        : 'bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600'
                                    }`}
                                >
                                    {chapter}
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>

                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
                    <h2 className="text-xl font-bold mb-4">Ask a Doubt in <span className="text-blue-600">{selectedChapter}</span></h2>
                    <form onSubmit={handleDoubtSubmit}>
                        <textarea 
                            value={newDoubt} 
                            onChange={(e) => setNewDoubt(e.target.value)} 
                            placeholder="Type your question here..." 
                            className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" 
                            rows="4"
                        ></textarea>
                        {doubtError && <p className="text-red-500 text-sm mb-3">{doubtError}</p>}
                        <button 
                            type="submit" 
                            disabled={isSubmittingDoubt} 
                            className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300"
                        >
                            {isSubmittingDoubt ? 'Submitting...' : 'Submit Your Doubt'}
                        </button>
                    </form>
                </div>

                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Recent Doubts</h2>
                        {isAdmin && (
                            <button
                                onClick={() => handleClearAnswered(selectedChapter)}
                                className="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors"
                            >
                                Clear All Answered
                            </button>
                        )}
                    </div>
                    {doubts.length > 0 ? (
                        doubts.map(doubt => 
                            <DoubtCard 
                                key={doubt.id} 
                                doubt={doubt} 
                                isAdmin={isAdmin}
                                handleAnswerSubmit={handleAnswerSubmit}
                                handleDeleteDoubt={handleDeleteDoubt} 
                            />
                        )
                    ) : (
                        <div className="text-center py-10 px-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
                            <p className="text-gray-500 dark:text-slate-400">No doubts have been asked in this chapter yet.</p>
                        </div>
                    )}
                </div>
            </div>
        );

        // --- Main App Component (v8 Firebase) ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState({});
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);

            const upscSubjects = [
                "Indian Polity", "History - Ancient India", "History - Medieval India",
                "History - Modern India", "Geography", "Economics", "Environment and Ecology",
                "Science and Technology", "Current Affairs", "CSAT",
            ];
            const [selectedChapter, setSelectedChapter] = useState(upscSubjects[0]);
            const [doubts, setDoubts] = useState([]);
            const [newDoubt, setNewDoubt] = useState('');
            const [isSubmittingDoubt, setIsSubmittingDoubt] = useState(false);
            const [doubtError, setDoubtError] = useState(null);

            // Modal state
            const [modal, setModal] = useState({ show: false, title: '', message: '', onConfirm: null, onCancel: null, type: 'info' });

            // --- Auth Effect (v8) ---
            useEffect(() => {
                if (!auth || !db) {
                     // Firebase not initialized, probably.
                    setLoading(false);
                    return;
                }

                // Use in-memory persistence
                auth.setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(() => {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        if (currentUser) {
                            setUser(currentUser);
                            setIsAdmin(currentUser.uid === ADMIN_UID);
                            
                            const userDocRef = db.collection(`artifacts/${appId}/users`).doc(currentUser.uid);
                            const docSnap = await userDocRef.get();
                            
                            if (docSnap.exists) {
                                setUserData(docSnap.data());
                            } else {
                                const newUserProfile = {
                                    displayName: currentUser.displayName || 'UPSC Aspirant',
                                    email: currentUser.email,
                                    createdAt: serverTimestamp(),
                                    isPremium: false,
                                };
                                await userDocRef.set(newUserProfile);
                                setUserData(newUserProfile);
                            }
                            setLoading(false);
                        } else {
                            setUser(null);
                            setIsAdmin(false);
                            setLoading(false);
                        }
                    });

                    // Sign in
                    (async () => {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (err) {
                            console.error("Auth Error:", err);
                            setLoading(false);
                        }
                    })();

                    return () => unsubscribe();
                })
                .catch((err) => {
                    console.error("Set persistence error:", err);
                    setLoading(false); // Make sure we stop loading even if persistence fails
                });

            }, [auth, db]); // Dependencies are still auth and db

            // --- Doubts Listener Effect (v8) ---
            useEffect(() => {
                if (!selectedChapter || !db) return;
                
                setDoubtError(null);
                setDoubts([]); 
                
                const doubtsCollectionRef = db.collection("doubts");
                const q = doubtsCollectionRef.where("chapter", "==", selectedChapter).orderBy("timestamp", "desc");
                
                const unsubscribe = q.onSnapshot((snapshot) => {
                    setDoubts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => {
                    console.error("Error fetching doubts:", err);
                    setDoubtError(`Could not fetch doubts: ${err.message}. You may need to create a Firestore index.`);
                });
                return () => unsubscribe();
            }, [selectedChapter, db]);

            // --- Firestore Actions (v8) ---
            const handleDoubtSubmit = async (e) => {
                e.preventDefault();
                if (newDoubt.trim() === '' || !user) {
                    setDoubtError("Doubt cannot be empty."); return;
                }
                setIsSubmittingDoubt(true); setDoubtError(null);
                try {
                    await db.collection("doubts").add({
                        chapter: selectedChapter,
                        question: newDoubt,
                        askedBy: user.uid,
                        askedByName: userData.displayName || 'Aspirant',
                        isAnswered: false,
                        answer: "",
                        timestamp: serverTimestamp(),
                    });
                    setNewDoubt('');
                } catch (err) {
                    console.error("Error submitting doubt:", err); 
                    setDoubtError(`Failed to submit: ${err.message}`); 
                } finally {
                    setIsSubmittingDoubt(false);
                }
            };

            const handleAnswerSubmit = async (doubtId, answerText) => {
                if (!isAdmin || answerText.trim() === '') return;
                try {
                    const docRef = db.collection("doubts").doc(doubtId);
                    await docRef.update({
                        answer: answerText,
                        isAnswered: true,
                        answeredTimestamp: serverTimestamp()
                    });
                } catch (err) { console.error("Error submitting answer:", err); }
            };

            const handleDeleteDoubt = (doubtId, question) => {
                if (!isAdmin) return;
                setModal({
                    show: true,
                    title: 'Delete Doubt',
                    message: `Are you sure you want to delete this doubt: "${question.substring(0, 50)}..."?`,
                    onConfirm: async () => {
                        try {
                            await db.collection("doubts").doc(doubtId).delete();
                        } catch (err) {
                            console.error("Error deleting doubt: ", err);
                            setDoubtError(`Failed to delete doubt: ${err.message}`);
                        }
                        setModal({ show: false });
                    },
                    onCancel: () => setModal({ show: false }),
                    type: 'danger',
                    confirmText: 'Yes, Delete'
                });
            };

            const handleClearAnswered = (chapter) => {
                if (!isAdmin) return;
                setModal({
                    show: true,
                    title: 'Clear Answered Doubts',
                    message: `Are you sure you want to delete all ANSWERED doubts in ${chapter}?`,
                    onConfirm: async () => {
                        setModal({ show: false });
                        try {
                            const q = db.collection("doubts")
                                .where("chapter", "==", chapter)
                                .where("isAnswered", "==", true);
                            
                            const querySnapshot = await q.get();
                            
                            if (querySnapshot.empty) {
                                console.log("No answered doubts to clear.");
                                return;
                            }

                            const batch = db.batch();
                            querySnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });

                            await batch.commit();
                            console.log(`Successfully cleared ${querySnapshot.size} answered doubts.`);

                        } catch (err) {
                            console.error("Error clearing answered doubts: ", err);
                            setDoubtError(`Failed to clear doubts: ${err.message}. You may need a new Firestore index.`);
                        }
                    },
                    onCancel: () => setModal({ show: false }),
                    type: 'danger',
                    confirmText: 'Yes, Clear All'
                });
            };
            
            // Render loading state manually
            if (loading) {
                // We return null, so the static loader in the HTML is shown
                // But ReactDOM.render will *replace* the loader.
                // So let's render the loader from React as well.
                return (
                    <div id="loader" className="dark:bg-slate-900">
                        Loading Dashboard...
                    </div>
                );
            }

            if (!user) return (
                <div className="flex items-center justify-center h-screen text-center p-8">
                    <div>
                        <h2 className="text-2xl font-bold mb-4">Please Log In</h2>
                        <p className="text-slate-600">You must be logged in to access the UPSChub dashboard.</p>
                    </div>
                </div>
            );

            return (
                <React.Fragment>
                    <Modal {...modal} />
                    <div className="min-h-screen text-slate-800 dark:text-slate-200">
                        <header className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
                            <div className="container mx-auto max-w-7xl px-4 sm:px-6 py-3 flex justify-between items-center">
                                <a href="#" className="flex items-center gap-2 text-xl sm:text-2xl font-bold">
                                    <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" className="h-9 w-9 rounded-lg"/>
                                    <span className="text-slate-800 dark:text-slate-200">UPSChub Doubts</span>
                                </a>
                                
                                <div className="flex items-center gap-2 sm:gap-4">
                                    <a 
                                        href="...TestSeries/dashboard.html" 
                                        className="px-3 py-2 sm:px-4 bg-blue-600 text-white text-xs sm:text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors"
                                    >
                                        Test Planner
                                    </a>
                                    {isAdmin && <span className="px-3 py-1 bg-green-100 text-green-800 text-sm font-bold rounded-full hidden sm:block">Admin Mode</span>}
                                    <span className="text-slate-700 dark:text-slate-300 font-medium hidden md:block">
                                        Welcome, {userData.displayName || 'Aspirant'}
                                    </span>
                                </div>
                            </div>
                        </header>

                        <main className="container mx-auto max-w-7xl p-4 sm:p-6">
                            <DoubtsView 
                                upscSubjects={upscSubjects}
                                selectedChapter={selectedChapter}
                                setSelectedChapter={setSelectedChapter}
                                doubts={doubts}
                                newDoubt={newDoubt}
                                setNewDoubt={setNewDoubt}
                                handleDoubtSubmit={handleDoubtSubmit}
                                isSubmittingDoubt={isSubmittingDoubt}
                                doubtError={doubtError}
                                isAdmin={isAdmin}
                                handleAnswerSubmit={handleAnswerSubmit}
                                handleDeleteDoubt={handleDeleteDoubt}
                                handleClearAnswered={handleClearAnswered}
                            />
                        </main>
                    </div>
                </React.Fragment>
            );
        };

        // Initial Render
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

