<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
<!-- ... existing code ... -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
<!-- ... existing code ... -->
        .dark .contact-admin-text a { color: #8ab4f8; }
         @media (max-width: 768px) {
/* ... existing code ... */
            .sidebar-open .question-area { padding-right: 20px; }
        }
        @media (max-width: 480px) {
/* ... existing code ... */
            .btn-action span { display: none; }
        }

        /* --- NEW STYLES FOR CHAPTER SELECTION --- */
        #chapterSelectionWrapper {
            display: none; /* Hidden by default */
            padding: 20px;
            max-width: 1000px;
            margin: 20px auto;
        }
        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .chapter-button {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px 25px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }
        .chapter-button:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        .chapter-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f9f9f9;
        }
        .chapter-button h3 {
            font-size: 1.15em;
            font-weight: 600;
            color: #3f51b5;
        }
        .chapter-button .status-completed {
            font-size: 0.9em;
            font-weight: 600;
            color: #4caf50;
            margin-top: 10px;
        }
        .dark .chapter-button {
            background: #2a2a3a;
            border-color: #444;
        }
        .dark .chapter-button h3 {
            color: #8ab4f8;
        }
        .dark .chapter-button:disabled {
            background-color: #242434;
        }
        .dark .chapter-button .status-completed {
            color: #81c784;
        }
        /* --- END OF NEW STYLES --- */

    </style>
</head>
<body>

    <div id="loginScreen" class="pre-exam-screen" style="display: flex;">
<!-- ... existing code ... -->
    </div>

    <div id="instructionsScreen" class="pre-exam-screen">
        <div class="instructions-container">
<!-- ... existing code ... -->
        </div>
    </div>

    <!-- *** NEW: Chapter Selection Screen *** -->
    <div id="chapterSelectionWrapper">
        <!-- This will be filled by JavaScript -->
    </div>
    <!-- *** END: Chapter Selection Screen *** -->


    <div id="examUIWrapper">
        <header class="site-header" id="siteHeader">
<!-- ... existing code ... -->
            <div class="site-copyright">Copyright Â© 2025 Pratyush Swain</div>
        </header>
        <header class="topbar" id="topbar">
<!-- ... existing code ... -->
            <div class="topbar-right-group">
                <div class="dark-mode-toggle">
<!-- ... existing code ... -->
                <button id="btnSubmitTest" style="display: none;"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
        </header>
        <div class="main-content">
            <div id="mockTestWrapper" style="display: flex; width: 100%;">
                <section class="question-area">
                    <h2 class="question-header" id="questionNumber"></h2>
<!-- ... existing code ... -->
                </section>
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-content">
<!-- ... existing code ... -->
                    </div>
                </aside>
            </div>
            <div id="resultScreenWrapper">
                <h2>Test Completed!</h2>
<!-- ... existing code ... -->
                <div class="scorecard-details">
                    <table class="scorecard-table">
<!-- ... existing code ... -->
                    </table>
                </div>
                <!-- *** MODIFIED: This div is now a placeholder *** -->
                <div class="result-buttons" id="resultButtonsContainer">
                    <!-- Buttons will be added here by JavaScript -->
                </div>
                <div class="performance-analysis-container">
<!-- ... existing code ... -->
            </div>
            <div id="reviewScreenWrapper">
                <div class="review-header"><h2 class="review-title">Review Your Answers</h2><button id="backToResultsBtn" class="submit-button btn-action"><i class="fas fa-arrow-left"></i> Back to Score</button></div>
<!-- ... existing code ... -->
            </div>
            <div id="answerWritingWrapper">
                <h2>Answer Writing Practice</h2>
<!-- ... existing code ... -->
            </div>
        </div>
        <div class="fixed-action-area" id="mcqFooter">
<!-- ... existing code ... -->
        </div>
    </div>
    <div id="passwordModal" class="password-modal">
<!-- ... existing code ... -->
    </div>

<script>
// ### CONFIGURATION ###
// ... existing code ...
const PER_QUESTION_TIME = 15;

// =====================================================================
// ============ START: FIREBASE CONFIGURATION ==========================
// ... existing code ...
const appId = 'default-app-id';
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

try {
// ... existing code ...
    console.error("Error enabling persistence:", e);
}
// =====================================================================
// ============= END: FIREBASE CONFIGURATION ===========================
// =====================================================================

// ### GLOBAL STATE & DOM ELEMENTS ###
let questions = [];
let testMetadata = {};
let state = {};
// ... existing code ...
let stopwatchTime = 0;
let isStopwatchRunning = false;
let currentUser = null;

// --- NEW GLOBAL STATE ---
let isWeeklyTest = false;       // Is this a weekly test container?
let weeklySubTests = [];      // Array of sub-tests
let completedSubTests = new Set(); // Tracks completed sub-tests
let currentSubQuizId = null;  // The ID of the sub-test currently being taken
let weeklyTestTitle = '';     // Title of the main weekly test
// --- END NEW GLOBAL STATE ---
  
const dom = {
    body: document.body,
// ... existing code ...
    loginScreen: document.getElementById('loginScreen'),
    loginBtn: document.getElementById('loginBtn'),
// ... existing code ...
    loginError: document.getElementById('loginError'),
    instructionsScreen: document.getElementById('instructionsScreen'),
// ... existing code ...
    startError: document.getElementById('startError'),
    totalQuestionsEl: document.getElementById('totalQuestionsEl'),
// ... existing code ...
    instructionsTitle: document.getElementById('instructions-title'),
    examUIWrapper: document.getElementById('examUIWrapper'),
    siteHeader: document.getElementById('siteHeader'),
// ... existing code ...
    topbar: document.getElementById('topbar'),
    sidebar: document.getElementById('sidebar'),
    mockTestWrapper: document.getElementById('mockTestWrapper'),
// ... existing code ...
    mcqFooter: document.getElementById('mcqFooter'),
    questionArea: document.querySelector('.question-area'), // Added this selector
    questionText: document.getElementById('questionText'),
    questionNumber: document.getElementById('questionNumber'),
// ... existing code ...
    summaryNotVisited: document.getElementById('summaryNotVisited'),
    resultScreenWrapper: document.getElementById('resultScreenWrapper'),
    resultButtonsContainer: document.getElementById('resultButtonsContainer'), // Added this
    reviewScreenWrapper: document.getElementById('reviewScreenWrapper'),
    performanceTableBody: document.getElementById('performanceTableBody'),
// ... existing code ...
    reviewContainer: document.getElementById('reviewContainer'),
    // Removed retestButton, reviewAnswersButton (will be handled by event delegation)
    backToResultsBtn: document.getElementById('backToResultsBtn'),
    passwordModal: document.getElementById('passwordModal'),
// ... existing code ...
    syncStatus: document.getElementById('syncStatus'),
    chapterSelectionWrapper: document.getElementById('chapterSelectionWrapper'), // Added this
};

// ### STAGE 1 & 2: PRE-EXAM LOGIC ###

function handleLogin() {
// ... existing code ...
}
  
function validateStartConditions() {
// ... existing code ...
}

function startExam() {
    if (dom.startExamBtn.disabled) return;
    dom.instructionsScreen.style.display = 'none';
    dom.examUIWrapper.style.display = 'flex';
    dom.body.classList.add('exam-active');
    updateSidebarPosition();
    window.removeEventListener('online', validateStartConditions);
    window.removeEventListener('offline', validateStartConditions);
    window.addEventListener('online', forceSubmitOnReconnect);
    initTest();
}

function forceSubmitOnReconnect() {
// ... existing code ...
}


// *** MODIFIED: This function now checks if it's a Weekly Test or Single Test ***
async function loadTestFromURL(testId) {
    dom.loginScreen.style.display = 'none';
    dom.instructionsScreen.style.display = 'none';
    dom.examUIWrapper.style.display = 'none';
    dom.instructionsTitle.textContent = 'Loading Test...';

    try {
        // 1. Check if it's a WEEKLY TEST
        const weeklyTestRef = db.collection('weeklyTests').doc(testId);
        const weeklyTestDoc = await weeklyTestRef.get();

        if (weeklyTestDoc.exists && weeklyTestDoc.data().subTests) {
            console.log("Loading as Weekly Test Container");
            isWeeklyTest = true;
            weeklyTestTitle = weeklyTestDoc.data().title;
            weeklySubTests = weeklyTestDoc.data().subTests;
            
            // Show the chapter screen immediately (no main instructions)
            showChapterSelectionScreen();
            
            // Show premium button if not premium (logic moved here)
            // Note: You need to fetch isPremiumUser from auth state, assuming it's done in onAuthStateChanged
            // For this to work, make sure isPremiumUser is set before this runs.
            /*
            if (!isPremiumUser) {
                const fixedUpgradeButton = `<button id="fixed-upgrade-btn" ...>Go Premium</button>`;
                document.body.insertAdjacentHTML('beforeend', fixedUpgradeButton);
            }
            */
            
        } else {
            // 2. It's a NORMAL SINGLE TEST (original logic)
            console.log("Loading as Single Test");
            isWeeklyTest = false;
            await loadSingleTest(testId);
        }
    } catch (error) {
        console.error("Failed to load test:", error);
        handleLoadError(error);
    }
}

// *** NEW: This is the original logic moved into its own function ***
async function loadSingleTest(testId) {
    dom.instructionsScreen.style.display = 'flex';
    dom.instructionsTitle.textContent = 'Loading Test Details...';

    const testDocRef = db.collection('quizzes').doc(testId);
    const testDoc = await testDocRef.get();
    if (!testDoc.exists) throw new Error("Test not found.");
    testMetadata = testDoc.data();

    const questionsSnapshot = await testDocRef.collection('questions').get();
    questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (questions.length === 0) throw new Error("This test has no questions.");

    dom.instructionsTitle.textContent = `${testMetadata.testName} - Instructions`;
    dom.totalQuestionsEl.textContent = testMetadata.totalQuestions;
    dom.durationEl.innerHTML = `Total Duration: <strong>${testMetadata.durationMinutes} Minutes</strong>.`;
    
    timeLeft = testMetadata.durationMinutes * 60;
    dom.timer.textContent = formatTime(timeLeft);
    
    window.addEventListener('online', validateStartConditions);
    window.addEventListener('offline', validateStartConditions);
    validateStartConditions();
}

// *** NEW: Shows the 5 chapter buttons ***
function showChapterSelectionScreen() {
    const chapterWrapper = dom.chapterSelectionWrapper;
    
    let html = `<h2 class="text-3xl font-bold dark:text-white mb-8 text-center">${weeklyTestTitle}</h2>`;
    html += `<div class="chapter-grid">`;

    weeklySubTests.forEach(subTest => {
        const isCompleted = completedSubTests.has(subTest.quizId);
        html += `
            <button ${isCompleted ? 'disabled' : ''} onclick="startSubTest('${subTest.quizId}', '${subTest.name}')" class="chapter-button">
                <div>
                    <h3>${subTest.name}</h3>
                </div>
                ${isCompleted ? '<span class="status-completed"><i class="fas fa-check-circle"></i> Completed</span>' : ''}
            </button>
        `;
    });

    html += `</div>`;
    chapterWrapper.innerHTML = html;
    
    // Show the chapter screen, hide everything else
    chapterWrapper.style.display = 'block';
    dom.loginScreen.style.display = 'none';
    dom.instructionsScreen.style.display = 'none';
    dom.examUIWrapper.style.display = 'none';
}

// *** NEW: Called when a chapter button is clicked ***
async function startSubTest(subQuizId, subQuizName) {
    currentSubQuizId = subQuizId; // Set the global for saving results
    
    // Hide chapter screen, show instructions
    dom.chapterSelectionWrapper.style.display = 'none';
    dom.instructionsScreen.style.display = 'flex';
    dom.instructionsTitle.textContent = `Loading ${subQuizName}...`;

    try {
        // Load this sub-test's data
        const testDocRef = db.collection('quizzes').doc(subQuizId);
        const testDoc = await testDocRef.get();
        if (!testDoc.exists) throw new Error(`Test not found: ${subQuizId}`);
        testMetadata = testDoc.data();

        const questionsSnapshot = await testDocRef.collection('questions').get();
        questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (questions.length === 0) throw new Error("This test has no questions.");

        // Populate instructions
        dom.instructionsTitle.textContent = `${subQuizName} - Instructions`;
        dom.totalQuestionsEl.textContent = testMetadata.totalQuestions || questions.length;
        dom.durationEl.innerHTML = `Total Duration: <strong>${testMetadata.durationMinutes} Minutes</strong>.`;
        
        timeLeft = testMetadata.durationMinutes * 60;
        dom.timer.textContent = formatTime(timeLeft);
        
        // Add offline listeners
        window.addEventListener('online', validateStartConditions);
        window.addEventListener('offline', validateStartConditions);
        validateStartConditions();

    } catch (error) {
        console.error("Failed to load sub-test:", error);
        handleLoadError(error);
    }
}

function handleLoadError(error) {
     document.body.innerHTML = `<div class="pre-exam-screen" style="display:flex;"><div class="login-card"><h2>Error</h2><p>Could not load question data. Missing or insufficient permissions.</p><p style="font-size:0.8em; color:#666; margin-top:10px;">${error.message}</p><a href="#" onclick="window.location.reload()" class="btn-primary" style="text-decoration: none; margin-top: 20px;">Try Again</a></div></div>`;
}

// =====================================================================
// ============ START: RESULT SAVING LOGIC (UPDATED) ===================
// ... existing code ...
async function saveResultToFirestore(scoreData) {
    const syncStatusEl = dom.syncStatus;
// ... existing code ...
    const userId = currentUser.uid;

    syncStatusEl.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> Saving result... (Will sync when online)`;
// ... existing code ...
    const historyCollectionRef = db.collection("artifacts").doc(appId).collection("users").doc(userId).collection("testHistory");
    
    // *** MODIFIED: Use the sub-quiz ID if it's a weekly test ***
    const testId = new URLSearchParams(window.location.search).get('testId');
    const docId = `${currentSubQuizId || testId}_history_${Date.now()}`;

    // *** MODIFIED: Use the sub-test's metadata ***
    const percentage = scoreData.totalQuestions > 0 ? (scoreData.correctCount / scoreData.totalQuestions) * 100 : 0;

    try {
        await historyCollectionRef.doc(docId).set({
            testId: currentSubQuizId || testId, // Save the actual quiz ID
            testName: testMetadata.testName,     // This will be the sub-test's name
            subject: testMetadata.subject,
            testSet: testMetadata.testSet || 'A',
// ... existing code ...
            percentage: percentage,
            userAnswers: state.answers,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        });
        
        console.log("Result saved to 'testHistory' collection.");
// ... existing code ...
    } catch (error) {
        console.error("Error writing result to Firestore: ", error);
// ... existing code ...
    }
}

// ### All other JavaScript functions remain the same... ###
// ... existing code ...
// =====================================================================

// ### STAGE 3: MAIN TEST LOGIC ###
function initTest() {
    resetState();
// ... existing code ...
    if (state.visited.length > 0) state.visited[0] = true;
    resetStopwatch();
    setView('mockTest');
// ... existing code ...
    startTimer();
}
function resetState() {
// ... existing code ...
}
function setView(viewName) {
    dom.mockTestWrapper.style.display = 'none';
// ... existing code ...
    dom.answerWritingWrapper.style.display = 'none';
    dom.mcqFooter.style.display = 'none';
    dom.sidebar.style.display = 'none';
// ... existing code ...
    dom.showMockTestTab.classList.remove('active');
    dom.showAnswerWritingTab.classList.remove('active');
    clearInterval(animationInterval);
    
    // *** MODIFIED: Handle weekly test chapter view ***
    if (viewName === 'mockTest') {
        dom.showMockTestTab.classList.add('active');
        if (isTestCompleted) {
            // Show result screen (this is fine)
            const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
            const topicStats = JSON.parse(localStorage.getItem('topicStats'));
            showResultScreen(breakdown, topicStats);
        } else if (isWeeklyTest && !currentSubQuizId) {
            // Show chapter selection screen if it's a weekly test and no sub-test is active
            showChapterSelectionScreen();
            dom.examUIWrapper.style.display = 'block'; // Show the wrapper, but not the test parts
            dom.main-content.style.display = 'none'; // Hide the main content (question area, etc.)
        } else {
            // Show normal test UI
            dom.timer.style.display = 'block';
            dom.mockTestWrapper.style.display = 'flex';
            dom.main-content.style.display = 'flex'; // Show main content
            dom.mcqFooter.style.display = 'block';
            dom.sidebar.style.display = 'flex';
        }
    } else if (viewName === 'answerWriting') {
// ... existing code ...
    }
}
function loadQuestion(index) {
    state.current = index;
// ... existing code ...
    startQuestionTimer();
    const q = questions[index];
// ... existing code ...
    dom.btnSubmitTest.style.display = (state.current === questions.length - 1) ? 'flex' : 'none';
    updatePalette();
    updateNavigationButtons();
}
// ... existing code ...
function handleSaveAndNext() {
    if (isTestCompleted) return;
// ... existing code ...
    if (state.current < questions.length - 1) {
        loadQuestion(state.current + 1);
    } else {
        submitTest(true); // This will trigger submit for the sub-test
    }
}
function handleMarkAndNext() {
// ... existing code ...
}
function handleClearResponse() {
// ... existing code ...
}
function submitTest(isForced = false) {
    if (isTestCompleted) return;
// ... existing code ...
    }
    stopTimer();
    isTestCompleted = true; // This marks the SUB-TEST as completed
    window.removeEventListener('online', forceSubmitOnReconnect);
    
    // *** NEW: If it's a weekly test, mark the sub-test as completed ***
    if (isWeeklyTest) {
        completedSubTests.add(currentSubQuizId);
    }
    
    // This part is for the Answer Writing tab, it's fine
    dom.showAnswerWritingTab.classList.remove('locked'); 
    
    const scoreBreakdown = calculateScoreBreakdown();
// ... existing code ...
    localStorage.setItem('topicStats', JSON.stringify(topicStats));
    showResultScreen(scoreBreakdown, topicStats);
}
function calculateScoreBreakdown() {
// ... existing code ...
}
function updatePalette() {
// ... existing code ...
}
function updateNavigationButtons() {
// ... existing code ...
}
function formatTime(totalSeconds) {
// ... existing code ...
}
function startTimer() {
// ... existing code ...
}
function startQuestionTimer() {
// ... existing code ...
}
function stopTimer() {
// ... existing code ...
}
function toggleStopwatch() {
// ... existing code ...
}
function resetStopwatch() {
// ... existing code ...
}
function toggleDarkMode(isDark) {
// ... existing code ...
}
function updateSidebarPosition() {
// ... existing code ...
}

// *** MODIFIED: This function now dynamically adds buttons ***
function showResultScreen(breakdown, topicStats) {
    dom.mockTestWrapper.style.display = 'none';
    dom.reviewScreenWrapper.style.display = 'none';
// ... existing code ...
    dom.sidebar.style.display = 'none';
    dom.btnSubmitTest.style.display = 'none';
    dom.resultScreenWrapper.style.display = 'flex';
    if (breakdown) {
// ... existing code ...
         animateScorecard(breakdown);
    }
    
    // --- Add result buttons dynamically ---
    const resultButtons = dom.resultButtonsContainer;
    resultButtons.innerHTML = ''; // Clear old buttons

    // If it's a weekly test, add "Back to Sections"
    if (isWeeklyTest) {
        resultButtons.innerHTML += `<button id="backToChaptersBtn" class="submit-button btn-action"><i class="fas fa-arrow-left"></i> Back to Sections</button>`;
    }
    
    // Add the standard buttons
    resultButtons.innerHTML += `<button id="retestButton" class="submit-button btn-action"><i class="fas fa-redo"></i> Retest</button>`;
    resultButtons.innerHTML += `<button id="reviewAnswersButton" class="submit-button btn-action"><i class="fas fa-search"></i> Review Answers</button>`;
    // --- End of button logic ---
    
    populatePerformanceTable(topicStats);
    setTimeout(() => renderPerformanceChart(topicStats), 100);
}

function animateScorecard(data) {
// ... existing code ...
}
function calculateTopicStats() {
// ... existing code ...
}
function populatePerformanceTable(topicStats) {
// ... existing code ...
}
function renderPerformanceChart(topicStats) {
// ... existing code ...
}
function showReviewScreen() {
    dom.resultScreenWrapper.style.display = 'none';
// ... existing code ...
}
function populateReviewScreen() {
// ... existing code ...
}
function handleRetest() {
// ... existing code ...
}

// *** MODIFIED: Use event delegation for dynamic buttons ***
document.addEventListener('DOMContentLoaded', () => {
    const storedTheme = localStorage.getItem('theme');
// ... existing code ...
    dom.whatsappLink.href = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(message)}`;
    
    // --- Main Listeners ---
    dom.loginBtn.addEventListener('click', handleLogin);
    dom.startExamBtn.addEventListener('click', startExam);
    dom.agreementCheckbox.addEventListener('change', validateStartConditions);
    dom.btnSaveNext.addEventListener('click', handleSaveAndNext);
    dom.btnPrevQuestion.addEventListener('click', () => { if (state.current > 0 && !isTestCompleted) loadQuestion(state.current - 1); });
    dom.btnMarkReview.addEventListener('click', handleMarkAndNext);
    dom.btnClearResponse.addEventListener('click', handleClearResponse);
    dom.btnSubmitTest.addEventListener('click', () => submitTest(false));
    dom.sidebarToggle.addEventListener('click', () => document.body.classList.toggle('sidebar-open'));
    dom.darkModeToggle.addEventListener('change', (e) => {
// ... existing code ...
        localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
    });
    
    // --- Event Delegation for Dynamic/Modal Buttons ---
    document.addEventListener('click', (e) => {
        if (e.target.id === 'retestButton') {
            dom.passwordModal.style.display = 'flex';
        }
        if (e.target.id === 'reviewAnswersButton') {
            showReviewScreen();
        }
        if (e.target.id === 'backToChaptersBtn') {
            isTestCompleted = false;
            currentSubQuizId = null;
            state = {};
            questions = [];
            dom.resultScreenWrapper.style.display = 'none';
            dom.examUIWrapper.style.display = 'none'; // Hide exam UI
            showChapterSelectionScreen(); // Show chapters
        }
    });

    dom.backToResultsBtn.addEventListener('click', () => {
        const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
        const topicStats = JSON.parse(localStorage.getItem('topicStats'));
        showResultScreen(breakdown, topicStats);
    });
    dom.closeModal.addEventListener('click', () => { dom.passwordModal.style.display = 'none'; });
    dom.verifyPasswordButton.addEventListener('click', handleRetest);
    dom.stopwatchPlayPause.addEventListener('click', toggleStopwatch);
    dom.stopwatchReset.addEventListener('click', resetStopwatch);
    dom.showMockTestTab.addEventListener('click', () => setView('mockTest'));
    dom.showAnswerWritingTab.addEventListener('click', () => setView('answerWriting'));
    window.addEventListener('resize', updateSidebarPosition);

    firebase.auth().onAuthStateChanged(async (user) => {
        currentUser = user;
        const params = new URLSearchParams(window.location.search);
        const testId = params.get('testId');
        const resultId = params.get('resultId');

        if (!testId) {
// ... existing code ...
            return;
        }

        if (user) {
            console.log("Auth state changed: User is signed in.", user.uid);
            if (localStorage.getItem('testTaken') === 'true') {
// ... existing code ...
                await resumeResultSession();
            } else {
                // *** THIS IS THE MAIN STARTING POINT ***
                await loadTestFromURL(testId);
            }
        } else {
// ... existing code ...
        }
    });
});
async function resumeResultSession() {
// ... existing code ...
    updateSidebarPosition();
    
    // *** MODIFIED: Check if we are resuming a weekly test ***
    const params = new URLSearchParams(window.location.search);
    const testId = params.get('testId');
    const weeklyTestRef = db.collection('weeklyTests').doc(testId);
    const weeklyTestDoc = await weeklyTestRef.get();

    if (weeklyTestDoc.exists && weeklyTestDoc.data().subTests) {
        // It's a weekly test. We should show the chapter screen.
        // But the user just finished a sub-test, so show the results.
        isWeeklyTest = true; // Set this flag
        weeklySubTests = weeklyTestDoc.data().subTests; // Load sub-tests
        currentSubQuizId = localStorage.getItem('currentSubQuizId'); // We need to save this
        
        // This logic is tricky. For now, just show results.
        // The "Back to Chapters" button will handle returning.
    }
    
    const breakdown = JSON.parse(localStorage.getItem('scoreBreakdown'));
// ... existing code ...
    showResultScreen(breakdown, topicStats);

    const testDocRef = db.collection('quizzes').doc(currentSubQuizId || testId); // Use sub-quiz ID
    try {
        const questionsSnapshot = await testDocRef.collection('questions').get();
// ... existing code ...
    } catch (error) {
        console.error("Failed to load question data for review:", error);
    }
}
</script>
</body>
</html>
