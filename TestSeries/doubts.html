<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Hub - Doubts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple loader style */
        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a5568;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
    <div id="root">
        <div id="loader">Loading Doubts Portal...</div>
    </div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>


    <script type="text/babel" data-presets="react">
        // --- De-structure React hooks for ease of use ---
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", 
            authDomain: "upscstudyhub-github.firebaseapp.com", 
            projectId: "upscstudyhub-github", 
            storageBucket: "upscstudyhub-github.firebasestorage.app", 
            messagingSenderId: "451692540885", 
            appId: "1:451692540885:web:b425e85128e5de97c7c35c" 
        };

        const ADMIN_UID = "eIVSLAoiYUPWpmoXwoB7FGGDLq93"; // Your Admin UID

        // --- FIXED: Initialize Firebase (v8 Syntax) ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'default-app-id'; // As per original HTML structure

        // --- Main App Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState({});
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);
            const [isSidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 768);

            const upscSubjects = [
                "Indian Polity", "History - Ancient India", "History - Medieval India",
                "History - Modern India", "Geography", "Economics", "Environment and Ecology",
                "Science and Technology", "Current Affairs", "CSAT",
            ];
            const [selectedChapter, setSelectedChapter] = useState(upscSubjects[0]);
            const [doubts, setDoubts] = useState([]);
            const [newDoubt, setNewDoubt] = useState('');
            const [isSubmittingDoubt, setIsSubmittingDoubt] = useState(false);
            const [doubtError, setDoubtError] = useState(null);

            useEffect(() => {
                // FIXED: v8 onAuthStateChanged
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        setIsAdmin(currentUser.uid === ADMIN_UID);
                        
                        // FIXED: v8 db.collection.doc
                        const userDocRef = db.collection(`artifacts/${appId}/users`).doc(currentUser.uid);
                        // FIXED: v8 doc.onSnapshot
                        const unsubSnapshot = userDocRef.onSnapshot((docSnap) => {
                            if (docSnap.exists) {
                                setUserData(docSnap.data());
                            } else {
                                const newUserProfile = {
                                    displayName: currentUser.displayName || 'UPSC Aspirant',
                                    email: currentUser.email,
                                    // FIXED: v8 serverTimestamp
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    isPremium: false,
                                };
                                // FIXED: v8 doc.set
                                userDocRef.set(newUserProfile);
                                setUserData(newUserProfile);
                            }
                            setLoading(false);
                        });
                        return () => unsubSnapshot();
                    } else {
                        setUser(null);
                        setLoading(false);
                        // Redirect to login page if not authenticated
                        // window.location.href = 'TestSeries/auth.html';
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!selectedChapter) return;
                
                // FIXED: v8 db.collection
                const doubtsCollectionRef = db.collection("doubts");
                // FIXED: v8 query chaining
                const q = doubtsCollectionRef.where("chapter", "==", selectedChapter).orderBy("timestamp", "desc");
                
                // FIXED: v8 query.onSnapshot
                const unsubscribe = q.onSnapshot((snapshot) => {
                    setDoubts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => {
                    console.error("Error fetching doubts:", err);
                    setDoubtError("Could not fetch doubts for this chapter.");
                });
                return () => unsubscribe();
            }, [selectedChapter]);


            // FIXED: v8 auth.signOut
            const handleLogout = () => auth.signOut().catch(error => console.error("Logout Error:", error));
            const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);

            const handleDoubtSubmit = async (e) => {
                e.preventDefault();
                if (newDoubt.trim() === '' || !user) {
                    setDoubtError("Doubt cannot be empty."); return;
                }
                setIsSubmittingDoubt(true); setDoubtError(null);
                try {
                    // FIXED: v8 db.collection.add
                    await db.collection("doubts").add({
                        chapter: selectedChapter,
                        question: newDoubt,
                        askedBy: user.uid,
                        askedByName: userData.displayName || 'Aspirant',
                        isAnswered: false,
                        answer: "",
                        // FIXED: v8 serverTimestamp
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setNewDoubt('');
                } catch (err) {
                    setDoubtError("Failed to submit your doubt.");
                } finally {
                    setIsSubmittingDoubt(false);
                }
            };

            const handleAnswerSubmit = async (doubtId, answerText) => {
                if (!isAdmin || answerText.trim() === '') return;
                try {
                    // FIXED: v8 db.collection.doc.update
                    await db.collection("doubts").doc(doubtId).update({
                        answer: answerText,
                        isAnswered: true,
                        // FIXED: v8 serverTimestamp
                        answeredTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) { console.error("Error submitting answer:", err); }
            };
            
            const DoubtCard = ({ doubt }) => {
                const [answer, setAnswer] = useState('');
                const [isAnswering, setIsAnswering] = useState(false);
                const date = doubt.timestamp?.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
                const onAnswerSubmit = (e) => {
                    e.preventDefault();
                    setIsAnswering(true);
                    handleAnswerSubmit(doubt.id, answer).finally(() => {
                        setIsAnswering(false);
                        setAnswer('');
                    });
                };
                return (
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg mb-4 border dark:border-slate-700">
                        <div className="p-6">
                            <p className="text-gray-500 dark:text-slate-400 text-sm mb-3">Asked by {doubt.askedByName} on {date || '...'}</p>
                            <p className="text-slate-800 dark:text-slate-200 text-lg leading-relaxed mb-4">{doubt.question}</p>
                            {doubt.isAnswered ? (
                                <div className="mt-4 p-4 bg-blue-50 dark:bg-slate-700/50 border-l-4 border-blue-500 rounded-r-lg">
                                    <h4 className="font-bold text-blue-800 dark:text-blue-300 mb-2">Admin's Answer:</h4>
                                    <p className="text-gray-700 dark:text-slate-300 whitespace-pre-wrap">{doubt.answer}</p>
                                </div>
                            ) : isAdmin ? (
                                <form onSubmit={onAnswerSubmit} className="mt-4">
                                    <textarea value={answer} onChange={(e) => setAnswer(e.target.value)} placeholder="Write your answer here..." className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" />
                                    <button type="submit" disabled={isAnswering} className="mt-2 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300">{isAnswering ? 'Submitting...' : 'Submit Answer'}</button>
                                </form>
                            ) : (
                                <div className="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/40 border-l-4 border-yellow-400 rounded-r-lg">
                                    <p className="text-yellow-800 dark:text-yellow-300 font-medium">Waiting for an answer from the admin.</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const DoubtsView = () => (
                 <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <aside className="lg:col-span-4 xl:col-span-3"><div className="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 sticky top-24"><h2 className="text-lg font-semibold mb-4 border-b dark:border-slate-600 pb-2">Subjects</h2><ul className="space-y-1">{upscSubjects.map(chapter => (<li key={chapter}><button onClick={() => setSelectedChapter(chapter)} className={`w-full text-left px-4 py-2 rounded-lg transition-colors text-sm font-medium ${selectedChapter === chapter ? 'bg-blue-600 text-white shadow-sm' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>{chapter}</button></li>))}</ul></div></aside>
                    <div className="lg:col-span-8 xl:col-span-9">
                        <div className="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700"><h2 className="text-xl font-bold mb-4">Ask a Doubt in <span className="text-blue-600">{selectedChapter}</span></h2><form onSubmit={handleDoubtSubmit}><textarea value={newDoubt} onChange={(e) => setNewDoubt(e.target.value)} placeholder="Type your question here..." className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4" rows="4"></textarea>{doubtError && <p className="text-red-500 text-sm mb-3">{doubtError}</p>}<button type="submit" disabled={isSubmittingDoubt} className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300">{isSubmittingDoubt ? 'Submitting...' : 'Submit Your Doubt'}</button></form></div>
                        <div>
                            <h2 className="text-xl font-bold mb-4">Recent Doubts</h2>
                            {doubts.length > 0 ? (doubts.map(doubt => <DoubtCard key={doubt.id} doubt={doubt} />)) : (<div className="text-center py-10 px-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700"><p className="text-gray-500 dark:text-slate-400">No doubts have been asked in this chapter yet.</p></div>)}
                        </div>
                    </div>
                </div>
            );
            
            if (loading) return null; // Root loader is already showing
            if (!user) return <div className="text-center p-8">Please log in to access the dashboard.</div>;

            // --- Main render return, simplified ---
            return (
                <div className="min-h-screen text-slate-800 dark:text-slate-200">
                    <header className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
                        <div className="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <button onClick={toggleSidebar} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 md:hidden">
                                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                </button>
                                <a href="#" className="flex items-center gap-2 text-2xl font-bold text-blue-600 dark:text-blue-500">
                                    <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" className="h-8 w-8 rounded-lg"/>
                                    <span>UPSChub Doubts</span>
                                </a>
                            </div>
                            <div className="flex items-center gap-4">
                                {isAdmin && <span className="px-3 py-1 bg-green-100 text-green-800 text-sm font-bold rounded-full">Admin Mode</span>}
                            </div>
                        </div>
                    </header>
                    <div className="relative min-h-screen md:flex">
                        {/* --- Sidebar now only has Logout --- */}
                        <aside className={`fixed md:relative top-0 left-0 h-full bg-white dark:bg-slate-800 shadow-lg w-64 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 ease-in-out z-40 pt-16 md:pt-4`}>
                            <nav className="p-4">
                                <ul className="space-y-2">
                                    <li>
                                        <span className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300">
                                            Doubts
                                        </span>
                                    </li>
                                    <li>
                                        <button onClick={handleLogout} className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-red-600 dark:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium">
                                            Logout
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </aside>
                        {/* --- Main content area always renders DoubtsView --- */}
                        <main className="flex-1 transition-all duration-300 ease-in-out p-4 sm:p-6">
                            <DoubtsView />
                        </main>
                    </div>
                </div>
            );
        };

        // Render the App component into the #root div
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
