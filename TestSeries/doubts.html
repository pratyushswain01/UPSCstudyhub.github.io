import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut, 
    updateProfile, 
    EmailAuthProvider, 
    reauthenticateWithCredential, 
    updatePassword, 
    deleteUser 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    onSnapshot, 
    updateDoc, 
    getDoc, 
    setDoc, 
    collection, 
    addDoc,
    query, 
    where, 
    serverTimestamp,
    orderBy
} from 'firebase/firestore';
import Chart from 'chart.js/auto';

// --- FIREBASE CONFIGURATION ---
// This configuration is taken from your HTML file.
const firebaseConfig = { 
    apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", 
    authDomain: "upscstudyhub-github.firebaseapp.com", 
    projectId: "upscstudyhub-github", 
    storageBucket: "upscstudyhub-github.firebasestorage.app", 
    messagingSenderId: "451692540885", 
    appId: "1:451692540885:web:b425e85128e5de97c7c35c" 
};

// --- ADMIN CONFIGURATION ---
// IMPORTANT: Replace with the actual UID of your admin user account in Firebase Authentication.
const ADMIN_UID = "REPLACE_WITH_YOUR_ADMIN_UID";

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Main App Component ---
const App = () => {
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState({});
    const [isAdmin, setIsAdmin] = useState(false);
    const [loading, setLoading] = useState(true);
    const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'doubts', 'settings', etc.
    const [isSidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 768);

    // --- State for Doubts Page ---
    const upscSubjects = [
        "Indian Polity", "History - Ancient India", "History - Medieval India",
        "History - Modern India", "Geography", "Economics", "Environment and Ecology",
        "Science and Technology", "Current Affairs", "CSAT",
    ];
    const [selectedChapter, setSelectedChapter] = useState(upscSubjects[0]);
    const [doubts, setDoubts] = useState([]);
    const [newDoubt, setNewDoubt] = useState('');
    const [isSubmittingDoubt, setIsSubmittingDoubt] = useState(false);
    const [doubtError, setDoubtError] = useState(null);

    // Chart.js reference
    const performanceChartRef = useRef(null);
    const chartInstanceRef = useRef(null);

    // --- Authentication & User Data Listener ---
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
                setUser(currentUser);
                setIsAdmin(currentUser.uid === ADMIN_UID);

                const userDocRef = doc(db, `users`, currentUser.uid); // Simplified path for clarity
                const unsubSnapshot = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setUserData(docSnap.data());
                    } else {
                        // Create user profile if it doesn't exist
                        const newUserProfile = {
                            displayName: currentUser.displayName || 'UPSC Aspirant',
                            email: currentUser.email,
                            createdAt: serverTimestamp(),
                            isPremium: false,
                        };
                        setDoc(userDocRef, newUserProfile);
                        setUserData(newUserProfile);
                    }
                });
                 setLoading(false);
                return () => unsubSnapshot();
            } else {
                setUser(null);
                setLoading(false);
                // In a real app, you would redirect to a login page here.
                // For this component, we'll just show a loading/logged out state.
            }
        });
        return () => unsubscribe();
    }, []);

    // --- Real-time Doubts Fetching Effect ---
    useEffect(() => {
        if (currentView !== 'doubts' || !selectedChapter) return;

        const doubtsCollectionRef = collection(db, "doubts");
        const q = query(
            doubtsCollectionRef,
            where("chapter", "==", selectedChapter),
            orderBy("timestamp", "desc")
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedDoubts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setDoubts(fetchedDoubts);
        }, (err) => {
            console.error("Error fetching doubts:", err);
            setDoubtError("Could not fetch doubts for this chapter.");
        });

        return () => unsubscribe();
    }, [currentView, selectedChapter]);

    // --- Chart Rendering Effect ---
    useEffect(() => {
        if (currentView === 'dashboard' && performanceChartRef.current) {
             if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
            const ctx = performanceChartRef.current.getContext('2d');
            chartInstanceRef.current = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], // Mock data
                    datasets: [{
                        label: 'Test Score',
                        data: [65, 59, 80, 81, 56, 55], // Mock data
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }, [currentView]);


    // --- Handlers ---
    const handleLogout = () => {
        signOut(auth).catch(error => console.error("Logout Error:", error));
    };
    
    const toggleSidebar = () => setSidebarOpen(!isSidebarOpen);

    const handleDoubtSubmit = async (e) => {
        e.preventDefault();
        if (newDoubt.trim() === '' || !user) {
            setDoubtError("Doubt cannot be empty.");
            return;
        }
        setIsSubmittingDoubt(true);
        setDoubtError(null);
        try {
            await addDoc(collection(db, "doubts"), {
                chapter: selectedChapter,
                question: newDoubt,
                askedBy: user.uid,
                askedByName: userData.displayName || 'Aspirant',
                isAnswered: false,
                answer: "",
                timestamp: serverTimestamp(),
            });
            setNewDoubt('');
        } catch (err) {
            console.error("Error submitting doubt:", err);
            setDoubtError("Failed to submit your doubt. Please try again.");
        } finally {
            setIsSubmittingDoubt(false);
        }
    };
    
    const handleAnswerSubmit = async (doubtId, answerText) => {
        if (!isAdmin || answerText.trim() === '') return;
        const doubtRef = doc(db, "doubts", doubtId);
        try {
            await updateDoc(doubtRef, {
                answer: answerText,
                isAnswered: true,
                answeredTimestamp: serverTimestamp()
            });
        } catch (err) {
            console.error("Error submitting answer:", err);
        }
    };

    // --- Sub-components ---
    const DoubtCard = ({ doubt }) => {
        const [answer, setAnswer] = useState('');
        const [isAnswering, setIsAnswering] = useState(false);
        const date = doubt.timestamp?.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });

        const onAnswerSubmit = (e) => {
            e.preventDefault();
            setIsAnswering(true);
            handleAnswerSubmit(doubt.id, answer).finally(() => {
                setIsAnswering(false);
                setAnswer('');
            });
        };

        return (
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg mb-4 border dark:border-slate-700">
                <div className="p-6">
                    <p className="text-gray-500 dark:text-slate-400 text-sm mb-3">
                        Asked by {doubt.askedByName} on {date || '...'}
                    </p>
                    <p className="text-slate-800 dark:text-slate-200 text-lg leading-relaxed mb-4">{doubt.question}</p>
                    {doubt.isAnswered ? (
                        <div className="mt-4 p-4 bg-blue-50 dark:bg-slate-700/50 border-l-4 border-blue-500 rounded-r-lg">
                            <h4 className="font-bold text-blue-800 dark:text-blue-300 mb-2">Admin's Answer:</h4>
                            <p className="text-gray-700 dark:text-slate-300 whitespace-pre-wrap">{doubt.answer}</p>
                        </div>
                    ) : isAdmin ? (
                         <form onSubmit={onAnswerSubmit} className="mt-4">
                            <textarea
                                value={answer}
                                onChange={(e) => setAnswer(e.target.value)}
                                placeholder="Write your answer here..."
                                className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                rows="3"
                            />
                            <button type="submit" disabled={isAnswering} className="mt-2 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300">
                                {isAnswering ? 'Submitting...' : 'Submit Answer'}
                            </button>
                        </form>
                    ) : (
                        <div className="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/40 border-l-4 border-yellow-400 rounded-r-lg">
                            <p className="text-yellow-800 dark:text-yellow-300 font-medium">Waiting for an answer from the admin.</p>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const DoubtsView = () => (
         <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <aside className="lg:col-span-4 xl:col-span-3">
                <div className="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 sticky top-24">
                    <h2 className="text-lg font-semibold mb-4 border-b dark:border-slate-600 pb-2">Subjects</h2>
                    <ul className="space-y-1">
                        {upscSubjects.map(chapter => (
                            <li key={chapter}>
                                <button
                                    onClick={() => setSelectedChapter(chapter)}
                                    className={`w-full text-left px-4 py-2 rounded-lg transition-colors text-sm font-medium ${selectedChapter === chapter ? 'bg-blue-600 text-white shadow-sm' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                >
                                    {chapter}
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>
            </aside>
            <div className="lg:col-span-8 xl:col-span-9">
                <div className="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
                     <h2 className="text-xl font-bold mb-4">Ask a Doubt in <span className="text-blue-600">{selectedChapter}</span></h2>
                     <form onSubmit={handleDoubtSubmit}>
                        <textarea
                            value={newDoubt}
                            onChange={(e) => setNewDoubt(e.target.value)}
                            placeholder="Type your question here. Be as specific as possible."
                            className="w-full p-3 border border-gray-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow mb-4"
                            rows="4"
                        ></textarea>
                        {doubtError && <p className="text-red-500 text-sm mb-3">{doubtError}</p>}
                        <button type="submit" disabled={isSubmittingDoubt} className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300">
                            {isSubmittingDoubt ? 'Submitting...' : 'Submit Your Doubt'}
                        </button>
                     </form>
                </div>
                <div>
                     <h2 className="text-xl font-bold mb-4">Recent Doubts</h2>
                     {doubts.length > 0 ? (
                        doubts.map(doubt => <DoubtCard key={doubt.id} doubt={doubt} />)
                     ) : (
                        <div className="text-center py-10 px-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
                            <p className="text-gray-500 dark:text-slate-400">No doubts have been asked in this chapter yet.</p>
                            <p className="text-gray-500 dark:text-slate-400 mt-1">Be the first one to ask!</p>
                        </div>
                     )}
                </div>
            </div>
        </div>
    );

    const DashboardView = () => (
         <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
                 <div id="welcome-banner" className="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                     <h1 className="text-3xl font-bold">Welcome back, {userData.displayName || 'Aspirant'}!</h1>
                     <p className="mt-1 opacity-80">Here's your performance summary. Keep up the great work!</p>
                 </div>
                 <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                     {/* Stat Cards - Data can be wired up later */}
                 </div>
                 <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm">
                     <h3 className="text-lg font-bold mb-4">Performance Overview</h3>
                     <div className="h-64"><canvas ref={performanceChartRef}></canvas></div>
                 </div>
            </div>
             <div className="lg:col-span-1 space-y-6">
                 {/* Right column content like schedule can go here */}
             </div>
        </div>
    );
    
    // --- Main Render ---
    if (loading) {
        return <div className="flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900"><p>Loading Dashboard...</p></div>;
    }
    
    if (!user) {
         return <div className="flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900"><p>Please log in to access the dashboard.</p></div>;
    }

    return (
        <div className="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
             <header className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
                <div className="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <button onClick={toggleSidebar} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 md:hidden">
                            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <a href="#" className="flex items-center gap-2 text-2xl font-bold text-blue-600 dark:text-blue-500">
                            <img src="https://pratyushswain01.github.io/UPSCstudyhub.github.io/images/LOGO.jpg" alt="UPSChub Logo" className="h-8 w-8 rounded-lg"/>
                            <span>UPSChub</span>
                        </a>
                    </div>
                     <div className="flex items-center gap-4">
                        {isAdmin && <span className="px-3 py-1 bg-green-100 text-green-800 text-sm font-bold rounded-full">Admin Mode</span>}
                        {/* Add other header icons and dropdowns here */}
                     </div>
                </div>
            </header>

            <div className="relative min-h-screen flex">
                 <aside className={`fixed md:relative top-0 left-0 h-full bg-white dark:bg-slate-800 shadow-lg w-64 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out z-40 pt-20`}>
                    <nav className="p-4">
                        <ul className="space-y-2">
                            <li><button onClick={() => setCurrentView('dashboard')} className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium">Dashboard</button></li>
                            <li><button onClick={() => setCurrentView('doubts')} className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium">Doubts</button></li>
                            {/* Add other navigation links here */}
                            <li><button onClick={handleLogout} className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-red-600 dark:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium">Logout</button></li>
                        </ul>
                    </nav>
                 </aside>

                 <main className="flex-1 transition-all duration-300 ease-in-out p-4 sm:p-6">
                    {currentView === 'dashboard' && <DashboardView />}
                    {currentView === 'doubts' && <DoubtsView />}
                    {/* Render other views based on state */}
                 </main>
            </div>
        </div>
    );
};

export default App;
