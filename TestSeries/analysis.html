<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analysis - UPSChub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <base href="https://pratyushswain01.github.io/UPSCstudyhub.github.io/">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="dashboard.html" class="flex items-center gap-3 text-2xl font-bold text-blue-600">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="h-9 w-9 rounded-lg">
                <span>UPSChub</span>
            </a>
            <a href="dashboard.html" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200">Go to Dashboard</a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 mb-8 tracking-tight">Chapter-wise Mastery Analysis</h1>
        
        <div id="analysis-container" class="space-y-10">
            <div id="skeleton-loader">
                <div class="space-y-10 animate-pulse">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="h-7 w-1/3 bg-slate-200 rounded-md mb-6"></div>
                        <div class="space-y-5">
                            <div class="flex items-center gap-4">
                                <div class="h-4 flex-1 bg-slate-200 rounded-full"></div>
                                <div class="h-9 w-28 bg-slate-200 rounded-md"></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="h-4 flex-1 bg-slate-200 rounded-full"></div>
                                <div class="h-9 w-28 bg-slate-200 rounded-md"></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="h-4 flex-1 bg-slate-200 rounded-full"></div>
                                <div class="h-9 w-28 bg-slate-200 rounded-md"></div>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="h-7 w-1/4 bg-slate-200 rounded-md mb-6"></div>
                        <div class="space-y-5">
                            <div class="flex items-center gap-4">
                                <div class="h-4 flex-1 bg-slate-200 rounded-full"></div>
                                <div class="h-9 w-28 bg-slate-200 rounded-md"></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="h-4 flex-1 bg-slate-200 rounded-full"></div>
                                <div class="h-9 w-28 bg-slate-200 rounded-md"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loader" class="hidden fixed inset-0 bg-white/50 flex justify-center items-center flex-col">
        <svg class="animate-spin h-8 w-8 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-slate-500">Checking authentication...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", authDomain: "upscstudyhub-github.firebaseapp.com", projectId: "upscstudyhub-github", storageBucket: "upscstudyhub-github.firebasestorage.app", messagingSenderId: "451692540885", appId: "1:451692540885:web:b425e85128e5de97c7c35c" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const loader = document.getElementById('loader');
        const skeletonLoader = document.getElementById('skeleton-loader');
        const analysisContainer = document.getElementById('analysis-container');
        
        // --- MASTER SYLLABUS LIST ---
        // This list defines all chapters that will be displayed on the page.
        const UPSC_SYLLABUS = [
            {
                subject: "Indian Polity",
                chapters: [
                    "Historical Underpinnings & Evolution", "Making of the Constitution", "Preamble of the Constitution", "Union and its Territory", "Citizenship", "Fundamental Rights", "Directive Principles of State Policy", "Fundamental Duties", "Amendment of the Constitution", "Basic Structure of the Constitution", "Parliamentary System", "Federal System", "Centre-State Relations", "Inter-State Relations", "Emergency Provisions", "President", "Vice-President", "Prime Minister", "Central Council of Ministers", "Parliament", "Supreme Court", "Governor", "Chief Minister", "State Council of Ministers", "State Legislature", "High Court", "Panchayati Raj", "Municipalities", "Constitutional Bodies", "Non-Constitutional Bodies"
                ]
            },
            {
                subject: "Modern History",
                chapters: [
                    "Decline of the Mughal Empire", "India in the 18th Century", "Advent of Europeans", "British Conquest of India", "Revolt of 1857", "Socio-Religious Reform Movements", "Indian National Movement (1885-1905)", "Indian National Movement (1905-1916)", "Indian National Movement (1917-1947)", "Governor-Generals and Viceroys"
                ]
            },
            {
                subject: "Geography",
                chapters: [
                    "The Earth and The Universe", "Geomorphology", "Climatology", "Oceanography", "Biogeography", "Indian Geography: Location and Physical Features", "River Systems in India", "Climate of India", "Indian Soils", "Natural Vegetation and Wildlife", "Agriculture in India", "Mineral and Energy Resources", "Industries in India", "Transport and Communication"
                ]
            },
            // Add other subjects like Economy, Environment, etc. here in the same format
        ];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loader.style.display = 'none';
                displayAnalysis(user);
            } else {
                loader.style.display = 'flex';
                // If not logged in, redirect to your authentication page
                window.location.href = 'auth.html'; 
            }
        });

        async function displayAnalysis(user) {
            try {
                // 1. Fetch user's performance data from Firestore
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const docSnap = await getDoc(userDocRef);
                
                let performanceData = {};
                if (docSnap.exists() && docSnap.data().chapterAccuracy) {
                    performanceData = docSnap.data().chapterAccuracy;
                }

                // 2. Hide skeleton and clear the container
                skeletonLoader.style.display = 'none';
                analysisContainer.innerHTML = '';

                // 3. Loop through the master syllabus to render the UI
                UPSC_SYLLABUS.forEach(subjectData => {
                    const subjectContainer = document.createElement('div');
                    subjectContainer.className = 'bg-white p-6 rounded-xl shadow-md';

                    let chaptersHTML = '';
                    subjectData.chapters.forEach(chapterName => {
                        // Get accuracy from fetched data, default to 0 if not found
                        const accuracy = performanceData[subjectData.subject]?.[chapterName] || 0;
                        const barColor = accuracy === 100 ? 'bg-green-500' : 'bg-red-500';

                        chaptersHTML += `
                            <div class="chapter-row py-3 border-b border-slate-100 last:border-b-0">
                                <div class="flex items-center justify-between gap-4 flex-wrap">
                                    <span class="flex-shrink-0 text-slate-700 font-medium w-full sm:w-2/5">${chapterName}</span>
                                    <div class="w-full sm:w-3/5 flex items-center gap-4">
                                        <div class="flex-grow bg-slate-200 rounded-full h-4 relative overflow-hidden">
                                            <div class="progress-bar absolute top-0 left-0 h-full rounded-full ${barColor}" style="width: ${accuracy}%;"></div>
                                            <span class="absolute inset-0 flex items-center justify-center text-xs font-bold ${accuracy > 50 ? 'text-white' : 'text-slate-600'}">${accuracy}%</span>
                                        </div>
                                        <button data-subject="${subjectData.subject}" data-chapter="${chapterName}" class="start-test-btn flex-shrink-0 px-3 py-1.5 text-xs font-semibold rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                            Start Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    subjectContainer.innerHTML = `
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">${subjectData.subject}</h2>
                        <div class="space-y-1">
                            ${chaptersHTML}
                        </div>
                    `;
                    analysisContainer.appendChild(subjectContainer);
                });

                // 4. Add event listeners to all "Start Test" buttons
                document.querySelectorAll('.start-test-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const subject = e.currentTarget.dataset.subject;
                        const chapter = e.currentTarget.dataset.chapter;
                        
                        // Action: You can now use this information to generate a test.
                        // For example, redirect to a test page with URL parameters:
                        // window.location.href = \`test_sample.html?subject=${encodeURIComponent(subject)}&chapter=${encodeURIComponent(chapter)}\`;
                        
                        alert(`Starting a new test for:\\nSubject: ${subject}\\nChapter: ${chapter}`);
                    });
                });

            } catch (error) {
                console.error("Error fetching or displaying analysis:", error);
                analysisContainer.innerHTML = `<p class="text-red-500 text-center">Could not load performance data. Please try again later.</p>`;
            }
        }
    </script>
</body>
</html>
