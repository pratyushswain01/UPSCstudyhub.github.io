<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UPSChub - Exam Portal</title>
    <link rel="icon" type="image/jpg" href="images/LOGO.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body { font-family: 'Poppins', sans-serif; background: #f0f0f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; position: relative; }
        .dark { background: #1e1e2f; color: #eee; }
        body.exam-active::after {
            content: "UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A";
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; font-size: 8vw; font-weight: 700; color: rgba(0, 0, 0, 0.05); text-align: center; line-height: 2; transform-origin: center; transform: rotate(-30deg); z-index: 9999; pointer-events: none; white-space: pre-wrap; overflow: hidden;
        }
       .dark.exam-active::after { color: rgba(255, 255, 255, 0.04); }
       .site-header { position: relative; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; padding: 10px 15px; }
       .site-logo { max-height: 40px; }
       .site-copyright { font-family: "Trebuchet MS", "Segoe UI", Arial, sans-serif; font-size: 10px; font-weight: 600; letter-spacing: 0.8px; white-space: nowrap; transition: color 0.3s ease; }
        body.light-mode.site-copyright { color: rgba(0, 0, 0, 0.6); }
        body.dark-mode.site-copyright { color: rgba(255, 255, 255, 0.7); }
        @media (max-width: 600px) {
         .site-header { flex-direction: column; align-items: center; text-align: center; }
         .site-copyright { margin-top: 5px; position: static; }
        }
      .pre-exam-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100%;
        padding: 20px;
        z-index: 5000;
        position: relative;
        background: #f0f0f5;
        overflow-y: auto;
      }
       .dark.pre-exam-screen { background: #1e1e2f; }
       .login-card,.instructions-container,.submitting-card { background: #ffffff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 100%; text-align: center; }
       .dark.login-card,.dark.instructions-container,.dark.submitting-card { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
       .login-card { max-width: 450px; }
       .submitting-card { max-width: 500px; }
       .login-card h2 { margin-bottom: 25px; color: #3f51b5; font-size: 1.8em; }
       .dark.login-card h2 { color: #8ab4f8; }
       .input-group { margin-bottom: 20px; text-align: left; }
       .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
       .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
       .dark.input-group input { background: #1e1e2f; border-color: #555; color: #eee; }
       .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #3f51b5; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
       .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        #loginError { color: #f44336; height: 1.2em; margin-top: 15px; font-weight: 500; }
        #instructionsScreen { display: none; }
        .instructions-container { max-width: 800px; text-align: left; }
       #instructionsScreen h2 { color: #3f51b5; border-bottom: 2px solid #3f51b5; padding-bottom: 5px; margin-bottom: 15px; margin-top: 25px; }
       #instructionsScreen h2:first-of-type { margin-top: 0; }
        .dark #instructionsScreen h2 { color: #8ab4f8; border-bottom-color: #8ab4f8; }
        .instructions-content {flex-grow: 1;overflow-y: auto;padding-right: 15px;min-height: 0;}
       .instructions-content ul { list-style: none; padding-left: 0; line-height: 1.8; }
       .instructions-content li { display: flex; align-items: flex-start; margin-bottom: 12px; }
       .instructions-content li i { color: #3f51b5; margin-right: 15px; font-size: 1.2em; margin-top: 5px; min-width: 20px; text-align: center; }
       .dark.instructions-content li i { color: #8ab4f8; }
       .instructions-content strong { color: #c62828; }
       .dark.instructions-content strong { color: #ef9a9a; }
       .instructions-footer { padding-top: 20px; border-top: 1px solid #eee; }
       .dark.instructions-footer { border-top-color: #444; }
        #offlineStatus { font-weight: 600; text-align: center; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
       .status-waiting { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
       .status-ready { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
       .agreement-group { display: flex; align-items: center; margin-bottom: 15px; }
        #agreementCheckbox { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
        #agreementCheckbox + label { font-size: 0.9em; cursor: pointer; }
       .btn-start-exam:disabled { background: #9fa8da; cursor: not-allowed; }
       .dark.btn-start-exam:disabled { background: #2c3a7a; }
        #startError { color: #d32f2f; text-align: center; height: 1.2em; font-weight: 500; }
        
        /* === NEW: CHAPTER SELECTION STYLES === */
         #chapterSelectionWrapper {
            display: none; /* Hidden by default */
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            text-align: left;
         }
         #chapterSelectionWrapper h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #3f51b5;
            margin-bottom: 10px;
         }
         .dark #chapterSelectionWrapper h1 {
             color: #8ab4f8;
         }
         #chapterSelectionWrapper p {
             font-size: 1.1em;
             color: #555;
             margin-bottom: 30px;
         }
         .dark #chapterSelectionWrapper p {
             color: #ccc;
         }
         .subject-group h2 {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #3f51b5;
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
         }
         .dark .subject-group h2 {
             color: #eee;
             border-bottom-color: #8ab4f8;
         }
         .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
         }
         .chapter-button {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px 25px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
            text-decoration: none;
         }
         .chapter-button:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
         }
         .chapter-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f9f9f9;
         }
         .chapter-button h3 {
            font-size: 1.15em;
            font-weight: 600;
            color: #3f51b5;
            margin: 0;
         }
         .dark .chapter-button {
            background: #2a2a3a;
            border-color: #444;
         }
         .dark .chapter-button h3 {
            color: #8ab4f8;
         }
         .dark .chapter-button:disabled {
            background-color: #242434;
         }
         /* === END: CHAPTER SELECTION STYLES === */
        
        /* Exam UI Wrapper */
        #examUIWrapper { display: none; flex-direction: column; height: 100%; position: relative; }
        
        /* Header */
       .site-header { background: #ffffff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 101; position: relative; }
       .dark .site-header { background: #2a2a3a; border-bottom-color: #333; }
       .site-branding { display: flex; flex-direction: column; }
       .site-branding .site-title { font-size: 1.4em; font-weight: 700; color: #3f51b5; line-height: 1.1; }
       .dark .site-branding .site-title { color: #8ab4f8; }
       .site-branding .site-tagline { font-size: 0.8em; color: #666; margin: 0; }
       .dark .site-branding .site-tagline { color: #ccc; }

        /* Top Bar */
       .topbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px; background: #3f51b5; color: white; gap: 10px; z-index: 100; position: relative; }
       .dark .topbar { background: #37374a; }
       .topbar-left-group,.topbar-right-group { display: flex; align-items: center; gap: 15px; }
       .navigation-tabs { display: flex; gap: 5px; background: rgba(0,0,0,0.15); border-radius: 6px; padding: 3px; position: absolute; left: 50%; transform: translateX(-50%); }
       .dark .navigation-tabs { background: rgba(0,0,0,0.25); }
       .nav-tab { background: transparent; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.85em; }
       .nav-tab:hover:not(.locked) { background: rgba(255,255,255,0.2); }
       .nav-tab.active { background: white; color: #3f51b5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
       .dark .nav-tab.active { background: #8ab4f8; color: #1e1e2f; }
       .nav-tab.locked { cursor: not-allowed; opacity: 0.6; position: relative; pointer-events: none; }
       .nav-tab.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-left: 8px; font-size: 0.9em; }
       .timer { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
        #stopwatchWrapper { display: none; align-items: center; gap: 10px; }
        #stopwatchDisplay { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
       .stopwatch-controls button { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; font-size: 0.8em; padding: 5px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; margin-left: 5px; }
       .stopwatch-controls button:hover { background-color: rgba(255,255,255,0.2); }
       
       /* Dark Mode Toggle */
       .dark-mode-toggle { display: flex; align-items: center; gap: 8px; }
       .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
       .toggle-switch input { opacity: 0; width: 0; height: 0; }
       .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
       .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
       input:checked + .slider { background-color: #8ab4f8; }
       input:checked + .slider:before { transform: translateX(24px); }
       .toggle-icons { position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); display: flex; justify-content: space-around; align-items: center; padding: 0 5px; }
       .toggle-icons i { color: #f0f0f5; font-size: 14px; transition: color 0.4s; }
       .dark .toggle-icons i { color: #1e1e2f; }
       .fa-sun { color: #f39c12; }
       .fa-moon { color: #ccc; }
       input:checked + .slider .fa-sun { color: #f0f0f5; }
       input:checked + .slider .fa-moon { color: #f39c12; }
       .dark input:checked + .slider .fa-sun { color: #1e1e2f; }
       .dark input:checked + .slider .fa-moon { color: #f39c12; }
       .dark .slider { background-color: #555; }
       .dark .slider:before { background-color: #1e1e2f; }
       .dark input:checked + .slider:before { background-color: #eee; }

        /* Main Content Area */
       .main-content { display: flex; flex: 1; min-height: 0; overflow: hidden; position: relative; }
       .question-area, .sidebar { padding: 20px; overflow-y: auto; height: 100%; }
       .question-area { flex: 1; background: #f9f9f9; }
       .sidebar { width: 300px; background: #ffffff; border-left: 1px solid #e0e0e0; display: flex; flex-direction: column; }
       .dark .question-area { background: #1a1a2a; }
       .dark .sidebar { background: #242434; border-left-color: #333; }
       
       /* Question Display */
       .question-container { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px dashed #ccc; }
       .dark .question-container { border-bottom-color: #444; }
       .question-number { font-weight: 600; font-size: 1.1em; margin-bottom: 10px; color: #3f51b5; }
       .dark .question-number { color: #8ab4f8; }
       .question-text { margin-bottom: 20px; line-height: 1.7; font-size: 1.05em; }
       .options-list { list-style: none; }
       .option { margin-bottom: 10px; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; }
       .dark .option { border-color: #555; }
       .option:hover { background: #f0f0f5; border-color: #3f51b5; }
       .dark .option:hover { background: #2a2a3a; border-color: #8ab4f8; }
       .option.selected { background: #e8eaf6; border-color: #3f51b5; font-weight: 500; }
       .dark .option.selected { background: #2c3a7a; border-color: #8ab4f8; }
       .option.review { background: #fff3e0; border-color: #ffa726; }
       .dark .option.review { background: #4a3c2a; border-color: #ffa726; }
       .option-letter { min-width: 25px; height: 25px; border-radius: 50%; border: 1px solid #777; display: flex; align-items: center; justify-content: center; font-weight: 500; margin-right: 15px; transition: all 0.3s; }
       .dark .option-letter { border-color: #aaa; }
       .option.selected .option-letter { background: #3f51b5; color: white; border-color: #3f51b5; }
       .dark .option.selected .option-letter { background: #8ab4f8; color: #1e1e2f; border-color: #8ab4f8; }
       .option.review .option-letter { background: #ffa726; color: white; border-color: #ffa726; }
       .dark .option.review .option-letter { background: #ffa726; color: #1e1e2f; border-color: #ffa726; }
       .option-text { flex: 1; }
       
       /* Navigation Buttons */
       .question-nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
       .btn-nav { padding: 10px 20px; border: none; border-radius: 6px; background: #5c6bc0; color: white; font-size: 1em; cursor: pointer; transition: background 0.3s; }
       .btn-nav:hover { background: #3f51b5; }
       .btn-nav:disabled { background: #ccc; cursor: not-allowed; }
       .dark .btn-nav:disabled { background: #555; }
       .btn-review { background: #ffa726; }
       .btn-review:hover { background: #fb8c00; }
       .btn-submit { background: #4caf50; }
       .btn-submit:hover { background: #388e3c; }

        /* Sidebar */
       .sidebar-section { border-bottom: 1px solid #e0e0e0; padding: 15px; }
       .dark .sidebar-section { border-bottom-color: #333; }
       .sidebar-section:last-child { border-bottom: none; }
       .sidebar-title { font-size: 1.1em; font-weight: 600; margin-bottom: 15px; color: #3f51b5; }
       .dark .sidebar-title { color: #8ab4f8; }
       #userProfile { text-align: center; }
       #userPhoto { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 3px solid #3f51b5; }
       .dark #userPhoto { border-color: #8ab4f8; }
       #userName { font-weight: 500; font-size: 1.1em; }
       #userEmail { font-size: 0.9em; color: #666; }
       .dark #userEmail { color: #ccc; }
       .question-palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
       .palette-btn { width: 40px; height: 40px; border: 1px solid #ccc; border-radius: 4px; background: #f0f0f0; color: #333; cursor: pointer; font-weight: 500; transition: all 0.3s; }
       .dark .palette-btn { background: #3a3a4a; border-color: #555; color: #eee; }
       .palette-btn:hover { background: #e0e0e0; }
       .dark .palette-btn:hover { background: #4a4a5a; }
       .palette-btn.answered { background: #4caf50; color: white; border-color: #4caf50; }
       .palette-btn.not-answered { background: #f44336; color: white; border-color: #f44336; }
       .palette-btn.review { background: #ffa726; color: white; border-color: #ffa726; }
       .palette-btn.current { box-shadow: 0 0 0 3px #3f51b5; }
       .dark .palette-btn.current { box-shadow: 0 0 0 3px #8ab4f8; }
       .legend { margin-top: 15px; }
       .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9em; }
       .legend-color { width: 20px; height: 20px; border-radius: 4px; margin-right: 10px; border: 1px solid #ccc; }
       .legend-answered { background: #4caf50; }
       .legend-not-answered { background: #f44336; }
       .legend-review { background: #ffa726; }
       .legend-not-visited { background: #f0f0f0; }
       .dark .legend-not-visited { background: #3a3a4a; border-color: #555; }
       
       /* Result Screen */
       #resultScreen { display: none; padding: 20px; overflow-y: auto; }
       .result-container { background: #ffffff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); max-width: 900px; margin: 20px auto; }
       .dark .result-container { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
       .result-header { text-align: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
       .dark .result-header { border-bottom-color: #444; }
       .result-header h2 { color: #3f51b5; font-size: 2em; }
       .dark .result-header h2 { color: #8ab4f8; }
       .result-header p { font-size: 1.1em; color: #555; }
       .dark .result-header p { color: #ccc; }
       .result-summary { display: flex; justify-content: space-around; text-align: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
       .summary-box { padding: 20px; border-radius: 8px; width: 150px; }
       .summary-box .value { font-size: 2.5em; font-weight: 700; }
       .summary-box .label { font-size: 0.9em; font-weight: 500; opacity: 0.8; }
       .summary-score { background: #e8eaf6; color: #3f51b5; }
       .dark .summary-score { background: #2c3a7a; color: #8ab4f8; }
       .summary-correct { background: #e8f5e9; color: #2e7d32; }
       .dark .summary-correct { background: #2a4a2c; color: #a5d6a7; }
       .summary-incorrect { background: #ffebee; color: #c62828; }
       .dark .summary-incorrect { background: #4a2a2a; color: #ef9a9a; }
       .summary-unattempted { background: #f5f5f5; color: #555; }
       .dark .summary-unattempted { background: #4a4a4a; color: #ccc; }
       
       .charts-container { display: flex; justify-content: space-around; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
       .chart-box { width: 100%; max-width: 300px; text-align: center; }
       .chart-box h3 { font-size: 1.2em; margin-bottom: 15px; }
       
       .result-actions { text-align: center; margin-bottom: 30px; }
       .btn-result { padding: 12px 25px; border: none; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background 0.3s; margin: 0 10px; }
       #reviewAnswersBtn { background: #3f51b5; color: white; }
       #reviewAnswersBtn:hover { opacity: 0.9; }
       #goHomeBtn { background: #f0f0f5; color: #333; border: 1px solid #ccc; }
       .dark #goHomeBtn { background: #3a3a4a; color: #eee; border-color: #555; }
       
       .answer-review-section { display: none; }
       .answer-review-section h3 { font-size: 1.5em; color: #3f51b5; border-bottom: 2px solid #3f51b5; padding-bottom: 5px; margin-bottom: 20px; }
       .dark .answer-review-section h3 { color: #8ab4f8; border-bottom-color: #8ab4f8; }
       .review-question { margin-bottom: 25px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
       .dark .review-question { border-color: #444; }
       .review-question.correct-answer { background: #f1f8e9; border-left: 5px solid #689f38; }
       .dark .review-question.correct-answer { background: #2a3a2b; border-left-color: #a5d6a7; }
       .review-question.incorrect-answer { background: #fff0f0; border-left: 5px solid #d32f2f; }
       .dark .review-question.incorrect-answer { background: #3a2a2a; border-left-color: #ef9a9a; }
       .review-question.unattempted { background: #fafafa; border-left: 5px solid #757575; }
       .dark .review-question.unattempted { background: #3a3a3a; border-left-color: #aaa; }
       
       .review-q-text { font-weight: 600; margin-bottom: 15px; }
       .review-options li { list-style: none; margin-bottom: 10px; padding: 10px; border-radius: 6px; border: 1px solid transparent; }
       .review-options .correct { background: #c8e6c9; border-color: #689f38; }
       .dark .review-options .correct { background: #3a5a3b; border-color: #a5d6a7; }
       .review-options .incorrect { background: #ffcdd2; border-color: #d32f2f; }
       .dark .review-options .incorrect { background: #5a3a3a; border-color: #ef9a9a; }
       .review-options .selected { font-weight: bold; }
       .review-options i { margin-right: 8px; }
       .explanation { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 6px; border-top: 2px solid #3f51b5; }
       .dark .explanation { background: #1e1e2f; border-top-color: #8ab4f8; }
       .explanation-title { font-weight: 600; color: #3f51b5; margin-bottom: 5px; }
       .dark .explanation-title { color: #8ab4f8; }

        /* Loader */
        #loader {
            display: none; 
            position: fixed; 
            z-index: 10000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
        }
        .dark #loader { background: rgba(30, 30, 47, 0.8); }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3f51b5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        .dark .spinner {
            border-color: #444;
            border-top-color: #8ab4f8;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .main-content { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: auto; border-left: none; border-top: 1px solid #e0e0e0; }
            .dark .sidebar { border-top-color: #333; }
            .question-area { flex: 1; }
            .question-palette { grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 5px; }
            .palette-btn { width: 35px; height: 35px; font-size: 0.9em; }
        }
        @media (max-width: 600px) {
            .topbar { flex-direction: column; gap: 10px; padding: 10px; }
            .navigation-tabs { position: static; transform: none; width: 100%; justify-content: center; }
            .topbar-left-group, .topbar-right-group { justify-content: space-between; width: 100%; }
            .timer { order: 1; }
            .dark-mode-toggle { order: 2; }
            .login-card, .instructions-container, .result-container { padding: 20px; }
            .question-area, .sidebar { padding: 15px; }
            .result-summary { flex-direction: column; gap: 10px; }
            .summary-box { width: 100%; }
        }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div class="pre-exam-screen" id="preExamScreen">
        
        <div id="chapterSelectionWrapper">
            <header class="site-header" style="padding-left: 0; padding-right: 0;">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            <h1>NCERT Chapter-wise Tests</h1>
            <p>Master every subject, one chapter at a time. Select a test to begin.</p>
            
            <div id="chapterGridContainer">
                </div>
        </div>

        <div class="login-card" id="loginScreen">
            <header class="site-header">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            <h2>Exam Portal Login</h2>
            <p id="testTitle">Loading test details...</p>
            <div id="loginError"></div>
            <button id="loginBtn" class="btn-primary">
                <i class="fa-brands fa-google"></i> &nbsp; Sign in with Google to Start
            </button>
        </div>

        <div class="instructions-container" id="instructionsScreen">
            <header class="site-header">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            
            <h2 id="instructionsTestTitle">Test Instructions</h2>
            <div id="offlineStatus" class="status-waiting">
                <i class="fas fa-wifi"></i> Connecting to server...
            </div>
            
            <div class="instructions-content">
                <h2>General Instructions:</h2>
                <ul>
                    <li><i class="fas fa-stopwatch"></i><strong>Time:</strong> <span id="testDuration">N/A</span> minutes. The timer will be displayed at the top of the screen.</li>
                    <li><i class="fas fa-list-ol"></i><strong>Questions:</strong> This test consists of <span id="testTotalQuestions">N/A</span> multiple-choice questions.</li>
                    <li><i class="fas fa-check-double"></i><strong>Marking:</strong> Each correct answer awards <span id="testMarksPerQuestion">N/A</span> marks.</li>
                    <li><i class="fas fa-times-circle"></i><strong>Negative Marking:</strong> <span id="testNegativeMarks">N/A</span> will be deducted for each incorrect answer. There is no negative marking for unattempted questions.</li>
                </ul>

                <h2>Navigation:</h2>
                <ul>
                    <li><i class="fas fa-mouse-pointer"></i>Select your answer by clicking on one of the options.</li>
                    <li><i class="fas fa-save"></i>Click <strong>"Save & Next"</strong> to save your answer and move to the next question.</li>
                    <li><i class="fas fa-flag"></i>Click <strong>"Mark for Review & Next"</strong> to mark a question for later review. Answers marked for review will be evaluated.</li>
                    <li><i class="fas fa-palette"></i>Use the <strong>Question Palette</strong> on the side to navigate directly to any question.</li>
                </ul>

                <h2>Submission:</h2>
                <ul>
                    <li><i class="fas fa-check-circle"></i>Click the <strong>"Submit Test"</strong> button to finish the exam.</li>
                    <li><i class="fas fa-hourglass-end"></i>The test will be automatically submitted if the timer runs out.</li>
                    <li><i class="fas fa-exclamation-triangle"></i><strong>Do not</strong> refresh the page or use the browser's back button during the exam.</li>
                </ul>
            </div>
            
            <div class="instructions-footer">
                <div class="agreement-group">
                    <input type="checkbox" id="agreementCheckbox">
                    <label for="agreementCheckbox">I have read and understood all the instructions.</label>
                </div>
                <button id="startExamBtn" class="btn-primary btn-start-exam" disabled>Start Exam</button>
                <div id="startError"></div>
            </div>
        </div>

        <div class="submitting-card" id="submittingScreen" style="display: none;">
            <h2>Submitting Test...</h2>
            <p>Please wait while we process your results. Do not close or refresh this window.</p>
            <div class="spinner" style="margin: 20px auto;"></div>
        </div>

    </div>

    <div id="examUIWrapper">
        <header class="site-header" id="siteHeader">
            <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
            <div class="site-branding">
                <span class="site-title" id="examHeaderTitle">NCERT Test</span>
                <p class="site-tagline">UPSC Civil Services Exam Preparation</p>
            </div>
             <div class="site-copyright">Copyright © 2025 Pratyush Swain</div>
        </header>
        <header class="topbar" id="topbar">
            <div class="topbar-left-group">
                <button id="btnToggleSidebar" class="sidebar-toggle" title="Toggle Palette"><i class="fas fa-chevron-left"></i></button>
                <div class="timer" id="timerDisplay">00:00:00</div>
                <div id="stopwatchWrapper">
                    <span id="stopwatchDisplay">00:00:00</span>
                    <div class="stopwatch-controls">
                        <button id="stopwatchPlayPause" title="Play/Pause"><i class="fas fa-play"></i></button>
                        <button id="stopwatchReset" title="Reset"><i class="fas fa-rotate-left"></i></button>
                    </div>
                </div>
            </div>
            <div class="navigation-tabs">
                <button id="showMockTestTab" class="nav-tab active">Mock Test</button>
            </div>
            <div class="topbar-right-group">
                <div class="dark-mode-toggle">
                    <span class="toggle-label" id="toggleLabel">Dark</span>
                    <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label>
                </div>
                <button id="btnSubmitTest" style="display: none;"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
        </header>
        
        <div class="main-content" id="main-content">    
            
            <div id="mockTestWrapper" style="display: flex; width: 100%;">
                <section class="question-area">
                    <h2 class="question-header" id="questionNumber"></h2>
                    <div class="question-content" id="questionText"></div>
                    <ul class="options-list" id="optionsList"></ul>
                </section>
                
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-content">
                        <div class="palette-title">Question Palette</div>
                        <div class="question-palette" id="questionPalette"></div>
                        <div class="palette-summary">
                            <div class="summary-item"><span id="summaryAnswered">0</span> Answered</div>
                            <div class="summary-item"><span id="summaryNotAnswered">0</span> Not Answered</div>
                            <div class="summary-item"><span id="summaryMarked">0</span> Marked Review</div>
                            <div class="summary-item"><span id="summaryNotVisited">0</span> Not Visited</div>
                        </div>
                        <div class="legend">
                            <div class="legend-title">Legend</div>
                            <div class="legend-item"><div class="legend-color answered"></div><span>Answered</span></div>
                            <div class="legend-item"><div class="legend-color not-answered"></div><span>Not Answered</span></div>
                            <div class="legend-item"><div class="legend-color marked"></div><span>Marked</span></div>
                            <div class="legend-item"><div class="legend-color marked-answered"></div><span>Marked & Answered</span></div>
                            <div class="legend-item"><div class="legend-color not-visited"></div><span>Not Visited</span></div>
                        </div>
                    </div>
                </aside>
            </div>
            
            <div id="resultScreenWrapper">
                <h2 id="resultScreenTitle">Test Completed!</h2>
                <p id="resultScreenSubtitle">Here is your score summary:</p>
                
                <div id="syncStatus"></div>

                <div class="scorecard-details">
                    <table class="scorecard-table">
                        <tbody>
                            <tr>
                                <td><i class="fas fa-check-circle" style="color: #4caf50; margin-right: 8px;"></i>Correct Answers</td>
                                <td class="correct-val"><span id="correctCount">0</span> (<span id="correctMarks">0</span> Marks)</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-times-circle" style="color: #f44336; margin-right: 8px;"></i>Incorrect Answers</td>
                                <td class="incorrect-val"><span id="incorrectCount">0</span> (<span id="incorrectMarks">0</span> Marks)</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-minus-circle" style="color: #ff9800; margin-right: 8px;"></i>Unattempted</td>
                                <td class="unattempted-val"><span id="unattemptedCount">0</span></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Final Score</strong></td>
                                <td class="total-val"><strong><span id="finalScoreAnimated">0</span> / <span id="totalPossibleScore">0</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="result-buttons" id="resultButtonsContainer">
                     <button id="retestButton" class="submit-button btn-action"><i class="fas fa-redo"></i> Retest</button>
                     <button id="reviewAnswersButton" class="submit-button btn-action"><i class="fas fa-search"></i> Review Answers</button>
                     <button onclick="window.location.href = 'testncert_page.html'" class="submit-button btn-action"><i class="fas fa-list"></i> Test Menu</button>
                </div>
                
                </div>
            
            <div id="reviewScreenWrapper">
                <div class="review-header"><h2 class="review-title">Review Your Answers</h2><button id="backToResultsBtn" class="submit-button btn-action"><i class="fas fa-arrow-left"></i> Back to Score</button></div>
                <div id="reviewContainer"></div>
            </div>

        </div>
        
        <div class="fixed-action-area" id="mcqFooter">
            <div class="action-buttons">
                <button class="btn-action" id="btnPrevQuestion"><i class="fas fa-arrow-left"></i><span>Previous</span></button>
                <button class="btn-action" id="btnClearResponse"><i class="fas fa-ban"></i><span>Clear</span></button>
                <button class="btn-action" id="btnMarkReview"><i class="fas fa-flag"></i><span>Mark</span></button>
                <button class="btn-action" id="btnSaveNext"><i class="fas fa-check"></i><span>Save & Next</span></button>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="password-modal">
        <div class="modal-content">
            <span id="closeModal" class="close-modal">×</span>
            <h3>Enter Password to Retest</h3>
            <p style="font-size: 0.9em; color: #666;">Retest requires you to be offline.</p>
            <input type="password" id="passwordRetestInput" placeholder="Enter password...">
            <div id="passwordError"></div>
            <button id="verifyPasswordButton" class="submit-button btn-action">Verify</button>
        </div>
    </div>


    <script>
        // ### CONFIGURATION ###
        const RETEST_PASSWORD = "UPSChub"; // Password for retest
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", 
            authDomain: "upscstudyhub-github.firebaseapp.com", 
            projectId: "upscstudyhub-github", 
            storageBucket: "upscstudyhub-github.appspot.com", 
            messagingSenderId: "451692540885", 
            appId: "1:451692540885:web:b425e85128e5de97c7c35c" 
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null;
        let currentTest = null;
        let questions = [];
        let userAnswers = {}; // { q_id: { answer: 'a', status: 'answered' } }
        let state = { current: 0, answers: [], marked: [], visited: [] }; // For palette
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let testStartTime = null;
        let testSessionId = null;
        let scoreChart = null;
        let attemptChart = null;
        let animationInterval = null;

        // --- DOM Elements (Adapted for new UI) ---
        const $ = (selector) => document.getElementById(selector);
        
        // Pre-Exam Screens
        const preExamScreen = $('preExamScreen');
        const chapterSelectionWrapper = $('chapterSelectionWrapper');
        const chapterGridContainer = $('chapterGridContainer');
        const loginScreen = $('loginScreen');
        const loginBtn = $('loginBtn');
        const loginError = $('loginError');
        const testTitle = $('testTitle');
        const instructionsScreen = $('instructionsScreen');
        const instructionsTestTitle = $('instructionsTestTitle');
        const testDuration = $('testDuration');
        const testTotalQuestions = $('testTotalQuestions');
        const testMarksPerQuestion = $('testMarksPerQuestion');
        const testNegativeMarks = $('testNegativeMarks');
        const agreementCheckbox = $('agreementCheckbox');
        const startExamBtn = $('startExamBtn');
        const startError = $('startError');
        const submittingScreen = $('submittingScreen');
        const loader = $('loader'); // Using the loader from File 1

        // Exam UI
        const examUIWrapper = $('examUIWrapper');
        const examHeaderTitle = $('examHeaderTitle');
        const timerDisplay = $('timerDisplay');
        const stopwatchWrapper = $('stopwatchWrapper'); // Kept if you want to add it later
        const darkModeToggle = $('darkModeToggle');
        const toggleLabel = $('toggleLabel');
        const btnToggleSidebar = $('btnToggleSidebar');
        
        // Main Content
        const questionArea = document.querySelector('.question-area');
        const questionNumber = $('questionNumber');
        const questionText = $('questionText');
        const optionsList = $('optionsList');
        
        // Sidebar
        const sidebar = $('sidebar');
        const questionPalette = $('questionPalette');
        const summaryAnswered = $('summaryAnswered');
        const summaryNotAnswered = $('summaryNotAnswered');
        const summaryMarked = $('summaryMarked');
        const summaryNotVisited = $('summaryNotVisited');
        
        // Footer Buttons
        const btnPrevQuestion = $('btnPrevQuestion');
        const btnSaveNext = $('btnSaveNext');
        const btnMarkReview = $('btnMarkReview');
        const btnClearResponse = $('btnClearResponse');
        const btnSubmitTest = $('btnSubmitTest'); // Top submit button

        // Result Screen
        const resultScreenWrapper = $('resultScreenWrapper');
        const resultScreenTitle = $('resultScreenTitle');
        const correctCount = $('correctCount');
        const correctMarks = $('correctMarks');
        const incorrectCount = $('incorrectCount');
        const incorrectMarks = $('incorrectMarks');
        const unattemptedCount = $('unattemptedCount');
        const finalScoreAnimated = $('finalScoreAnimated');
        const totalPossibleScore = $('totalPossibleScore');
        const resultButtonsContainer = $('resultButtonsContainer');

        // Review Screen
        const reviewScreenWrapper = $('reviewScreenWrapper');
        const reviewContainer = $('reviewContainer');
        const backToResultsBtn = $('backToResultsBtn');

        // Password Modal
        const passwordModal = $('passwordModal');
        const closeModal = $('closeModal');
        const verifyPasswordButton = $('verifyPasswordButton');
        const passwordRetestInput = $('passwordRetestInput');
        const passwordError = $('passwordError');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoader(true, 'Initializing...');
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('testId');
            
            // Persist auth state
            auth.onAuthStateChanged(user => {
                currentUser = user; 
                
                if (testId) {
                    // *** LOGIC 1: A testId IS in the URL ***
                    if (user) {
                        showLoader(true, 'Fetching user data...');
                        // displayUserInfo(user); // No user profile in this UI
                        loadSingleTest(testId);
                    } else {
                        showLoader(false);
                        showLoginScreen(testId);
                    }
                } else {
                    // *** LOGIC 2: NO testId in the URL ***
                    showTestSelectionScreen();
                }
            });

            // Dark Mode
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark') {
                darkModeToggle.checked = true;
                toggleDarkMode(true);
            }
            darkModeToggle.addEventListener('change', (e) => {
                toggleDarkMode(e.target.checked);
                localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
            });

            // Exam Listeners
            agreementCheckbox.addEventListener('change', () => {
                startExamBtn.disabled = !agreementCheckbox.checked;
            });
            startExamBtn.addEventListener('click', startExam);
            btnSubmitTest.addEventListener('click', () => confirmSubmit(false));
            
            // Footer Listeners
            btnSaveNext.addEventListener('click', saveAndNext);
            btnPrevQuestion.addEventListener('click', prevQuestion);
            btnMarkReview.addEventListener('click', markForReview);
            btnClearResponse.addEventListener('click', clearResponse);

            // UI Listeners
            btnToggleSidebar.addEventListener('click', () => document.body.classList.toggle('sidebar-open'));
            backToResultsBtn.addEventListener('click', () => {
                reviewScreenWrapper.style.display = 'none';
                resultScreenWrapper.style.display = 'flex';
            });
            
            // Result Button Listeners (dynamic)
            resultButtonsContainer.addEventListener('click', (e) => {
                if (e.target.id === 'retestButton' || e.target.closest('#retestButton')) {
                    passwordModal.style.display = 'flex';
                }
                if (e.target.id === 'reviewAnswersButton' || e.target.closest('#reviewAnswersButton')) {
                    resultScreenWrapper.style.display = 'none';
                    reviewScreenWrapper.style.display = 'flex';
                }
            });

            // Modal Listeners
            closeModal.addEventListener('click', () => { passwordModal.style.display = 'none'; });
            verifyPasswordButton.addEventListener('click', handleRetest);

            // Offline/Online status
            // Note: This UI doesn't have an offline status indicator, but we can add it.
            // updateOnlineStatus(); 
            // window.addEventListener('online', updateOnlineStatus);
            // window.addEventListener('offline', updateOnlineStatus);
            
            // Prevent accidental navigation
            window.addEventListener('beforeunload', (e) => {
                if (testSessionId && resultScreenWrapper.style.display === 'none') {
                    const confirmationMessage = 'Are you sure you want to leave? Your progress will be saved, but the test will not be submitted.';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
        });
        
        // --- NEW: Chapter Selection Logic ---
        async function showTestSelectionScreen() {
            showLoader(true, 'Loading available tests...');
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'block';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            examUIWrapper.style.display = 'none';
            
            let tests = [];
            try {
                // Fetch all test documents from 'ncertTests'
                const querySnapshot = await firestore.collection("ncertTests").get();
                querySnapshot.forEach((doc) => tests.push({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error fetching ncertTests: ", error);
                chapterGridContainer.innerHTML = `<p style="color: red; text-align: center;">Could not load tests. Check Firestore rules for 'ncertTests'.</p>`;
                showLoader(false);
                return;
            }

            if (tests.length === 0) {
                chapterGridContainer.innerHTML = `<p style="color: #555; text-align: center;">No tests are available in the 'ncertTests' collection yet.</p>`;
                showLoader(false);
                return;
            }

            // Group tests by their 'subject' field
            const subjectsMap = new Map();
            tests.forEach(test => {
                const subjectName = test.subject || "Uncategorized"; // Use 'subject' field
                if (!subjectsMap.has(subjectName)) {
                    subjectsMap.set(subjectName, []);
                }
                subjectsMap.get(subjectName).push(test);
            });

            // Render the HTML
            let allHtml = '';
            const sortedSubjectNames = [...subjectsMap.keys()].sort();

            for (const subjectName of sortedSubjectNames) {
                const subjectTests = subjectsMap.get(subjectName);
                
                allHtml += `
                    <section class="subject-group">
                        <h2>${subjectName}</h2>
                        <div class="chapter-grid">
                `;

                // Sort tests by title
                subjectTests.sort((a, b) => (a.title || '').localeCompare(b.title || ''));

                subjectTests.forEach((test, index) => {
                    const testId = test.id;
                    const chapterTitle = test.title || 'Untitled Test';
                    
                    // Create an <a> tag that links to this same page, but with a testId
                    allHtml += `
                        <a href="testncert_page.html?testId=${testId}" class="chapter-button">
                            <h3>${chapterTitle}</h3>
                        </a>
                    `;
                });
                
                allHtml += '</div></section>';
            }
            
            chapterGridContainer.innerHTML = allHtml;
            showLoader(false);
        }

        function showLoader(show, text = 'Loading...') {
            if (show) {
                loader.style.display = 'flex';
            } else {
                loader.style.display = 'none';
            }
        }

        function showError(message, element = loginError) {
            element.textContent = message;
        }

        function showLoginScreen(testId) {
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'none';
            loginScreen.style.display = 'block';
            instructionsScreen.style.display = 'none';
            examUIWrapper.style.display = 'none';
            testTitle.textContent = `Loading test: ${testId}...`;
        }

        function showInstructionsScreen() {
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'none';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'flex';
            examUIWrapper.style.display = 'none';

            // Populate instructions
            instructionsTestTitle.textContent = currentTest.title;
            // Use field names from your screenshot
            testDuration.textContent = currentTest.durationMinutes || 'N/A';
            testTotalQuestions.textContent = currentTest.totalQuestions || 'N/A';
            testMarksPerQuestion.textContent = currentTest.marksPerQuestion || '2'; // Default
            testNegativeMarks.textContent = currentTest.negativeMarks !== undefined ? currentTest.negativeMarks : '0.66'; // Default
        }

        // --- Authentication ---
        function handleLogin() {
            showLoader(true, 'Signing in...');
            auth.signInWithPopup(provider)
                .catch(error => {
                    showError(`Login failed: ${error.message}`);
                    showLoader(false);
                });
            // onAuthStateChanged will handle the successful login
        }
        
        // --- Data Fetching ---
        async function loadSingleTest(testId) {
            if (!currentUser) {
                showLoginScreen(testId);
                return;
            }
            
            showLoader(true, 'Loading test data...');
            try {
                const docRef = firestore.collection('ncertTests').doc(testId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    throw new Error('Test not found in ncertTests collection.');
                }

                currentTest = { id: doc.id, ...doc.data() };
                
                // *** ADAPTED TO YOUR DATABASE ***
                // Use fields from your screenshot
                currentTest.duration = currentTest.durationMinutes || 30; // Use 'durationMinutes'
                currentTest.totalQuestions = currentTest.totalQuestions || (currentTest.questions ? currentTest.questions.length : 0);
                // Set defaults if not present
                currentTest.marksPerQuestion = currentTest.marksPerQuestion || 2;
                currentTest.negativeMarks = currentTest.negativeMarks !== undefined ? currentTest.negativeMarks : 0.66;
                
                // Validate test structure
                if (!currentTest.questions || currentTest.questions.length === 0) {
                    throw new Error('Test contains no questions or questions are not in an array.');
                }
                questions = currentTest.questions;
                // Ensure totalQuestions matches the array
                currentTest.totalQuestions = questions.length;

                testTitle.textContent = `Test: ${currentTest.title}`;

                await checkIncompleteSession(testId);
                
            } catch (error) {
                console.error("Error loading test:", error);
                showError(`Error: ${error.message}. Please check the test ID and your connection.`, startError);
                // Show a more user-friendly error on the instructions screen
                instructionsScreen.innerHTML = `<h2>Error</h2><p>${error.message}</p><a href="testncert_page.html" class="btn-primary" style="text-decoration:none; text-align:center; margin-top:20px;">Back to Test Menu</a>`;
                showInstructionsScreen();
                showLoader(false);
            }
        }
        
        async function checkIncompleteSession(testId) {
            try {
                const sessionQuery = await firestore.collection('testSessions')
                    .where('userId', '==', currentUser.uid)
                    .where('testId', '==', testId)
                    .where('status', '==', 'started')
                    .orderBy('startTime', 'desc')
                    .limit(1)
                    .get();

                if (!sessionQuery.empty) {
                    const session = sessionQuery.docs[0];
                    const sessionData = session.data();
                    
                    if (confirm('You have an incomplete test session. Do you want to resume it?')) {
                        // Resume session
                        testSessionId = session.id;
                        userAnswers = sessionData.userAnswers || {};
                        currentQuestionIndex = sessionData.currentQuestionIndex || 0;
                        testStartTime = sessionData.startTime.toDate();
                        
                        // Handle timer
                        if (currentTest.duration) {
                            const elapsedTime = (new Date() - testStartTime) / 1000;
                            const remainingTime = (currentTest.duration * 60) - elapsedTime;
                            if (remainingTime > 0) {
                                startTimer(remainingTime);
                            } else {
                                submitExam(true); 
                                return;
                            }
                        } else {
                            startStopwatch(sessionData.stopwatchTime || 0);
                        }
                        
                        showExamUI();
                        showLoader(false);
                        return;
                    }
                }
                
                showInstructionsScreen();
                showLoader(false);

            } catch (error) {
                console.error("Error checking incomplete session: ", error);
                showError(`Error resuming session: ${error.message}`, startError);
                showInstructionsScreen();
                showLoader(false);
            }
        }

        // --- Exam Logic (Adapted for new UI) ---
        async function startExam() {
            if (agreementCheckbox.disabled) return;
            
            showLoader(true, 'Starting exam...');
            testStartTime = new Date();
            testSessionId = `ts_${currentUser.uid}_${currentTest.id}_${testStartTime.getTime()}`;
            
            // Reset state
            userAnswers = {};
            currentQuestionIndex = 0;
            state = { 
                current: 0, 
                answers: Array(questions.length).fill(null), 
                marked: Array(questions.length).fill(false), 
                visited: Array(questions.length).fill(false) 
            };

            try {
                // Create a 'testSessions' document
                await firestore.collection('testSessions').doc(testSessionId).set({
                    userId: currentUser.uid,
                    testId: currentTest.id,
                    testTitle: currentTest.title,
                    startTime: firebase.firestore.Timestamp.fromDate(testStartTime),
                    status: 'started',
                    userAnswers: {},
                    currentQuestionIndex: 0
                });
                
                showExamUI();

                if (currentTest.duration && currentTest.duration > 0) {
                    timerDisplay.style.display = 'block';
                    stopwatchWrapper.style.display = 'none';
                    startTimer(currentTest.duration * 60);
                } else {
                    timerDisplay.style.display = 'none';
                    stopwatchWrapper.style.display = 'flex';
                    startStopwatch(0);
                }

            } catch (error) {
                console.error("Error starting exam session: ", error);
                showError(`Failed to start test: ${error.message}`, startError);
            } finally {
                showLoader(false);
            }
        }

        function showExamUI() {
            preExamScreen.style.display = 'none';
            examUIWrapper.style.display = 'flex';
            resultScreenWrapper.style.display = 'none';
            reviewScreenWrapper.style.display = 'none';
            document.querySelector('#mockTestWrapper').style.display = 'flex'; // Show test area
            
            examHeaderTitle.textContent = currentTest.title || 'NCERT Test';
            document.body.classList.add('exam-active');
            
            // Set initial state
            state.visited[0] = true;

            buildPalette();
            displayQuestion(currentQuestionIndex);
            updateSidebarPosition();
        }

        function startTimer(durationInSeconds) {
            let remainingTime = durationInSeconds;
            clearInterval(timerInterval); // Clear any existing timer
            timerInterval = setInterval(() => {
                remainingTime--;
                timerDisplay.textContent = formatTime(remainingTime);
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'Time Up!';
                    submitExam(true); // Auto-submit
                }
            }, 1000);
        }
        
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startStopwatch(startTime = 0) {
            // This UI doesn't use a stopwatch by default, but the logic is here.
            stopwatchTime = startTime;
            clearInterval(stopwatchInterval);
            stopwatchInterval = setInterval(() => {
                stopwatchTime++;
                $('stopwatchDisplay').textContent = formatTime(stopwatchTime);
            }, 1000);
        }
        
        function updateSidebarPosition() {
           const headerHeight = $('siteHeader').offsetHeight;
           const topbarHeight = $('topbar').offsetHeight;
           const totalHeaderHeight = headerHeight + topbarHeight;
           sidebar.style.top = `${totalHeaderHeight}px`;
           sidebar.style.height = `calc(100% - ${totalHeaderHeight}px)`;
        }

        function buildPalette() {
            questionPalette.innerHTML = '';
            questions.forEach((q, index) => {
                const btn = document.createElement('div');
                btn.className = 'question-number';
                btn.textContent = index + 1;
                btn.dataset.index = index;
                btn.onclick = () => jumpToQuestion(index);
                questionPalette.appendChild(btn);
            });
            updatePalette(); // Initial palette coloring
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            state.current = index;
            state.visited[index] = true;
            
            const q = questions[index];
            if (!q) return;

            // Generate options HTML
            const optionsHTML = q.options.map((option, i) => {
                const optionLetter = String.fromCharCode(97 + i); // a, b, c, d
                const isSelected = state.answers[index] === optionLetter;
                
                return `
                    <li class="option ${isSelected ? 'selected' : ''}" data-option="${optionLetter}">
                        <span class="option-radio"></span>
                        <span class="option-text">${option}</span>
                    </li>
                `;
            }).join('');

            // Generate main question HTML
            questionNumber.textContent = `Question ${index + 1} of ${questions.length}`;
            questionText.innerHTML = q.question; // Use innerHTML to render any HTML in question
            optionsList.innerHTML = optionsHTML;
            
            // Add click listeners to new options
            optionsList.querySelectorAll('.option').forEach(opt => {
                opt.addEventListener('click', () => selectOption(opt.dataset.option));
            });
            
            btnSubmitTest.style.display = (index === questions.length - 1) ? 'flex' : 'none';
            btnPrevQuestion.disabled = (index === 0);
            btnSaveNext.querySelector('span').textContent = (index === questions.length - 1) ? "Save & Finish" : "Save & Next";

            updatePalette();
        }

        function selectOption(optionLetter) {
            state.answers[currentQuestionIndex] = optionLetter;
            
            // Update userAnswers (for session resume)
            const qid = questions[currentQuestionIndex].id;
            if (!userAnswers[qid]) userAnswers[qid] = {};
            userAnswers[qid].answer = optionLetter;
            userAnswers[qid].status = 'answered';

            // Redraw options to show selection
            displayQuestion(currentQuestionIndex);
        }

        function saveAndNext() {
            // Update status (for palette)
            const qid = questions[currentQuestionIndex].id;
            if (!userAnswers[qid]) {
                 userAnswers[qid] = { status: 'not-answered' };
            } else if (userAnswers[qid].status !== 'review') {
                 userAnswers[qid].status = userAnswers[qid].answer ? 'answered' : 'not-answered';
            }
            
            updatePalette();
            updateSession(); // Save progress
            
            if (currentQuestionIndex < questions.length - 1) {
                displayQuestion(currentQuestionIndex + 1);
            } else {
                confirmSubmit(false); // At last question, Save & Next is Submit
            }
        }

        function markForReview() {
            const qid = questions[currentQuestionIndex].id;
            state.marked[currentQuestionIndex] = !state.marked[currentQuestionIndex]; // Toggle mark

            if (!userAnswers[qid]) userAnswers[qid] = {};
            
            // Set status for review
            if(state.marked[currentQuestionIndex]) {
                userAnswers[qid].status = 'review';
            } else {
                // Unmarking, set back to answered or not-answered
                userAnswers[qid].status = userAnswers[qid].answer ? 'answered' : 'not-answered';
            }
            
            updatePalette();
            updateSession();
        }
        
        function clearResponse() {
            state.answers[currentQuestionIndex] = null;
            
            const qid = questions[currentQuestionIndex].id;
            if (userAnswers[qid]) {
                delete userAnswers[qid].answer;
                userAnswers[qid].status = state.marked[currentQuestionIndex] ? 'review' : 'not-answered';
            }
            
            displayQuestion(currentQuestionIndex); // Redraw to remove selection
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        }
        
        function jumpToQuestion(index) {
            displayQuestion(index);
        }

        function updatePalette() {
            let answeredCount = 0;
            let notAnsweredCount = 0;
            let markedCount = 0;
            let notVisitedCount = 0;
            
            questionPalette.querySelectorAll('.question-number').forEach((btn, index) => {
                const isAnswered = state.answers[index] !== null;
                const isMarked = state.marked[index];
                const isVisited = state.visited[index];

                btn.className = 'question-number'; // Reset

                if (isAnswered && isMarked) {
                    btn.classList.add('marked-answered');
                    answeredCount++;
                    markedCount++;
                } else if (isAnswered) {
                    btn.classList.add('answered');
                    answeredCount++;
                } else if (isMarked) {
                    btn.classList.add('marked');
                    markedCount++;
                    notAnsweredCount++; // Marked but unanswered
                } else if (isVisited) {
                    btn.classList.add('not-answered');
                    notAnsweredCount++;
                } else {
                    btn.classList.add('not-visited');
                    notVisitedCount++;
                }
                
                if (index === currentQuestionIndex) {
                    btn.classList.add('current');
                }
            });

            // Update sidebar summary
            summaryAnswered.textContent = answeredCount;
            summaryNotAnswered.textContent = notAnsweredCount;
            summaryMarked.textContent = markedCount;
            summaryNotVisited.textContent = notVisitedCount;
        }

        async function updateSession() {
            if (!testSessionId) return;

            const sessionData = {
                userAnswers: userAnswers,
                currentQuestionIndex: currentQuestionIndex,
            };

            if (!currentTest.duration) {
                sessionData.stopwatchTime = stopwatchTime;
            }

            try {
                await firestore.collection('testSessions').doc(testSessionId).update(sessionData);
            } catch (error) {
                console.warn("Could not update session: ", error.message);
            }
        }

        // --- Submission and Results (Adapted for new UI) ---
        function confirmSubmit() {
            const answered = state.answers.filter(a => a !== null).length;
            const notAnswered = state.visited.filter((v, i) => v && state.answers[i] === null).length;
            const marked = state.marked.filter(m => m).length;

            if (confirm(`Are you sure you want to submit?\n\nAnswered: ${answered}\nNot Answered: ${notAnswered}\nMarked for Review: ${marked}\n\n(Answers marked for review WILL be evaluated)`)) {
                submitExam(false);
            }
        }

        async function submitExam(isAutoSubmit) {
            if (isAutoSubmit) {
                alert('Time is up! Your test is being submitted automatically.');
            }
            
            showLoader(true, 'Calculating results...');
            preExamScreen.style.display = 'flex';
            preExamScreen.style.alignItems = 'center';
            submittingScreen.style.display = 'block';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            chapterSelectionWrapper.style.display = 'none';
            examUIWrapper.style.display = 'none';
            document.body.classList.remove('exam-active');
            
            if (timerInterval) clearInterval(timerInterval);
            if (stopwatchInterval) clearInterval(stopwatchInterval);

            // --- 1. Calculate Score ---
            let score = 0;
            let correct = 0;
            let incorrect = 0;
            let unattempted = 0;
            const marksPerQ = currentTest.marksPerQuestion;
            const negativeMarks = currentTest.negativeMarks;
            const totalScore = questions.length * marksPerQ;
            
            // Use 'state.answers' for calculation
            state.answers.forEach((ans, index) => {
                const correctAnswer = questions[index].answer;
                const qid = questions[index].id;
                
                if (ans === null) {
                    unattempted++;
                    if(userAnswers[qid]) userAnswers[qid].status = 'not-answered';
                } else if (ans === correctAnswer) {
                    correct++;
                    score += marksPerQ;
                    if(userAnswers[qid]) userAnswers[qid].status = 'correct';
                } else {
                    incorrect++;
                    score -= negativeMarks;
                    if(userAnswers[qid]) userAnswers[qid].status = 'incorrect';
                }
            });

            // --- 2. Save Result to Firestore ---
            const testResultId = `tr_${currentUser.uid}_${currentTest.id}_${testStartTime.getTime()}`;
            try {
                await firestore.collection('testResults').doc(testResultId).set({
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    testId: currentTest.id,
                    testTitle: currentTest.title,
                    submissionTime: firebase.firestore.Timestamp.now(),
                    startTime: firebase.firestore.Timestamp.fromDate(testStartTime),
                    score: score,
                    totalScore: totalScore,
                    correct: correct,
                    incorrect: incorrect,
                    unattempted: unattempted,
                    totalQuestions: questions.length,
                    userAnswers: userAnswers, // Save the detailed object
                    marksPerQuestion: marksPerQ,
                    negativeMarks: negativeMarks
                });

                // --- 3. Delete In-Progress Session ---
                if (testSessionId) {
                    await firestore.collection('testSessions').doc(testSessionId).delete();
                    testSessionId = null; 
                }

                // --- 4. Display Results ---
                showLoader(false);
                submittingScreen.style.display = 'none';
                examUIWrapper.style.display = 'flex';
                document.querySelector('#mockTestWrapper').style.display = 'none'; // Hide test area
                sidebar.style.display = 'none';
                document.querySelector('#mcqFooter').style.display = 'none';
                
                resultScreenWrapper.style.display = 'flex'; // Show result screen
                document.body.classList.add('exam-active');
                
                displayResults(score, correct, incorrect, unattempted, totalScore);

            } catch (error) {
                console.error("Error submitting test: ", error);
                showLoader(false);
                submittingScreen.innerHTML = `<h2>Error</h2><p>There was an error submitting your test: ${error.message}</p><p>Please take a screenshot of your screen and contact support.</p>`;
            }
        }
        
        function displayResults(score, correct, incorrect, unattempted, totalScore) {
            resultScreenTitle.textContent = `Test Completed: ${currentTest.title}`;
            totalPossibleScore.textContent = totalScore;

            const scoreBreakdown = {
                correctCount: correct,
                incorrectCount: incorrect,
                unattemptedCount: unattempted,
                correctMarks: correct * currentTest.marksPerQuestion,
                incorrectMarks: incorrect * currentTest.negativeMarks * -1, // Show as negative
                totalScore: score
            };
            
            animateScorecard(scoreBreakdown);
            renderAnswerReview();
        }

        function animateScorecard(data) {
           let current = { correctCount: 0, incorrectCount: 0, unattemptedCount: 0, correctMarks: 0, incorrectMarks: 0, totalScore: 0 };
           const animationSpeed = 20;
           const duration = 1200;
           const steps = duration / animationSpeed;
           const stepValues = {};
           for (const key in current) {
               if(data[key] === undefined) data[key] = 0;
               stepValues[key] = (data[key] - current[key]) / steps;
           }
           clearInterval(animationInterval);
           animationInterval = setInterval(() => {
               let finished = true;
               for (const key in current) {
                   if (Math.abs(current[key] - data[key]) > Math.abs(stepValues[key])) {
                       current[key] += stepValues[key];
                       finished = false;
                   } else {
                       current[key] = data[key];
                   }
               }
               correctCount.textContent = Math.round(current.correctCount);
               correctMarks.textContent = `${Math.round(current.correctMarks) > 0 ? '+' : ''}${Math.round(current.correctMarks)}`;
               incorrectCount.textContent = Math.round(current.incorrectCount);
               incorrectMarks.textContent = Math.round(current.incorrectMarks);
               unattemptedCount.textContent = Math.round(current.unattemptedCount);
               finalScoreAnimated.textContent = Math.round(current.totalScore);
               if(finished) clearInterval(animationInterval);
           }, animationSpeed);
        }
        
        function renderAnswerReview() {
            reviewContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const correctAnswer = q.answer;
                const userAnswer = state.answers[index]; // Use simple state array
                
                let reviewClass = '';
                let statusText = '';
                if (userAnswer === null) {
                    reviewClass = 'unanswered';
                    statusText = 'Unanswered';
                } else if (userAnswer === correctAnswer) {
                    reviewClass = 'correct';
                    statusText = 'Correct';
                } else {
                    reviewClass = 'incorrect';
                    statusText = 'Incorrect';
                }
                
                const optionsHTML = q.options.map((option, i) => {
                    const optionLetter = String.fromCharCode(97 + i);
                    let liClass = 'review-option';
                    let icon = '<i class="far fa-circle"></i>';
                    
                    if (optionLetter === correctAnswer) {
                        liClass += ' review-correct';
                        icon = '<i class="fas fa-check-circle"></i>';
                    }
                    if (optionLetter === userAnswer && userAnswer !== correctAnswer) {
                        liClass += ' review-incorrect';
                        icon = '<i class="fas fa-times-circle"></i>';
                    }
                    
                    return `<li class="${liClass}">${icon} ${option}</li>`;
                }).join('');
                
                const explanationHTML = q.explanation ? `
                    <div class="review-explanation">
                        <strong>Explanation:</strong>
                        <div>${q.explanation}</div>
                    </div>
                ` : '';

                const questionElement = document.createElement('div');
                questionElement.className = `review-question`;
                questionElement.innerHTML = `
                    <h4 class="review-q-text" style="font-weight: 600; margin-bottom: 15px;">Q ${index + 1}: ${q.question}</h4>
                    <ul class="review-option-list">
                        ${optionsHTML}
                    </ul>
                    <div class="review-status ${reviewClass}">${statusText}</div>
                    ${explanationHTML}
                `;
                reviewContainer.appendChild(questionElement);
            });
        }
        
        function handleRetest() {
            if (navigator.onLine) {
                 passwordError.textContent = 'Please enable Aeroplane Mode to retest.';
                 return;
            }
            if (passwordRetestInput.value === RETEST_PASSWORD) {
                // Clear local storage for this test
                // This simple version just reloads the page
                window.location.reload();
            } else {
                passwordError.textContent = 'Incorrect password.';
            }
        }
        
        function toggleDarkMode(isDark) {
            document.body.classList.toggle('dark', isDark);
            toggleLabel.textContent = isDark ? 'Light' : 'Dark';
        }

    </script>
</body>
</html>
