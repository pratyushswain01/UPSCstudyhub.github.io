<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UPSChub - Exam Portal</title>
    <link rel="icon" type="image/jpg" href="images/LOGO.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body { font-family: 'Poppins', sans-serif; background: #f0f0f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; position: relative; }
        .dark { background: #1e1e2f; color: #eee; }
        body.exam-active::after {
            content: "UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A     UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub UPSChub \A";
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; font-size: 8vw; font-weight: 700; color: rgba(0, 0, 0, 0.05); text-align: center; line-height: 2; transform-origin: center; transform: rotate(-30deg); z-index: 9999; pointer-events: none; white-space: pre-wrap; overflow: hidden;
        }
       .dark.exam-active::after { color: rgba(255, 255, 255, 0.04); }
       
       /* --- Pre-Exam Screen & Shared --- */
       .site-header { position: relative; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; padding: 10px 15px; }
       .site-logo { max-height: 40px; }
       .site-copyright { font-family: "Trebuchet MS", "Segoe UI", Arial, sans-serif; font-size: 10px; font-weight: 600; letter-spacing: 0.8px; white-space: nowrap; transition: color 0.3s ease; }
       body.light-mode .site-copyright { color: rgba(0, 0, 0, 0.6); }
       body.dark-mode .site-copyright { color: rgba(255, 255, 255, 0.7); }
       
       .pre-exam-screen {
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         min-height: 100%;
         padding: 20px;
         z-index: 5000;
         position: relative;
         background: #f0f0f5;
         overflow-y: auto;
       }
       .dark.pre-exam-screen { background: #1e1e2f; }
       .login-card,.instructions-container,.submitting-card { background: #ffffff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 100%; text-align: center; }
       .dark.login-card,.dark.instructions-container,.dark.submitting-card { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
       .login-card { max-width: 450px; }
       .submitting-card { max-width: 500px; }
       .login-card h2 { margin-bottom: 25px; color: #3f51b5; font-size: 1.8em; }
       .dark.login-card h2 { color: #8ab4f8; }
       .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #3f51b5; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
       .btn-primary:hover:not(:disabled) { opacity: 0.9; }
       #loginError { color: #f44336; height: 1.2em; margin-top: 15px; font-weight: 500; }
       
       /* --- Instructions Screen --- */
       #instructionsScreen { display: none; }
       .instructions-container { max-width: 800px; text-align: left; }
       .instructions-container #instructions-title { /* Changed ID */
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #3f51b5;
            padding-bottom: 10px;
            border-bottom: 2px solid #3f51b5;
        }
        .dark .instructions-container #instructions-title {
            color: #8ab4f8;
            border-bottom-color: #8ab4f8;
        }
       .instructions-content {flex-grow: 1;overflow-y: auto; padding: 0; min-height: 0; }
       .instructions-content h2 {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
       .dark .instructions-content h2 {
            color: #eee;
            border-bottom-color: #444;
        }
       .instructions-content ul { list-style: none; padding-left: 0; line-height: 1.8; }
       .instructions-content li { display: flex; align-items: flex-start; margin-bottom: 12px; }
       .instructions-content li i { color: #3f51b5; margin-right: 15px; font-size: 1.2em; margin-top: 6px; min-width: 20px; text-align: center; }
       .dark .instructions-content li i { color: #8ab4f8; }
       .instructions-content strong { color: #d32f2f; font-weight: 600; }
       .dark .instructions-content strong { color: #ef9a9a; }
       .instructions-footer { padding-top: 20px; border-top: 1px solid #eee; }
       .dark .instructions-footer { border-top-color: #444; }
       #offlineStatus { font-weight: 600; text-align: center; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
       .status-waiting { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
       .status-ready { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
       .agreement-group { display: flex; align-items: center; margin-bottom: 15px; }
       #agreementCheckbox { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
       #agreementCheckbox + label { font-size: 0.9em; cursor: pointer; }
       .btn-start-exam:disabled { background: #9fa8da; cursor: not-allowed; }
       .dark .btn-start-exam:disabled { background: #2c3a7a; }
       #startError { color: #d32f2f; text-align: center; height: 1.2em; font-weight: 500; }

       /* --- NEW: Chapter Selection Screen --- */
       #chapterSelectionWrapper {
           display: none; /* Hidden by default */
           width: 100%;
           max-width: 1200px; /* Wider for 3 columns */
           margin: 0 auto;
           text-align: left;
       }
       #chapterSelectionWrapper h1 {
           font-size: 2.5em; /* Larger title */
           font-weight: 800;
           color: #3f51b5;
           margin-bottom: 10px;
           text-align: center;
       }
       .dark #chapterSelectionWrapper h1 {
           color: #8ab4f8;
       }
       #chapterSelectionWrapper p {
           font-size: 1.2em;
           color: #555;
           margin-bottom: 40px;
           text-align: center;
       }
       .dark #chapterSelectionWrapper p {
           color: #ccc;
       }
       .subject-group h2 {
           font-size: 1.8rem;
           font-weight: 700;
           color: #1e293b;
           margin-bottom: 1.5rem;
           padding-bottom: 0.5rem;
           border-bottom: 1px solid #e2e8f0;
       }
       .dark .subject-group h2 {
           color: #eee;
           border-bottom-color: #444;
       }
       .chapter-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* 3-column grid */
           gap: 1.5rem; /* 24px */
       }
       .chapter-card {
           background-color: #ffffff;
           border-radius: 0.75rem;
           border: 1px solid #e2e8f0;
           box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
           transition: all 0.2s ease-in-out;
           display: flex;
           flex-direction: column;
           overflow: hidden;
           text-decoration: none;
       }
       .chapter-card:hover {
           transform: translateY(-4px);
           box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
       }
       .chapter-card-body {
           padding: 1.5rem;
           flex-grow: 1;
       }
       .chapter-title {
           font-weight: 600;
           font-size: 1.125rem;
           color: #1e293b;
           margin-bottom: 0.75rem;
       }
       .chapter-meta {
           display: flex;
           gap: 1rem;
           font-size: 0.875rem;
           color: #64748b;
       }
       .chapter-card-footer {
           background-color: #f8fafc;
           border-top: 1px solid #e2e8f0;
           padding: 1rem 1.5rem;
           display: flex;
           justify-content: flex-end; /* Aligns button to the right */
           align-items: center;
       }
       .btn-start {
           display: inline-flex;
           align-items: center;
           gap: 0.5rem;
           padding: 0.5rem 1rem;
           font-size: 0.875rem;
           font-weight: 600;
           border-radius: 0.5rem;
           transition: all 0.2s;
           background-color: #2563eb;
           color: #ffffff;
           text-decoration: none;
       }
       .btn-start:hover {
           background-color: #1d4ed8;
       }
       .dark .chapter-card {
           background: #2a2a3a;
           border-color: #444;
       }
       .dark .chapter-title {
           color: #eee;
       }
       .dark .chapter-meta {
           color: #aaa;
       }
       .dark .chapter-card-footer {
           background-color: #242434;
           border-top-color: #444;
       }
       /* === END: Chapter Selection Styles === */

       
       /* --- Exam UI Wrapper --- */
       #examUIWrapper { display: none; flex-direction: column; height: 100%; position: relative; }
       
       /* --- Header (from File 2) --- */
       #examUIWrapper .site-header { background: #ffffff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 101; position: relative; }
       #examUIWrapper .site-header .site-branding { flex-direction: column; }
       #examUIWrapper .site-header .site-title { font-size: 1.4em; font-weight: 700; color: #3f51b5; line-height: 1.1; }
       #examUIWrapper .site-header .site-tagline { font-size: 0.8em; color: #666; margin: 0; }
       #examUIWrapper .site-header .site-copyright { margin-left: auto; font-family: "Trebuchet MS", "Segoe UI", Arial, sans-serif; font-size: 10px; font-weight: 600; }
       .dark #examUIWrapper .site-header { background: #2a2a3a; border-bottom-color: #3a3a4a; }
       .dark #examUIWrapper .site-header .site-title { color: #8ab4f8; }
       .dark #examUIWrapper .site-header .site-tagline { color: #aaa; }

       /* --- Topbar (from File 2) --- */
       .topbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px; background: #3f51b5; color: white; gap: 10px; z-index: 100; position: relative; }
       .topbar-left-group,.topbar-right-group { display: flex; align-items: center; gap: 15px; }
       .navigation-tabs { display: flex; gap: 5px; background: rgba(0,0,0,0.15); border-radius: 6px; padding: 3px; position: absolute; left: 50%; transform: translateX(-50%); }
       .nav-tab { background: transparent; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.85em; }
       .nav-tab:hover:not(.locked) { background: rgba(255,255,255,0.2); }
       .nav-tab.active { background: white; color: #3f51b5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
       .nav-tab.locked { cursor: not-allowed; opacity: 0.6; }
       .timer { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
       #stopwatchWrapper { display: none; align-items: center; gap: 10px; }
       #stopwatchWrapper span { font-size: 0.95em; font-weight: bold; }
       .dark-mode-toggle { display: flex; align-items: center; gap: 8px; }
       .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
       .toggle-switch input { opacity: 0; width: 0; height: 0; }
       .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition:.4s; border-radius: 34px; }
       .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition:.4s; border-radius: 50%; }
       input:checked +.toggle-slider { background-color: #4caf50; }
       input:checked +.toggle-slider:before { transform: translateX(24px); }
       .toggle-label { font-size: 0.9em; white-space: nowrap; }
       .topbar #btnSubmitTest { background: #f44336; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; padding: 8px 15px; }
       .sidebar-toggle { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; font-size: 0.9em; padding: 5px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
       .sidebar-toggle:hover { background-color: rgba(255,255,255,0.2); }
       .sidebar-open .sidebar-toggle { transform: rotate(180deg); }

       /* --- Main Content (from File 2) --- */
       .main-content { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 5; }
       .question-area { width: 100%; padding: 20px; overflow-y: auto; padding-bottom: 100px; transition: padding-right 0.3s ease, filter 0.3s ease; position: relative; z-index: 5; }
       .sidebar-open .question-area { filter: blur(4px); pointer-events: none; }
       .question-header { font-size: 1.2em; margin-bottom: 15px; font-weight: 600; }
       .question-timer-bar-container { display: none; /* Hiding 15s timer */ }
       .question-content { margin-bottom: 20px; line-height: 1.6; font-size: 1.05em; } /* Made font slightly larger */
       .options-list { list-style: none; display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0; }
       .option { padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 1em; position: relative; } /* Made font slightly larger */
       .option:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
       .option.selected { background: #4caf50; color: white; border-color: #4caf50; box-shadow: 0 2px 5px rgba(76,175,80,0.3); }
       .option-radio { margin-right: 12px; min-width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; display: inline-block; position: relative; }
       .option.selected .option-radio { border-color: white; background: white; box-shadow: inset 0 0 0 4px #4caf50; }
       .dark .option { background: #2c2c3c; border-color: #444; color: #eee; }
       .dark .option:hover { background: #3d3d4a; }
       .dark .option.selected { background: #1b5e20; color: #c8e6c9; border-color: #81c784; }
       .dark .option.selected .option-radio { border-color: #c8e6c9; background: #c8e6c9; box-shadow: inset 0 0 0 4px #1b5e20; }
       .dark .option-radio { border-color: #555; }

       /* --- Sidebar (from File 2) --- */
       .sidebar { position: fixed; top: 111px; right: -300px; width: 300px; height: calc(100% - 111px); background: #f8f9fa; border-left: 1px solid #ccc; display: flex; flex-direction: column; transition: right 0.3s ease-in-out; z-index: 200; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
       .sidebar-open .sidebar { right: 0; }
       .sidebar-content { padding: 15px; overflow-y: auto; flex-grow: 1;}
       .palette-title { font-weight: 600; margin-bottom: 10px; color: #3f51b5; font-size: 1.1em; text-align: center; }
       .question-palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px; margin-bottom: 20px; }
       .question-number { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid transparent; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 13px; margin: 0 auto; }
       .question-number:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
       .answered { background: #4caf50; color: white; border: 1px solid #388e3c;}
       .not-answered { background: #f44336; color: white; border: 1px solid #d32f2f;}
       .marked { background: #ff9800; color: white; border: 1px solid #f57c00;}
       .marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); color: white; border: 1px solid #f57c00; }
       .not-visited { background: #e9ecef; color: #333; border: 1px solid #ddd;}
       .current { border: 2px solid #3f51b5; transform: scale(1.1); }
       .palette-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; padding: 12px; background: #e0e0e0; border-radius: 6px; font-size: 0.8em; }
       .summary-item { display: flex; align-items: center; gap: 8px; color: #333; }
       .summary-item span { font-weight: 700; background-color: #fff; border-radius: 50%; min-width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
       .legend { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;}
       .legend-title { font-weight: 600; margin-bottom: 12px; color: #3f51b5; font-size: 1em; }
       .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85em; padding: 6px 8px; border-radius: 4px; }
       .legend-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 10px; flex-shrink: 0; }
       .legend-answered { background: #4caf50; }
       .legend-not-answered { background: #f44336; }
       .legend-marked { background: #ff9800; }
       .legend-marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); }
       .legend-not-visited { background: #e9ecef; border: 1px solid #ccc; }
       .dark .sidebar { background: #2a2a3a; border-left: 1px solid #444;}
       .dark .not-visited { background: #3d3d4a; color: #eee; border: 1px solid #555; }
       .dark .palette-summary { background: #1e1e2f; border: 1px solid #444;}
       .dark .summary-item { color: #ccc; }
       .dark .summary-item span { background-color: #3d3d4a; color: #eee; }
       .dark .legend,.dark .fixed-action-area { border-top-color: #444; }
       .dark .legend-item { background: rgba(255,255,255,0.05); }
       .dark .palette-title,.dark .legend-title { color: #8ab4f8; }

       /* --- Footer (from File 2) --- */
       .fixed-action-area { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ccc; padding: 10px 15px; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
       .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
       .btn-action { padding: 8px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85em; flex-grow: 1; flex-basis: 0; }
       .btn-action:hover { opacity: 0.85; }
       #btnPrevQuestion { background: #6c757d; color: white; }
       #btnSaveNext { background: #4caf50; color: white; }
       #btnMarkReview { background: #ff9800; color: white; }
       #btnClearResponse { background: #f44336; color: white; }
       .submit-button.btn-action { background: #3f51b5; color: white; padding: 10px 25px; flex-grow: 0; }
       .dark .fixed-action-area { background: #1e1e2f; border-top-color: #444;}

       /* --- Result Screen (from File 2) --- */
       #resultScreenWrapper { display: none; text-align: center; padding: 20px; flex-direction: column; align-items: center; justify-content: flex-start; flex: 1; overflow-y: auto; position: relative;}
       #resultScreenWrapper h2 { font-size: 2.5em; color: #3f51b5; margin-bottom: 5px; }
       #resultScreenWrapper p { font-size: 1.2em; margin-bottom: 20px; }
       .scorecard-details { width: 100%; max-width: 500px; margin: 25px auto; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
       .scorecard-table { width: 100%; border-collapse: collapse; font-size: 1.1em; }
       .scorecard-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
       .scorecard-table tr:last-child td { border-bottom: none; }
       .scorecard-table td:first-child { text-align: left; font-weight: 500; color: #555; }
       .scorecard-table td:last-child { text-align: right; font-weight: 700; }
       .scorecard-table .correct-val { color: #4caf50; }
       .scorecard-table .incorrect-val { color: #f44336; }
       .scorecard-table .unattempted-val { color: #ff9800; }
       .scorecard-table .total-row td { font-size: 1.2em; border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 5px; }
       .scorecard-table .total-val { color: #3f51b5; }
       .dark .scorecard-details { background: #2a2a3a; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
       .dark .scorecard-table td { border-bottom-color: #3a3a4a; }
       .dark .scorecard-table td:first-child { color: #ccc; }
       .dark .scorecard-table .correct-val { color: #81c784; }
       .dark .scorecard-table .incorrect-val { color: #ef9a9a; }
       .dark .scorecard-table .unattempted-val { color: #ffd54f; }
       .dark .scorecard-table .total-row td { border-top-color: #555; }
       .dark .scorecard-table .total-val { color: #8ab4f8; }
       .dark #resultScreenWrapper h2 { color: #8ab4f8; }
       .result-buttons { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 30px; margin-bottom: 30px; justify-content: center; }
       #syncStatus { margin-top: 10px; font-weight: 500; font-size: 0.95em; padding: 8px 12px; border-radius: 6px; }
       #syncStatus.syncing { color: #1565c0; background-color: #e3f2fd; }
       #syncStatus.synced { color: #2e7d32; background-color: #e8f5e9; }
       #syncStatus.error { color: #c62828; background-color: #ffebee; }
       
       /* --- Review Screen (from File 2) --- */
       #reviewScreenWrapper { display: none; width: 100%; flex-direction: column; position: relative;}
       .review-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
       #reviewContainer { padding: 20px; overflow-y: auto; flex-grow: 1; background-color: #f0f0f5; }
       .review-question { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
       .review-option-list { list-style: none; padding: 0; margin-top: 15px; }
       .review-option { padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; }
       .review-option i { min-width: 1.2em; text-align: center; }
       .review-option.review-correct { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; font-weight: 500; }
       .review-option.review-incorrect { background-color: #ffebee; border-color: #ef9a9a; color: #b71c1c; }
       .review-status { margin-top: 15px; padding: 8px 12px; border-radius: 6px; font-weight: 500; text-align: center; border: 1px solid transparent; }
       .review-status.correct { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; }
       .review-status.incorrect { background-color: #ffebee; border-color: #ef9a9a; color: #c62828; }
       .review-status.unanswered { background-color: #fff3e0; border-color: #ffcc80; color: #e65100; }
       .review-explanation { margin-top: 20px; padding: 15px; background: #eef2ff; border-left: 4px solid #3f51b5; border-radius: 4px; font-size: 0.9em; line-height: 1.6; }
       .review-explanation strong { color: #3f51b5; }
       .dark .review-header { background: #2a2a3a; border-color: #444; }
       .dark #reviewContainer { background-color: #1e1e2f; }
       .dark .review-question { background: #2c2c3c; border-color: #444; }
       .dark .review-option { border-color: #555; }
       .dark .review-option.review-correct { background-color: #1a311b; border-color: #81c784; color: #c8e6c9; }
       .dark .review-option.review-incorrect { background-color: #3e1c1f; border-color: #ef9a9a; color: #ffcdd2; }
       .dark .review-status.correct { background-color: #1a311b; border-color: #4caf50; color: #c8e6c9; }
       .dark .review-status.incorrect { background-color: #3e1c1f; border-color: #f44336; color: #ffcdd2; }
       .dark .review-status.unanswered { background-color: #4a2c0f; border-color: #ff9800; color: #ffe0b2; }
       .dark .review-explanation { background: #262a42; border-left-color: #8ab4f8; color: #ccc; }
       .dark .review-explanation strong { color: #8ab4f8; }
       
       /* --- Other Modals & Loader (from File 2) --- */
       .password-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;}
       .modal-content { background-color: #fefefe; padding: 25px 35px; border: 1px solid #888; width: 90%; max-width: 420px; border-radius: 12px; text-align: center; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
       .close-modal { position: absolute; top: 10px; right: 20px; font-size: 1.8em; color: #aaa; cursor: pointer; transition: color 0.2s; }
       .close-modal:hover { color: #333; }
       #passwordRetestInput { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
       #passwordError { color: #f44336; font-size: 0.9em; height: 1.2em; margin-bottom: 10px;}
       .dark .modal-content { background: #2c2c3c; border-color: #555; }
       .dark .close-modal:hover { color: #fff; }

       #loader { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center; }
       .dark #loader { background: rgba(30, 30, 47, 0.8); }
       .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3f51b5; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
       .dark .spinner { border-color: #444; border-top-color: #8ab4f8; }
       @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

       @media (max-width: 768px) {
         #examUIWrapper .site-header { flex-direction: column; text-align: center; gap: 5px; }
         .topbar { flex-wrap: wrap; justify-content: center; }
         .navigation-tabs { position: static; transform: none; order: 3; width: 100%; justify-content: center; margin-top: 10px; }
         .sidebar-open .question-area { padding-right: 20px; }
       }
       @media (max-width: 480px) {
         .btn-action span { display: none; }
       }
    </style>
</head>
<body class="light-mode"> <div id="loader">
        <div class="spinner"></div>
    </div>

    <div class="pre-exam-screen" id="preExamScreen">
        
        <div id="chapterSelectionWrapper">
             <header class="site-header" style="padding-left: 0; padding-right: 0;">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            <h1>NCERT Chapter-wise Tests</h1>
            <p>Master every subject, one chapter at a time. Select a test to begin.</p>
            
            <div id="chapterGridContainer">
                </div>
        </div>

        <div class="login-card" id="loginScreen">
            <header class="site-header">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            <h2>Exam Portal Login</h2>
            <p id="testTitle">Loading test details...</p>
            <div id="loginError"></div>
            <button id="loginBtn" class="btn-primary">
                <i class="fa-brands fa-google"></i> &nbsp; Sign in with Google to Start
            </button>
        </div>

        <div class="instructions-container" id="instructionsScreen">
            <header class="site-header" style="display: none;">
                <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
                <span class="site-copyright">Powered By UPSChub<br>Pratyush swain (Creater & Writer)</span>
            </header>
            
            <h2 id="instructions-title">Test Instructions</h2>
            
            <div class="instructions-content">
                <h2>General Instructions:</h2>
                <ul>
                    <li><i class="fas fa-list-ol"></i><div>Total Questions: <strong id="totalQuestionsEl">--</strong>.</div></li>
                    <li><i class="fas fa-clock"></i><div>Total Duration: <strong id="durationEl">-- Minutes</strong>.</div></li>
                    <li><i class="fas fa-check-double"></i><div>Marking Scheme: <strong id="marksPerQEl">+2</strong> for a correct answer, <strong id="negativeMarksEl">-0.66</strong> for an incorrect answer, and <strong>0</strong> for unattempted.</div></li>
                </ul>
                
                <h2>Security & Environment:</h2>
                <ul>
                    <li><i class="fas fa-wifi"></i><div>An internet connection is required to start and submit the test.</div></li>
                    <li><i class="fas fa-window-close"></i><div>Do not close or refresh the browser window, as this will end your test.</div></li>
                </ul>
                
                <h2>Navigation Instructions:</h2>
                <ul>
                    <li><i class="fas fa-check" style="color:#4caf50;"></i><div>Click <strong>Save & Next</strong> to save your answer and move to the next question.</div></li>
                    <li><i class="fas fa-flag" style="color:#ff9800;"></i><div>Click <strong>Mark</strong> to mark a question for review. Marked answers ARE evaluated.</div></li>
                </ul>
            </div>
            
            <div class="instructions-footer">
                <div id="offlineStatus" class="status-ready"><i class="fas fa-wifi"></i> Connecting...</div>
                <div class="agreement-group">
                    <input type="checkbox" id="agreementCheckbox">
                    <label for="agreementCheckbox">I have read and understood all the instructions.</label>
                </div>
                <button id="startExamBtn" class="btn-primary btn-start-exam" disabled>Start Exam</button>
                <div id="startError"></div>
            </div>
        </div>

        <div class="submitting-card" id="submittingScreen" style="display: none;">
            <h2>Submitting Test...</h2>
            <p>Please wait while we process your results. Do not close or refresh this window.</p>
            <div class="spinner" style="margin: 20px auto;"></div>
        </div>

    </div>

    <div id="examUIWrapper">
        <header class="site-header" id="siteHeader">
            <img src="images/LOGO.jpg" alt="UPSChub Logo" class="site-logo">
            <div class="site-branding">
                 <span class="site-title" id="examHeaderTitle">NCERT Test</span>
                 <p class="site-tagline">UPSC Civil Services Exam Preparation</p>
            </div>
             <div class="site-copyright">Copyright © 2025 Pratyush Swain</div>
        </header>
        <header class="topbar" id="topbar">
            <div class="topbar-left-group">
                <button id="btnToggleSidebar" class="sidebar-toggle" title="Toggle Palette"><i class="fas fa-chevron-left"></i></button>
                <div class="timer" id="timerDisplay">00:00:00</div>
                <div id="stopwatchWrapper">
                    <span id="stopwatchDisplay">00:00:00</span>
                </div>
            </div>
            <div class="navigation-tabs">
                <button id="showMockTestTab" class="nav-tab active">Mock Test</button>
            </div>
            <div class="topbar-right-group">
                <div class="dark-mode-toggle">
                    <span class="toggle-label" id="toggleLabel">Dark</span>
                    <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label>
                </div>
                <button id="btnSubmitTest" style="display: none;"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
        </header>
        
        <div class="main-content" id="main-content">    
            
            <div id="mockTestWrapper" style="display: flex; width: 100%;">
                <section class="question-area">
                    <h2 class="question-header" id="questionNumber">Question 1</h2>
                    <div class="question-content" id="questionText">Loading question...</div>
                    <ul class="options-list" id="optionsList">
                        </ul>
                </section>
                
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-content">
                        <div class="palette-title">Question Palette</div>
                        <div class="question-palette" id="questionPalette">
                            </div>
                        <div class="palette-summary">
                            <div class="summary-item"><span id="summaryAnswered">0</span> Answered</div>
                            <div class="summary-item"><span id="summaryNotAnswered">0</span> Not Answered</div>
                            <div class="summary-item"><span id="summaryMarked">0</span> Marked Review</div>
                            <div class="summary-item"><span id="summaryNotVisited">0</span> Not Visited</div>
                        </div>
                        <div class="legend">
                            <div class="legend-title">Legend</div>
                            <div class="legend-item"><div class="legend-color answered"></div><span>Answered</span></div>
                            <div class="legend-item"><div class="legend-color not-answered"></div><span>Not Answered</span></div>
                            <div class="legend-item"><div class="legend-color marked"></div><span>Marked</span></div>
                            <div class="legend-item"><div class="legend-color marked-answered"></div><span>Marked & Answered</span></div>
                            <div class="legend-item"><div class="legend-color not-visited"></div><span>Not Visited</span></div>
                        </div>
                    </div>
                </aside>
            </div>
            
            <div id="resultScreenWrapper">
                <h2 id="resultScreenTitle">Test Completed!</h2>
                <p id="resultScreenSubtitle">Here is your score summary:</p>
                
                <div id="syncStatus"></div>

                <div class="scorecard-details">
                    <table class="scorecard-table">
                        <tbody>
                            <tr>
                                <td><i class="fas fa-check-circle" style="color: #4caf50; margin-right: 8px;"></i>Correct Answers</td>
                                <td class="correct-val"><span id="correctCount">0</span> (<span id="correctMarks">0</span> Marks)</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-times-circle" style="color: #f44336; margin-right: 8px;"></i>Incorrect Answers</td>
                                <td class="incorrect-val"><span id="incorrectCount">0</span> (<span id="incorrectMarks">0</span> Marks)</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-minus-circle" style="color: #ff9800; margin-right: 8px;"></i>Unattempted</td>
                                <td class="unattempted-val"><span id="unattemptedCount">0</span></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Final Score</strong></td>
                                <td class="total-val"><strong><span id="finalScoreAnimated">0</span> / <span id="totalPossibleScore">0</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="result-buttons" id="resultButtonsContainer">
                     <button id="retestButton" class="submit-button btn-action"><i class="fas fa-redo"></i> Retest</button>
                     <button id="reviewAnswersButton" class="submit-button btn-action"><i class="fas fa-search"></i> Review Answers</button>
                     <button onclick="window.location.href = 'testncert_page.html'" class="submit-button btn-action"><i class="fas fa-list"></i> Test Menu</button>
                </div>
                
                <div class="chart-container" id="chartContainer" style="display: none;"><canvas id="performanceChart"></canvas></div>
            </div>
            
            <div id="reviewScreenWrapper">
                <div class="review-header"><h2 class="review-title">Review Your Answers</h2><button id="backToResultsBtn" class="submit-button btn-action"><i class="fas fa-arrow-left"></i> Back to Score</button></div>
                <div id="reviewContainer"></div>
            </div>

        </div>
        
        <div class="fixed-action-area" id="mcqFooter">
            <div class="action-buttons">
                <button class="btn-action" id="btnPrevQuestion"><i class="fas fa-arrow-left"></i><span>Previous</span></button>
                <button class="btn-action" id="btnClearResponse"><i class="fas fa-ban"></i><span>Clear</span></button>
                <button class="btn-action" id="btnMarkReview"><i class="fas fa-flag"></i><span>Mark</span></button>
                <button class="btn-action" id="btnSaveNext"><i class="fas fa-check"></i><span>Save & Next</span></button>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="password-modal">
        <div class="modal-content">
            <span id="closeModal" class="close-modal">×</span>
            <h3>Enter Password to Retest</h3>
            <p style="font-size: 0.9em; color: #666;">Retest requires an internet connection to clear old results.</p>
            <input type="password" id="passwordRetestInput" placeholder="Enter password...">
            <div id="passwordError"></div>
            <button id="verifyPasswordButton" class="submit-button btn-action">Verify</button>
        </div>
    </div>


    <script>
        // ### CONFIGURATION ###
        const RETEST_PASSWORD = "UPSChub"; // Password for retest
        const appId = 'default-app-id'; // From your other script
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoPtr3d8se-fcGXkzixG8OE7dFvYjPcs4", 
            authDomain: "upscstudyhub-github.firebaseapp.com", 
            projectId: "upscstudyhub-github", 
            storageBucket: "upscstudyhub-github.appspot.com", 
            messagingSenderId: "451692540885", 
            appId: "1:451692540885:web:b425e85128e5de97c7c35c" 
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- Global State ---
        let currentUser = null;
        let currentTest = null;
        let questions = [];
        // NEW state management for 'testweekly' UI
        let state = { current: 0, answers: [], marked: [], visited: [] };
        let userAnswers = {}; // For session resume
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let testStartTime = null;
        let testSessionId = null;
        let animationInterval = null;
        let mainTestId = null; // Will hold the testId from URL

        // --- DOM Elements (Adapted for new UI) ---
        const $ = (selector) => document.getElementById(selector);
        
        // Pre-Exam Screens
        const preExamScreen = $('preExamScreen');
        const chapterSelectionWrapper = $('chapterSelectionWrapper');
        const chapterGridContainer = $('chapterGridContainer');
        const loginScreen = $('loginScreen');
        const loginBtn = $('loginBtn');
        const loginError = $('loginError');
        const testTitle = $('testTitle');
        const instructionsScreen = $('instructionsScreen');
        const instructionsTitle = $('instructions-title'); // Corrected ID
        const totalQuestionsEl = $('totalQuestionsEl'); // Corrected ID
        const durationEl = $('durationEl'); // Corrected ID
        const marksPerQEl = $('marksPerQEl'); // Corrected ID
        const negativeMarksEl = $('negativeMarksEl'); // Corrected ID
        const agreementCheckbox = $('agreementCheckbox');
        const startExamBtn = $('startExamBtn');
        const startError = $('startError');
        const submittingScreen = $('submittingScreen');
        const loader = $('loader');

        // Exam UI
        const examUIWrapper = $('examUIWrapper');
        const examHeaderTitle = $('examHeaderTitle');
        const timerDisplay = $('timerDisplay');
        const stopwatchWrapper = $('stopwatchWrapper');
        const darkModeToggle = $('darkModeToggle');
        const toggleLabel = $('toggleLabel');
        const btnToggleSidebar = $('btnToggleSidebar');
        
        // Main Content
        const mockTestWrapper = $('mockTestWrapper');
        const questionArea = document.querySelector('.question-area');
        const questionNumber = $('questionNumber');
        const questionText = $('questionText');
        const optionsList = $('optionsList');
        
        // Sidebar
        const sidebar = $('sidebar');
        const questionPalette = $('questionPalette');
        const summaryAnswered = $('summaryAnswered');
        const summaryNotAnswered = $('summaryNotAnswered');
        const summaryMarked = $('summaryMarked');
        const summaryNotVisited = $('summaryNotVisited');
        
        // Footer Buttons
        const mcqFooter = $('mcqFooter');
        const btnPrevQuestion = $('btnPrevQuestion');
        const btnSaveNext = $('btnSaveNext');
        const btnMarkReview = $('btnMarkReview');
        const btnClearResponse = $('btnClearResponse');
        const btnSubmitTest = $('btnSubmitTest'); // Top submit button

        // Result Screen
        const resultScreenWrapper = $('resultScreenWrapper');
        const resultScreenTitle = $('resultScreenTitle');
        const correctCount = $('correctCount');
        const correctMarks = $('correctMarks');
        const incorrectCount = $('incorrectCount');
        const incorrectMarks = $('incorrectMarks');
        const unattemptedCount = $('unattemptedCount');
        const finalScoreAnimated = $('finalScoreAnimated');
        const totalPossibleScore = $('totalPossibleScore');
        const resultButtonsContainer = $('resultButtonsContainer');
        const syncStatus = $('syncStatus');

        // Review Screen
        const reviewScreenWrapper = $('reviewScreenWrapper');
        const reviewContainer = $('reviewContainer');
        const backToResultsBtn = $('backToResultsBtn');

        // Password Modal
        const passwordModal = $('passwordModal');
        const closeModal = $('closeModal');
        const verifyPasswordButton = $('verifyPasswordButton');
        const passwordRetestInput = $('passwordRetestInput');
        const passwordError = $('passwordError');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoader(true, 'Initializing...');
            const urlParams = new URLSearchParams(window.location.search);
            mainTestId = urlParams.get('testId'); // Store testId globally
            
            // Persist auth state
            auth.onAuthStateChanged(user => {
                currentUser = user; 
                
                if (mainTestId) {
                    // *** LOGIC 1: A testId IS in the URL ***
                    if (user) {
                        showLoader(true, 'Fetching user data...');
                        loadSingleTest(mainTestId);
                    } else {
                        showLoader(false);
                        showLoginScreen(mainTestId);
                    }
                } else {
                    // *** LOGIC 2: NO testId in the URL ***
                    showTestSelectionScreen();
                }
            });

            // Dark Mode
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark') {
                darkModeToggle.checked = true;
                toggleDarkMode(true);
            }
            darkModeToggle.addEventListener('change', (e) => {
                toggleDarkMode(e.target.checked);
                localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
            });

            // Exam Listeners
            agreementCheckbox.addEventListener('change', validateStartConditions);
            startExamBtn.addEventListener('click', startExam);
            btnSubmitTest.addEventListener('click', () => confirmSubmit(false));
            
            // Footer Listeners
            btnSaveNext.addEventListener('click', saveAndNext);
            btnPrevQuestion.addEventListener('click', prevQuestion);
            btnMarkReview.addEventListener('click', markForReview);
            btnClearResponse.addEventListener('click', clearResponse);

            // UI Listeners
            btnToggleSidebar.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-open');
                btnToggleSidebar.querySelector('i').classList.toggle('fa-chevron-left');
                btnToggleSidebar.querySelector('i').classList.toggle('fa-chevron-right');
            });
            backToResultsBtn.addEventListener('click', () => {
                reviewScreenWrapper.style.display = 'none';
                resultScreenWrapper.style.display = 'flex';
            });
            
            // Result Button Listeners (dynamic)
            resultButtonsContainer.addEventListener('click', (e) => {
                if (e.target.id === 'retestButton' || e.target.closest('#retestButton')) {
                    passwordModal.style.display = 'flex';
                }
                if (e.target.id === 'reviewAnswersButton' || e.target.closest('#reviewAnswersButton')) {
                    resultScreenWrapper.style.display = 'none';
                    reviewScreenWrapper.style.display = 'flex';
                }
            });

            // Modal Listeners
            closeModal.addEventListener('click', () => { passwordModal.style.display = 'none'; });
            verifyPasswordButton.addEventListener('click', handleRetest);

            // Prevent accidental navigation
            window.addEventListener('beforeunload', (e) => {
                if (testSessionId && resultScreenWrapper.style.display === 'none') {
                    const confirmationMessage = 'Are you sure you want to leave? Your progress will be saved, but the test will not be submitted.';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
            
            // Offline/Online status for instructions
            window.addEventListener('online', validateStartConditions);
            window.addEventListener('offline', validateStartConditions);
        });
        
        // --- NEW: Chapter Selection Logic ---
        async function showTestSelectionScreen() {
            showLoader(true, 'Loading available tests...');
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'block';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            examUIWrapper.style.display = 'none';
            
            let tests = [];
            try {
                // Fetch all test documents from 'ncertTests'
                const querySnapshot = await firestore.collection("ncertTests").get();
                tests = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Error fetching ncertTests: ", error);
                chapterGridContainer.innerHTML = `<p style="color: red; text-align: center;">Could not load tests. Check Firestore rules for 'ncertTests'.</p>`;
                showLoader(false);
                return;
            }

            if (tests.length === 0) {
                chapterGridContainer.innerHTML = `<p style="color: #555; text-align: center;">No tests are available in the 'ncertTests' collection yet.</p>`;
                showLoader(false);
                return;
            }

            // Group tests by their 'subject' field
            const subjectsMap = new Map();
            tests.forEach(test => {
                const subjectName = test.subject || "Uncategorized"; // Use 'subject' field
                if (!subjectsMap.has(subjectName)) {
                    subjectsMap.set(subjectName, []);
                }
                subjectsMap.get(subjectName).push(test);
            });

            // Render the HTML
            let allHtml = '';
            const sortedSubjectNames = [...subjectsMap.keys()].sort();

            for (const subjectName of sortedSubjectNames) {
                const subjectTests = subjectsMap.get(subjectName);
                
                allHtml += `
                    <section class="subject-group">
                        <h2>${subjectName}</h2>
                        <div class="chapter-grid">
                `;

                // Sort tests by title
                subjectTests.sort((a, b) => (a.title || '').localeCompare(b.title || ''));

                subjectTests.forEach((test, index) => {
                    const testId = test.id;
                    const chapterTitle = test.title || 'Untitled Test';
                    const totalQuestions = test.totalQuestions || 0;
                    const durationMinutes = test.durationMinutes || 0;
                    
                    // Create an <a> tag that links to this same page, but with a testId
                    allHtml += `
                        <a href="testncert_page.html?testId=${testId}" class="chapter-card">
                            <div class="chapter-card-body">
                                <h3 class="chapter-title">${chapterTitle}</h3>
                                <div class="chapter-meta">
                                    <span>${totalQuestions} Questions</span>
                                    <span>${durationMinutes} Minutes</span>
                                </div>
                            </div>
                            <div class="chapter-card-footer">
                                <span class="btn btn-start">
                                    Start Test
                                    <svg style="width:1rem; height:1rem; margin-left: 0.5rem;" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" /></svg>
                                </span>
                            </div>
                        </a>
                    `;
                });
                
                allHtml += '</div></section>';
            }
            
            chapterGridContainer.innerHTML = allHtml;
            showLoader(false);
        }
        
        function validateStartConditions() {
            const isOffline = !navigator.onLine;
            const isAgreed = agreementCheckbox.checked;
            
            // MODIFIED: This test is ONLINE
            // We just check for agreement
            const isOnline = navigator.onLine;
            startExamBtn.disabled = !(isOnline && isAgreed);
            
            let errorMsg = '';
            if (!isOnline) errorMsg = 'Please connect to the internet to start the test.';
            else if (!isAgreed) errorMsg = 'Please agree to the instructions to start.';
            startError.textContent = errorMsg;
            
            const offlineStatus = $('offlineStatus');
            if (isOnline) {
                offlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> You are online. Ready to begin.';
                offlineStatus.className = 'status-ready';
            } else {
                offlineStatus.innerHTML = '<i class="fas fa-wifi"></i> Please connect to the internet.';
                offlineStatus.className = 'status-waiting';
            }
        }

        function showLoader(show, text = 'Loading...') {
            if (show) {
                loader.style.display = 'flex';
            } else {
                loader.style.display = 'none';
            }
        }

        function showError(message, element = loginError) {
            element.textContent = message;
        }
        
        function handleLoadError(error) {
            console.error("Fatal error loading test:", error);
            showLoader(false);
            
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'none';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            examUIWrapper.style.display = 'none';

            preExamScreen.innerHTML = `
                <div class="login-card" style="max-width: 550px;">
                    <h2 style="color: #3f51b5; font-size: 1.8em;">Error</h2>
                    <p style="font-size: 1.1em; color: #555; margin-top: 15px; margin-bottom: 15px;">Could not load test data.</p>
                    <p style="font-size: 0.9em; color: #777; margin-bottom: 25px;">${error.message}</p>
                    <a href="testncert_page.html" class="btn-primary" style="text-decoration: none; display: block; width: 100%;">Back to Test Menu</a>
                </div>
            `;
        }

        function showLoginScreen(testId) {
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'none';
            loginScreen.style.display = 'block';
            instructionsScreen.style.display = 'none';
            examUIWrapper.style.display = 'none';
            testTitle.textContent = `Loading test: ${testId}...`;
        }

        function showInstructionsScreen() {
            preExamScreen.style.display = 'flex';
            chapterSelectionWrapper.style.display = 'none';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'flex';
            examUIWrapper.style.display = 'none';

            // Populate instructions
            instructionsTitle.textContent = `${currentTest.title} - Instructions`;
            durationEl.textContent = `${currentTest.durationMinutes || 'N/A'} Minutes`;
            totalQuestionsEl.textContent = currentTest.totalQuestions || 'N/A';
            marksPerQEl.textContent = `+${currentTest.marksPerQuestion || 2}`;
            negativeMarksEl.textContent = `${currentTest.negativeMarks * -1}`;
            
            // Check online status for instructions page
            validateStartConditions();
        }

        // --- Authentication ---
        function handleLogin() {
            showLoader(true, 'Signing in...');
            auth.signInWithPopup(provider)
                .catch(error => {
                    showError(`Login failed: ${error.message}`);
                    showLoader(false);
                });
            // onAuthStateChanged will handle the successful login
        }
        
        // --- Data Fetching ---
        async function loadSingleTest(testId) {
            if (!currentUser) {
                showLoginScreen(testId);
                return;
            }
            
            showLoader(true, 'Loading test data...');
            try {
                const docRef = firestore.collection('ncertTests').doc(testId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    throw new Error('Test not found in ncertTests collection.');
                }

                currentTest = { id: doc.id, ...doc.data() };
                
                // *** ADAPTED TO YOUR DATABASE ***
                currentTest.duration = currentTest.durationMinutes || 30;
                currentTest.totalQuestions = currentTest.totalQuestions || (currentTest.questions ? currentTest.questions.length : 0);
                currentTest.marksPerQuestion = currentTest.marksPerQuestion || 2;
                currentTest.negativeMarks = currentTest.negativeMarks !== undefined ? currentTest.negativeMarks : 0.66;
                
                if (!currentTest.questions || currentTest.questions.length === 0) {
                    throw new Error('Test contains no questions or questions are not in an array.');
                }
                questions = currentTest.questions;
                currentTest.totalQuestions = questions.length; // Ensure this is correct
                testTitle.textContent = `Test: ${currentTest.title}`;

                await checkIncompleteSession(testId);
                
            } catch (error) {
                handleLoadError(error); 
            }
        }
        
        async function checkIncompleteSession(testId) {
            try {
                const sessionQuery = await firestore.collection('testSessions')
                    .where('userId', '==', currentUser.uid)
                    .where('testId', '==', testId)
                    .where('status', '==', 'started')
                    .orderBy('startTime', 'desc')
                    .limit(1)
                    .get();

                if (!sessionQuery.empty) {
                    const session = sessionQuery.docs[0];
                    const sessionData = session.data();
                    
                    if (confirm('You have an incomplete test session. Do you want to resume it?')) {
                        // Resume session
                        testSessionId = session.id;
                        userAnswers = sessionData.userAnswers || {};
                        currentQuestionIndex = sessionData.currentQuestionIndex || 0;
                        testStartTime = sessionData.startTime.toDate();
                        
                        // Handle timer
                        if (currentTest.duration) {
                            const elapsedTime = (new Date() - testStartTime) / 1000;
                            const remainingTime = (currentTest.duration * 60) - elapsedTime;
                            if (remainingTime > 0) {
                                startTimer(remainingTime);
                            } else {
                                submitExam(true); 
                                return;
                            }
                        } else {
                            // No timer mode
                            timerDisplay.style.display = 'none';
                            stopwatchWrapper.style.display = 'block';
                            startStopwatch(sessionData.stopwatchTime || 0);
                        }
                        
                        showExamUI();
                        showLoader(false);
                        return;
                    }
                }
                
                showInstructionsScreen();
                showLoader(false);

            } catch (error) {
                // This is the "Missing Index" error
                handleLoadError(error);
            }
        }

        // --- Exam Logic (Adapted for new UI) ---
        async function startExam() {
            if (startExamBtn.disabled) return;
            
            showLoader(true, 'Starting exam...');
            testStartTime = new Date();
            testSessionId = `ts_${currentUser.uid}_${currentTest.id}_${testStartTime.getTime()}`;
            
            // Reset state
            userAnswers = {};
            currentQuestionIndex = 0;
            state = { 
                current: 0, 
                answers: Array(questions.length).fill(null), 
                marked: Array(questions.length).fill(false), 
                visited: Array(questions.length).fill(false) 
            };

            try {
                // Create a 'testSessions' document
                await firestore.collection('testSessions').doc(testSessionId).set({
                    userId: currentUser.uid,
                    testId: currentTest.id,
                    testTitle: currentTest.title,
                    startTime: firebase.firestore.Timestamp.fromDate(testStartTime),
                    status: 'started',
                    userAnswers: {},
                    currentQuestionIndex: 0
                });
                
                showExamUI();

                if (currentTest.duration && currentTest.duration > 0) {
                    timerDisplay.style.display = 'block';
                    stopwatchWrapper.style.display = 'none';
                    startTimer(currentTest.duration * 60);
                } else {
                    timerDisplay.style.display = 'none';
                    stopwatchWrapper.style.display = 'flex';
                    startStopwatch(0);
                }
                
                // Add online listener to force submit
                // window.addEventListener('online', forceSubmitOnReconnect); // You wanted online, so this is not needed

            } catch (error) {
                console.error("Error starting exam session: ", error);
                showError(`Failed to start test: ${error.message}`, startError);
            } finally {
                showLoader(false);
            }
        }

        function showExamUI() {
            preExamScreen.style.display = 'none';
            examUIWrapper.style.display = 'flex';
            resultScreenWrapper.style.display = 'none';
            reviewScreenWrapper.style.display = 'none';
            mockTestWrapper.style.display = 'flex'; // Show test area
            mcqFooter.style.display = 'block';
            sidebar.style.display = 'flex';
            
            examHeaderTitle.textContent = currentTest.title || 'NCERT Test';
            document.body.classList.add('exam-active');
            
            // Set initial state
            state.visited[0] = true;

            buildPalette();
            displayQuestion(currentQuestionIndex);
            updateSidebarPosition();
        }

        function startTimer(durationInSeconds) {
            let remainingTime = durationInSeconds;
            clearInterval(timerInterval); // Clear any existing timer
            timerInterval = setInterval(() => {
                remainingTime--;
                timerDisplay.textContent = formatTime(remainingTime);
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'Time Up!';
                    submitExam(true); // Auto-submit
                }
            }, 1000);
        }
        
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startStopwatch(startTime = 0) {
            // This UI doesn't use a stopwatch by default, but the logic is here.
            stopwatchTime = startTime;
            clearInterval(stopwatchInterval);
            stopwatchInterval = setInterval(() => {
                stopwatchTime++;
                $('stopwatchDisplay').textContent = formatTime(stopwatchTime);
            }, 1000);
        }
        
        function updateSidebarPosition() {
           const headerHeight = $('siteHeader').offsetHeight;
           const topbarHeight = $('topbar').offsetHeight;
           const totalHeaderHeight = headerHeight + topbarHeight;
           sidebar.style.top = `${totalHeaderHeight}px`;
           sidebar.style.height = `calc(100% - ${totalHeaderHeight}px)`;
        }

        function buildPalette() {
            questionPalette.innerHTML = '';
            questions.forEach((q, index) => {
                const btn = document.createElement('div');
                btn.className = 'question-number';
                btn.textContent = index + 1;
                btn.dataset.index = index;
                btn.onclick = () => jumpToQuestion(index);
                questionPalette.appendChild(btn);
            });
            updatePalette(); // Initial palette coloring
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            state.current = index;
            state.visited[index] = true;
            
            const q = questions[index];
            if (!q) return;

            // Generate options HTML
            const optionsHTML = q.options.map((option, i) => {
                const optionLetter = String.fromCharCode(97 + i); // a, b, c, d
                const isSelected = state.answers[index] === optionLetter;
                
                return `
                    <li class="option ${isSelected ? 'selected' : ''}" data-option="${optionLetter}">
                        <span class="option-radio"></span>
                        <span class="option-text">${option}</span>
                    </li>
                `;
            }).join('');

            // Generate main question HTML
            questionNumber.textContent = `Question ${index + 1} of ${questions.length}`;
            questionText.innerHTML = q.question; // Use innerHTML to render any HTML in question
            optionsList.innerHTML = optionsHTML;
            
            // Add click listeners to new options
            optionsList.querySelectorAll('.option').forEach(opt => {
                opt.addEventListener('click', () => selectOption(opt.dataset.option));
            });
            
            btnSubmitTest.style.display = (index === questions.length - 1) ? 'flex' : 'none';
            btnPrevQuestion.disabled = (index === 0);
            btnSaveNext.querySelector('span').textContent = (index === questions.length - 1) ? "Save & Finish" : "Save & Next";

            updatePalette();
        }

        function selectOption(optionLetter) {
            state.answers[currentQuestionIndex] = optionLetter;
            
            // Update userAnswers (for session resume)
            const qid = questions[currentQuestionIndex].id;
            if (!userAnswers[qid]) userAnswers[qid] = {};
            userAnswers[qid].answer = optionLetter;
            userAnswers[qid].status = 'answered';

            // Redraw options to show selection
            displayQuestion(currentQuestionIndex);
        }

        function saveAndNext() {
            // Update status (for palette)
            const qid = questions[currentQuestionIndex].id;
            if (!userAnswers[qid]) {
                 userAnswers[qid] = { status: 'not-answered' };
            } else if (userAnswers[qid].status !== 'review') {
                 userAnswers[qid].status = userAnswers[qid].answer ? 'answered' : 'not-answered';
            }
            
            updatePalette();
            updateSession(); // Save progress
            
            if (currentQuestionIndex < questions.length - 1) {
                displayQuestion(currentQuestionIndex + 1);
            } else {
                confirmSubmit(false); // At last question, Save & Next is Submit
            }
        }

        function markForReview() {
            const qid = questions[currentQuestionIndex].id;
            state.marked[currentQuestionIndex] = !state.marked[currentQuestionIndex]; // Toggle mark

            if (!userAnswers[qid]) userAnswers[qid] = {};
            
            // Set status for review
            if(state.marked[currentQuestionIndex]) {
                userAnswers[qid].status = 'review';
            } else {
                // Unmarking, set back to answered or not-answered
                userAnswers[qid].status = userAnswers[qid].answer ? 'answered' : 'not-answered';
            }
            
            updatePalette();
            updateSession();
        }
        
        function clearResponse() {
            state.answers[currentQuestionIndex] = null;
            
            const qid = questions[currentQuestionIndex].id;
            if (userAnswers[qid]) {
                delete userAnswers[qid].answer;
                userAnswers[qid].status = state.marked[currentQuestionIndex] ? 'review' : 'not-answered';
            }
            
            displayQuestion(currentQuestionIndex); // Redraw to remove selection
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        }
        
        function jumpToQuestion(index) {
            displayQuestion(index);
        }

        function updatePalette() {
            let answeredCount = 0;
            let notAnsweredCount = 0;
            let markedCount = 0;
            let notVisitedCount = 0;
            
            questionPalette.querySelectorAll('.question-number').forEach((btn, index) => {
                const isAnswered = state.answers[index] !== null;
                const isMarked = state.marked[index];
                const isVisited = state.visited[index];

                btn.className = 'question-number'; // Reset

                if (isAnswered && isMarked) {
                    btn.classList.add('marked-answered');
                    answeredCount++;
                    markedCount++;
                } else if (isAnswered) {
                    btn.classList.add('answered');
                    answeredCount++;
                } else if (isMarked) {
                    btn.classList.add('marked');
                    markedCount++;
                    notAnsweredCount++; // Marked but unanswered
                } else if (isVisited) {
                    btn.classList.add('not-answered');
                    notAnsweredCount++;
                } else {
                    btn.classList.add('not-visited');
                    notVisitedCount++;
                }
                
                if (index === currentQuestionIndex) {
                    btn.classList.add('current');
                }
            });

            // Update sidebar summary
            summaryAnswered.textContent = answeredCount;
            summaryNotAnswered.textContent = notAnsweredCount;
            summaryMarked.textContent = markedCount;
            summaryNotVisited.textContent = notVisitedCount;
        }

        async function updateSession() {
            if (!testSessionId) return;

            const sessionData = {
                userAnswers: userAnswers,
                currentQuestionIndex: currentQuestionIndex,
            };

            if (!currentTest.duration) {
                sessionData.stopwatchTime = stopwatchTime;
            }

            try {
                await firestore.collection('testSessions').doc(testSessionId).update(sessionData);
            } catch (error) {
                console.warn("Could not update session: ", error.message);
            }
        }

        // --- Submission and Results (Adapted for new UI) ---
        function confirmSubmit() {
            const answered = state.answers.filter(a => a !== null).length;
            const notAnswered = state.visited.filter((v, i) => v && state.answers[i] === null).length;
            const marked = state.marked.filter(m => m).length;

            if (confirm(`Are you sure you want to submit?\n\nAnswered: ${answered}\nNot Answered: ${notAnswered}\nMarked for Review: ${marked}\n\n(Answers marked for review WILL be evaluated)`)) {
                submitExam(false);
            }
        }

        async function submitExam(isAutoSubmit) {
            if (testSessionId === null && !isAutoSubmit) return; // Prevent double submit
            
            if (isAutoSubmit) {
                alert('Time is up! Your test is being submitted automatically.');
            }
            
            showLoader(true, 'Calculating results...');
            preExamScreen.style.display = 'flex';
            preExamScreen.style.alignItems = 'center';
            submittingScreen.style.display = 'block';
            loginScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            chapterSelectionWrapper.style.display = 'none';
            examUIWrapper.style.display = 'none';
            document.body.classList.remove('exam-active');
            
            if (timerInterval) clearInterval(timerInterval);
            
            // Remove online listener
            window.removeEventListener('online', forceSubmitOnReconnect);

            // --- 1. Calculate Score ---
            let score = 0;
            let correct = 0;
            let incorrect = 0;
            let unattempted = 0;
            const marksPerQ = currentTest.marksPerQuestion;
            const negativeMarks = currentTest.negativeMarks;
            const totalPossibleScoreNum = questions.length * marksPerQ;
            
            // Use 'state.answers' for calculation
            state.answers.forEach((ans, index) => {
                const correctAnswerLetter = questions[index].answer; // 'a', 'b', 'c'
                const qid = questions[index].id;
                
                if (ans === null) {
                    unattempted++;
                    if(userAnswers[qid]) userAnswers[qid].status = 'not-answered';
                } else if (ans === correctAnswerLetter) {
                    correct++;
                    score += marksPerQ;
                    if(userAnswers[qid]) userAnswers[qid].status = 'correct';
                } else {
                    incorrect++;
                    score -= negativeMarks;
                    if(userAnswers[qid]) userAnswers[qid].status = 'incorrect';
                }
            });

            // --- 2. Save Result to Firestore ---
            const testResultId = `tr_${currentUser.uid}_${currentTest.id}_${testStartTime.getTime()}`;
            try {
                await firestore.collection('testResults').doc(testResultId).set({
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    testId: currentTest.id,
                    testTitle: currentTest.title,
                    submissionTime: firebase.firestore.Timestamp.now(),
                    startTime: firebase.firestore.Timestamp.fromDate(testStartTime),
                    score: score,
                    totalScore: totalPossibleScoreNum,
                    correct: correct,
                    incorrect: incorrect,
                    unattempted: unattempted,
                    totalQuestions: questions.length,
                    userAnswers: userAnswers, // Save the detailed object
                    marksPerQuestion: marksPerQ,
                    negativeMarks: negativeMarks
                });

                // --- 3. Delete In-Progress Session ---
                if (testSessionId) {
                    await firestore.collection('testSessions').doc(testSessionId).delete();
                }
                
                testSessionId = null; // Prevent resubmit

                // --- 4. Display Results ---
                showLoader(false);
                submittingScreen.style.display = 'none';
                examUIWrapper.style.display = 'flex'; // Show main wrapper
                document.querySelector('#mockTestWrapper').style.display = 'none'; // Hide test area
                sidebar.style.display = 'none';
                mcqFooter.style.display = 'none';
                
                resultScreenWrapper.style.display = 'flex'; // Show result screen
                document.body.classList.add('exam-active');
                
                displayResults(score, correct, incorrect, unattempted, totalPossibleScoreNum);

            } catch (error) {
                console.error("Error submitting test: ", error);
                showLoader(false);
                submittingScreen.innerHTML = `<h2>Error</h2><p>There was an error submitting your test: ${error.message}</p><p>Please take a screenshot of your screen and contact support.</p>`;
            }
        }
        
        function displayResults(score, correct, incorrect, unattempted, totalScore) {
            resultScreenTitle.textContent = `Test Completed: ${currentTest.title}`;
            totalPossibleScore.textContent = totalScore;

            const scoreBreakdown = {
                correctCount: correct,
                incorrectCount: incorrect,
                unattemptedCount: unattempted,
                correctMarks: correct * currentTest.marksPerQuestion,
                incorrectMarks: incorrect * currentTest.negativeMarks * -1, // Show as negative
                totalScore: score,
                totalQuestions: questions.length // Add this for scorecard
            };
            
            animateScorecard(scoreBreakdown);
            renderAnswerReview();
        }

        function animateScorecard(data) {
           let current = { correctCount: 0, incorrectCount: 0, unattemptedCount: 0, correctMarks: 0, incorrectMarks: 0, totalScore: 0 };
           const animationSpeed = 20;
           const duration = 1200;
           const steps = duration / animationSpeed;
           const stepValues = {};
           for (const key in current) {
               if(data[key] === undefined) data[key] = 0;
               stepValues[key] = (data[key] - current[key]) / steps;
           }
           clearInterval(animationInterval);
           animationInterval = setInterval(() => {
               let finished = true;
               for (const key in current) {
                   if (Math.abs(current[key] - data[key]) > Math.abs(stepValues[key])) {
                       current[key] += stepValues[key];
                       finished = false;
                   } else {
                       current[key] = data[key];
                   }
               }
               correctCount.textContent = Math.round(current.correctCount);
               correctMarks.textContent = `${Math.round(current.correctMarks) > 0 ? '+' : ''}${Math.round(current.correctMarks)}`;
               incorrectCount.textContent = Math.round(current.incorrectCount);
               incorrectMarks.textContent = Math.round(current.incorrectMarks);
               unattemptedCount.textContent = Math.round(current.unattemptedCount);
               finalScoreAnimated.textContent = Math.round(current.totalScore);
               if(finished) clearInterval(animationInterval);
           }, animationSpeed);
        }
        
        function renderAnswerReview() {
            reviewContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const correctAnswerLetter = q.answer; // 'a', 'b', 'c'
                const userAnswerLetter = state.answers[index]; // 'a', 'b', null
                
                let reviewClass = '';
                let statusText = '';
                if (userAnswerLetter === null) {
                    reviewClass = 'unanswered';
                    statusText = 'Unanswered';
                } else if (userAnswerLetter === correctAnswerLetter) {
                    reviewClass = 'correct';
                    statusText = 'Correct';
                } else {
                    reviewClass = 'incorrect';
                    statusText = 'Incorrect';
                }
                
                const optionsHTML = q.options.map((option, i) => {
                    const optionLetter = String.fromCharCode(97 + i);
                    let liClass = 'review-option';
                    let icon = '<i class="far fa-circle"></i>';
                    
                    if (optionLetter === correctAnswerLetter) {
                        liClass += ' review-correct';
                        icon = '<i class="fas fa-check-circle"></i>';
                    }
                    if (optionLetter === userAnswerLetter && userAnswerLetter !== correctAnswerLetter) {
                        liClass += ' review-incorrect';
                        icon = '<i class="fas fa-times-circle"></i>';
                    }
                    
                    return `<li class="${liClass}">${icon} ${option}</li>`;
                }).join('');
                
                const explanationHTML = q.explanation ? `
                    <div class="review-explanation">
                        <strong>Explanation:</strong>
                        <div>${q.explanation}</div>
                    </div>
                ` : '';

                const questionElement = document.createElement('div');
                questionElement.className = `review-question`;
                questionElement.innerHTML = `
                    <h4 class="review-q-text" style="font-weight: 600; margin-bottom: 15px;">Q ${index + 1}: ${q.question}</h4>
                    <ul class="review-option-list">
                        ${optionsHTML}
                    </ul>
                    <div class="review-status ${reviewClass}">${statusText}</div>
                    ${explanationHTML}
                `;
                reviewContainer.appendChild(questionElement);
            });
        }
        
        async function handleRetest() {
            // This is an online-only test, so we don't need to check for aeroplane mode
            // We just need to check the password and internet connection to delete the old session
            
            if (!navigator.onLine) {
                 passwordError.textContent = 'Please connect to the internet to retest.';
                 return;
            }
            if (passwordRetestInput.value !== RETEST_PASSWORD) {
                 passwordError.textContent = 'Incorrect password.';
                 return;
            }
            
            passwordError.textContent = '';
            showLoader(true, 'Clearing previous session...');
            
            try {
                // Find all previous results for THIS test and user
                const querySnapshot = await firestore.collection('testResults')
                    .where('userId', '==', currentUser.uid)
                    .where('testId', '==', mainTestId)
                    .get();

                const batch = firestore.batch();
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                console.log('Previous results cleared.');
                
                // Now reload the page to start fresh
                window.location.reload();
                
            } catch (error) {
                console.error('Error clearing results:', error);
                passwordError.textContent = 'Could not clear old results. Please try again.';
                showLoader(false);
            }
        }
        
        function toggleDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark');
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.remove('dark');
                document.body.classList.add('light-mode');
            }
            toggleLabel.textContent = isDark ? 'Light' : 'Dark';
        }

    </script>
</body>
</html>
