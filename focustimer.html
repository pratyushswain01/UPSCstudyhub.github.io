<script>
    let timer = 0; // time in seconds
    let interval;
    let isRunning = false;
    let startTime = 0; // Store the timestamp when the timer is started

    // Check if there's a saved timer value in localStorage
    if (localStorage.getItem('timer')) {
        timer = parseInt(localStorage.getItem('timer'));
        updateTimerDisplay();
    }

    // Check and update attendance status and streak
    const attendanceStatus = document.getElementById('attendanceStatus');
    const markPresentButton = document.getElementById('markPresentButton');
    const markAbsentButton = document.getElementById('markAbsentButton');
    const streakDisplay = document.getElementById('streakDisplay');

    // Retrieve saved streak and timer data from localStorage
    let streak = localStorage.getItem('streak') || 0;
    let lastAttendance = localStorage.getItem('lastAttendanceDate') || '';
    let lastStreakUpdate = localStorage.getItem('lastStreakUpdate') || '';

    // Update the streak display
    streakDisplay.textContent = `Current Streak: ${streak} days`;

    if (localStorage.getItem('attendance')) {
        const attendance = localStorage.getItem('attendance');
        if (attendance === 'present') {
            attendanceStatus.textContent = "You are marked as Present today.";
            markPresentButton.disabled = true;
            markAbsentButton.disabled = true;
        } else if (attendance === 'absent') {
            attendanceStatus.textContent = "You are marked as Absent today.";
            markPresentButton.disabled = true;
            markAbsentButton.disabled = true;
        }
    }

    // Mark as present
    markPresentButton.addEventListener('click', () => {
        const today = new Date().toLocaleDateString();
        if (lastAttendance !== today) {
            streak = 0; // Reset streak on a new day
        }

        localStorage.setItem('attendance', 'present');
        localStorage.setItem('lastAttendanceDate', today);
        checkAndUpdateStreak();

        attendanceStatus.textContent = "You are marked as Present today.";
        markPresentButton.disabled = true;
        markAbsentButton.disabled = true;
        streakDisplay.textContent = `Current Streak: ${streak} days`;
    });

    // Mark as absent
    markAbsentButton.addEventListener('click', () => {
        const today = new Date().toLocaleDateString();
        localStorage.setItem('attendance', 'absent');
        localStorage.setItem('lastAttendanceDate', today);
        streak = 0; // Reset streak on absence
        localStorage.setItem('streak', streak);

        attendanceStatus.textContent = "You are marked as Absent today.";
        markPresentButton.disabled = true;
        markAbsentButton.disabled = true;
        streakDisplay.textContent = `Current Streak: 0 days`;
    });

    // Check if timer exceeds 3 hours, then increase streak
    function checkAndUpdateStreak() {
        const currentTime = timer / 3600; // Convert seconds to hours
        if (currentTime >= 3) {
            if (lastStreakUpdate !== new Date().toLocaleDateString()) {
                streak++;
                localStorage.setItem('streak', streak);
                localStorage.setItem('lastStreakUpdate', new Date().toLocaleDateString());
                streakDisplay.textContent = `Current Streak: ${streak} days`;
            }
        }
    }

    function startTimer() {
        isRunning = true;
        document.getElementById('startButton').disabled = true;
        document.getElementById('pauseButton').disabled = false;

        startTime = Date.now(); // Save the start time (timestamp)
        localStorage.setItem('startTime', startTime); // Store start time in localStorage

        interval = setInterval(() => {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000); // Calculate time passed since start
            timer = elapsedTime + (parseInt(localStorage.getItem('timer')) || 0); // Add time passed since last session
            localStorage.setItem('timer', timer); // Save the timer value
            updateTimerDisplay();
            checkAndUpdateStreak(); // Check if streak should increase based on timer
        }, 1000);
    }

    function pauseTimer() {
        isRunning = false;
        document.getElementById('startButton').disabled = false;
        document.getElementById('pauseButton').disabled = true;
        clearInterval(interval);
        localStorage.setItem('timer', timer); // Save current time when paused
        localStorage.removeItem('startTime'); // Remove start time when paused
    }

    function resetTimer() {
        timer = 0;
        localStorage.removeItem('timer');
        localStorage.removeItem('startTime');
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const hours = Math.floor(timer / 3600); // Calculate hours
        const minutes = Math.floor((timer % 3600) / 60); // Calculate minutes
        const seconds = timer % 60; // Calculate seconds
        document.getElementById('timer').textContent = 
            `${hours < 10 ? '0' : ''}${hours}:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    // Event listeners for buttons
    document.getElementById('startButton').addEventListener('click', startTimer);
    document.getElementById('pauseButton').addEventListener('click', pauseTimer);
    document.getElementById('resetButton').addEventListener('click', resetTimer);

    // Real-time clock update
    function updateClock() {
        const currentTime = new Date();
        const hours = currentTime.getHours();
        const minutes = currentTime.getMinutes();
        const seconds = currentTime.getSeconds();
        const dayOfWeek = currentTime.toLocaleString('en-us', { weekday: 'long' });
        const month = currentTime.toLocaleString('en-us', { month: 'long' });
        const date = currentTime.getDate();
        const year = currentTime.getFullYear();
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
        const displaySeconds = seconds < 10 ? '0' + seconds : seconds;

        const clockString = `${displayHours}:${displayMinutes}:${displaySeconds} ${period}`;
        const dateString = `${dayOfWeek}, ${month} ${date}, ${year}`;

        document.getElementById('clock').textContent = clockString;
        document.getElementById('dateDay').textContent = dateString;
    }

    // Update the clock every second
    setInterval(updateClock, 1000);

    // If the app is closed and reopened, check the saved start time and resume
    window.onload = function() {
        const savedStartTime = localStorage.getItem('startTime');
        if (savedStartTime) {
            startTime = parseInt(savedStartTime);
            startTimer(); // Restart the timer if it was running before
        }
    };
</script>
